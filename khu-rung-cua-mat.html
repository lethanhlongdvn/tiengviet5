<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khu rừng của Mát - EduRobot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
            font-size: 18px;
            line-height: 1.8;
        }

        /* Thụt đầu dòng cho văn xuôi */
        .serif-font p {
            text-indent: 2em;
            margin-bottom: 1rem;
            text-align: justify;
        }

        /* Riêng đoạn hội thoại không thụt đầu dòng quá sâu */
        .serif-font .dialogue {
            text-indent: 0;
            padding-left: 1em;
            font-style: italic;
            color: #4b5563;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-open .accordion-content {
            max-height: 800px;
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .bg-paper {
            background-color: #fdfcf7;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        /* Tab Styles */
        .tab-btn.active {
            border-bottom: 4px solid #1d4ed8;
            color: #1d4ed8;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
        }

        .quiz-option:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .quiz-option.selected {
            border-color: #2563eb;
            background-color: #dbeafe;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="index.html" class="flex items-center space-x-2">
                    <div
                        class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white text-lg font-bold">
                        E</div>
                    <span class="text-lg font-extrabold text-blue-600 tracking-tight">EduRobot - <span
                            class="text-yellow-500">Tiếng Việt 5</span></span>
                </a>
            </div>

            <ul class="hidden md:flex space-x-6 font-semibold text-gray-600 text-sm">
                <li><a href="ve-dep-cuoc-song.html"
                        class="hover:text-blue-600 transition-colors font-bold text-blue-700 border-b-2 border-blue-600">Bài
                        học</a></li>
                <li><a href="#" onclick="openTeacherStats()" class="hover:text-blue-500 transition-colors">Thống kê</a>
                </li>
                <li><a href="#" class="hover:text-blue-500 transition-colors">Liên hệ</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-4">

        <!-- Navigation -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4">
            <div>
                <a href="ve-dep-cuoc-song.html?week=20"
                    class="flex items-center text-gray-600 hover:text-blue-600 font-bold transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Quay lại Tuần 22
                </a>
            </div>

            <!-- Audio Player -->
            <div class="flex items-center space-x-4 bg-white rounded-full p-2 pr-6 shadow-sm border border-blue-100">
                <button id="audioControl" onclick="toggleAudio()"
                    class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">
                    <svg id="playIcon" class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M6 4l10 6-10 6V4z"></path>
                    </svg>
                    <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div>
                    <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Nghe đọc mẫu</p>
                    <p id="audioStatus" class="text-xs text-gray-400 font-bold italic">Đang dừng...</p>
                </div>
                <audio id="lessonAudio">
                    <source src="am_thanh/khu-rung-cua-mat.mp3" type="audio/mpeg">
                </audio>
            </div>
        </div>

        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-2xl overflow-hidden shadow-sm">
            <button onclick="switchTab('lesson')" id="btn-lesson"
                class="tab-btn active flex-1 py-4 text-center font-bold text-gray-500 transition-all hover:bg-blue-50">
                1. Câu chuyện
            </button>
            <button onclick="switchTab('quiz')" id="btn-quiz"
                class="tab-btn flex-1 py-4 text-center font-bold text-gray-500 transition-all hover:bg-blue-50">
                2. Luyện tập
            </button>
        </div>

        <div id="tab-lesson" class="tab-content active">
            <div class="flex flex-col lg:flex-row gap-8">

                <section class="w-full lg:w-[70%] text-center">
                    <div class="bg-white rounded-[30px] shadow-sm border border-gray-100 p-2 md:p-3">

                        <div
                            class="mb-6 overflow-hidden rounded-2xl shadow-sm relative group w-full h-56 md:h-72 bg-blue-100">
                            <svg class="absolute inset-0 w-full h-full" preserveAspectRatio="none">
                                <defs>
                                    <linearGradient id="forestSky" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:#bae6fd;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#f0f9ff;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#forestSky)" />
                                <circle cx="85%" cy="15%" r="40" fill="#fde047" fill-opacity="0.8" />
                            </svg>

                            <div class="absolute bottom-0 w-full h-2/3">
                                <svg class="w-full h-full" preserveAspectRatio="none" viewBox="0 0 1200 600">
                                    <path d="M0,600 L0,300 C300,200 600,400 1200,250 L1200,600 Z" fill="#4ade80" />
                                    <path d="M0,600 L0,450 C400,350 800,550 1200,400 L1200,600 Z" fill="#22c55e" />
                                </svg>
                            </div>

                            <div
                                class="absolute bottom-0 w-full h-full flex justify-around items-end pb-4 px-10 pointer-events-none">
                                <svg class="w-24 h-40 text-green-800 transform -translate-y-4" viewBox="0 0 100 100"
                                    fill="currentColor">
                                    <path d="M45,100 L55,100 L55,80 L45,80 Z" fill="#78350f" />
                                    <path d="M50,10 L90,80 L10,80 Z" />
                                </svg>
                                <svg class="w-32 h-56 text-green-700 z-10" viewBox="0 0 100 100" fill="currentColor">
                                    <path d="M45,100 L55,100 L55,80 L45,80 Z" fill="#78350f" />
                                    <path d="M50,20 L85,80 L15,80 Z" />
                                    <path d="M50,0 L80,50 L20,50 Z" opacity="0.9" />
                                </svg>
                                <svg class="w-20 h-32 text-green-600 transform translate-y-2" viewBox="0 0 100 100"
                                    fill="currentColor">
                                    <circle cx="50" cy="40" r="35" />
                                    <rect x="45" y="70" width="10" height="30" fill="#78350f" />
                                </svg>
                                <svg class="w-28 h-48 text-green-800 hidden md:block" viewBox="0 0 100 100"
                                    fill="currentColor">
                                    <path d="M45,100 L55,100 L55,80 L45,80 Z" fill="#78350f" />
                                    <path d="M50,10 L90,80 L10,80 Z" />
                                </svg>
                            </div>

                            <svg class="absolute bottom-4 right-16 md:right-24 w-28 h-28 z-20" viewBox="0 0 100 100"
                                fill="none">
                                <g transform="translate(10, 20)">
                                    <path d="M10,60 L0,75 L15,75 L20,60" fill="#92400e" />
                                    <path d="M25,60 L35,75 L20,75" fill="#92400e" />
                                    <rect x="10" y="35" width="25" height="25" rx="4" fill="#0ea5e9" />
                                    <circle cx="22.5" cy="30" r="9" fill="#fde68a" />
                                    <path d="M5,28 L40,28 L22.5,12 Z" fill="#d97706" />
                                    <rect x="30" y="40" width="18" height="7" fill="#fde68a" rx="2"
                                        transform="rotate(15 30 40)" />
                                </g>

                                <g transform="translate(50, 50)">
                                    <rect x="0" y="5" width="18" height="14" fill="#64748b" rx="2" />
                                    <path d="M18,8 L30,0 L28,-2 L18,5 Z" fill="#64748b" />
                                    <path d="M2,5 C-6,0 -6,18 2,12" stroke="#64748b" stroke-width="2.5" />
                                    <g fill="#3b82f6" opacity="0.8">
                                        <circle cx="32" cy="5" r="1.5" />
                                        <circle cx="35" cy="10" r="1.5" />
                                        <circle cx="30" cy="15" r="1.5" />
                                    </g>
                                </g>
                            </svg>
                        </div>

                        <div class="p-1 md:p-2 bg-paper flex flex-col items-center space-y-4">
                            <div class="serif-font text-gray-800 text-left w-full">
                                <h1 class="text-3xl font-black mb-6 text-blue-800 text-center uppercase tracking-tight">
                                    KHU RỪNG CỦA MÁT</h1>

                                <p>
                                    Mát sống với ông nội ở “Trang trại rừng” – một trang trại rộng lớn, nổi tiếng trong
                                    vùng. Đây là cơ nghiệp của tổ tiên để lại. Trang trại trồng nhiều loại cây, trong đó
                                    có
                                    những giống cây quý hiếm.
                                </p>

                                <p>
                                    Hằng ngày, Mát cùng ông chăm sóc rừng cây. Dưới sự chỉ dạy của ông, Mát nhớ được tên
                                    và
                                    đặc tính của nhiều loại cây. Năm Mát tròn mười tám tuổi, ông nội qua đời. Trước khi
                                    mất,
                                    ông gửi gắm trang trại cho Mát. Mát cũng hứa với ông sẽ bảo vệ trang trại thật tốt
                                    và
                                    gìn giữ hồi ức đẹp đã có cùng ông tại nơi này.
                                </p>

                                <p>
                                    Đáng tiếc, một đêm nọ, sấm chớp đùng đùng nổi lên. Một tia sét đánh trúng ngọn cây
                                    cao
                                    nhất trong trang trại. Cây bốc cháy, ngọn lửa mau chóng lan khắp rừng. Mọi người hô
                                    hào,
                                    cùng nhau dập lửa, nhưng đành bất lực trước ngọn lửa cao cả chục mét. Trang trại
                                    cháy
                                    suốt một ngày và một đêm mới dần tắt.
                                </p>

                                <p>
                                    Nhìn cảnh hoang tàn của trang trại, Mát đau xót và kiệt sức, ngất lịm đi. Mọi người
                                    vội
                                    đưa anh vào bệnh viện. Lúc tỉnh dậy, anh buồn bã và tuyệt vọng. Bà lão cạnh giường
                                    của
                                    Mát thấy vậy, liền hỏi:
                                </p>

                                <p class="dialogue">
                                    – Chàng trai trẻ, sao trông cậu ủ rũ vậy?
                                </p>
                                <p class="dialogue">
                                    – Cây cối trong trang trại nhà cháu bị cháy sạch rồi bà ạ! – Mát buồn rầu đáp.
                                </p>
                                <p class="dialogue">
                                    – Cây bị thiêu cháy thì trồng lại là được. Cậu còn trẻ mà!
                                </p>

                                <p>
                                    Nghe bà cụ nói, Mát bừng tỉnh.
                                </p>

                                <p>
                                    Xuất viện trở về, Mát thuê người đến, biến những thân cây bị đốt cháy thành than
                                    củi,
                                    đem bán để có tiền mua cây giống. Mát mua cây giống, trồng trong trang trại.
                                </p>

                                <p>
                                    Nhiều năm sau, trang trại lại được phủ một màu xanh mướt.
                                </p>

                                <p class="text-right italic font-bold text-gray-600 mt-6">(Theo Truyện đọc lớp 5)</p>
                            </div>
                        </div>
                    </div>
                </section>

                <aside class="w-full lg:w-[30%]">
                    <div class="bg-yellow-50 rounded-[30px] shadow-sm border border-yellow-100 p-4 sticky top-20">
                        <h2 class="text-xl font-black text-blue-900 mb-4 flex items-center">
                            <span class="w-10 h-10 bg-yellow-400 rounded-xl flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </span>
                            Tìm hiểu bài
                        </h2>

                        <div class="space-y-4">
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        1. Chuyện gì đã xảy ra với khu rừng của Mát?
                                    </span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-base text-gray-700 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1">Gợi ý:</span>
                                        <p>Một đêm nọ, <b>sấm sét đã đánh trúng ngọn cây cao nhất</b>, gây ra đám cháy
                                            lớn
                                            lan khắp rừng. Dù mọi người cố gắng dập lửa nhưng trang trại vẫn bị thiêu
                                            rụi,
                                            chỉ còn lại cảnh hoang tàn.</p>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        2. Lời khuyên của bà cụ giúp Mát nhận ra điều gì?
                                    </span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-base text-gray-700 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1">Gợi ý:</span>
                                        <p>Bà cụ nói: <i>“Cây bị thiêu cháy thì trồng lại là được. Cậu còn trẻ mà!”</i>.
                                        </p>
                                        <p class="mt-2">Lời khuyên giúp Mát bừng tỉnh vì:</p>
                                        <ul class="list-disc ml-4 mt-1">
                                            <li>Bà đã chỉ ra hướng giải quyết: <b>trồng lại cây mới</b>.</li>
                                            <li>Bà nhắc nhở Mát về lợi thế của mình: <b>tuổi trẻ, sức lực và thời
                                                    gian</b>
                                                để bắt đầu lại.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        3. Mát đã làm gì để khôi phục trang trại?
                                    </span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-base text-gray-700 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1">Gợi ý:</span>
                                        <p>Mát đã thể hiện sự thông minh và nỗ lực:</p>
                                        <ul class="list-disc ml-4 mt-1">
                                            <li>Biến đau thương thành hành động: Thuê người làm <b>than củi</b> từ
                                                những
                                                thân cây bị cháy đem bán.</li>
                                            <li>Dùng tiền bán than để <b>mua cây giống mới</b>.</li>
                                            <li>Kiên trì trồng và chăm sóc cho đến khi khu rừng xanh tốt trở lại.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        4. Qua câu chuyện, em thấy Mát là người thế nào?
                                    </span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-base text-gray-700 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1">Gợi ý:</span>
                                        <p>Mát là một người:</p>
                                        <ul class="list-disc ml-4 mt-1">
                                            <li><b>Hiếu thảo, trọng lời hứa:</b> Quyết tâm giữ gìn cơ nghiệp của ông.
                                            </li>
                                            <li><b>Yêu thiên nhiên:</b> Đau xót khi rừng bị cháy.</li>
                                            <li><b>Có ý chí, nghị lực:</b> Biết đứng dậy sau thất bại và tìm cách khắc
                                                phục
                                                khó khăn.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>

            <div
                class="mt-2 bg-white rounded-[30px] shadow-sm border border-blue-100 p-6 md:p-8 overflow-hidden relative">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-blue-50 rounded-full opacity-50"></div>
                <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                    <div
                        class="bg-blue-600 p-8 rounded-3xl text-white shadow-xl shadow-blue-200 shrink-0 text-center md:text-left">
                        <p class="text-xs font-bold uppercase tracking-widest opacity-80 mb-2">Thông điệp</p>
                        <h3 class="text-2xl font-black uppercase tracking-wider">Nội dung chính</h3>
                    </div>
                    <div class="flex-grow">
                        <p class="text-lg font-semibold leading-relaxed text-blue-900 mb-2">
                            Ý chí vươn lên và tình yêu thiên nhiên.
                        </p>
                        <p class="text-gray-600 leading-relaxed text-base">
                            Câu chuyện ca ngợi nghị lực của Mát. Dù gặp tai họa khủng khiếp, nhưng nhờ lời khuyên đúng
                            đắn
                            và sức trẻ, Mát đã không bỏ cuộc mà tìm cách khôi phục lại trang trại, giữ trọn lời hứa với
                            ông
                            nội.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Tab Content -->
        <div id="tab-quiz" class="tab-content">
            <div class="bg-white rounded-[30px] shadow-sm border border-gray-100 p-6 md:p-10 max-w-4xl mx-auto">
                <div id="quiz-registration">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-black text-blue-900 mb-2">THÔNG TIN HỌC SINH</h2>
                        <p class="text-gray-500">Vui lòng nhập thông tin để bắt đầu luyện tập: <b>Khu rừng của Mát</b>
                        </p>
                    </div>
                    <form id="regForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Họ và tên:</label>
                            <input type="text" id="studentName" required
                                class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all"
                                placeholder="Nhập đầy đủ họ tên của em">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Lớp:</label>
                                <select id="studentClass" required
                                    class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all">
                                    <option value="">-- Chọn lớp --</option>
                                    <option value="5/1">Lớp 5/1</option>
                                    <option value="5/2">Lớp 5/2</option>
                                    <option value="5/3">Lớp 5/3</option>
                                    <option value="5/4">Lớp 5/4</option>
                                    <option value="5/5">Lớp 5/5</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Trường:</label>
                                <div class="relative">
                                    <select id="schoolSelect" onchange="checkSchool(this)"
                                        class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all">
                                        <option value="Tiểu học Đỗ Văn Nại">Tiểu học Đỗ Văn Nại</option>
                                        <option value="other">Trường khác...</option>
                                    </select>
                                    <input type="text" id="otherSchool"
                                        class="hidden mt-4 w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all"
                                        placeholder="Nhập tên trường của em">
                                </div>
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-lg uppercase tracking-wider">
                            Bắt đầu làm bài
                        </button>
                    </form>
                </div>

                <div id="quiz-container" class="hidden">
                    <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <span id="questionNum"
                                class="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center font-black text-xl">1</span>
                            <div>
                                <p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Câu hỏi</p>
                                <p class="text-xs text-gray-400 font-bold" id="progressText">Đang thực hiện: 1/5</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Thời gian làm bài
                            </p>
                            <p id="timer" class="text-lg font-black text-blue-900">00:00</p>
                        </div>
                    </div>

                    <div id="questionArea" class="mb-8">
                        <h3 id="questionText" class="text-xl font-bold text-gray-800 mb-6 leading-relaxed"></h3>
                        <div id="optionsArea" class="grid grid-cols-1 gap-4"></div>
                    </div>

                    <div class="flex justify-end pt-6 border-t border-gray-100">
                        <button id="nextBtn" disabled
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 px-10 rounded-2xl shadow-lg transition-all active:scale-95 flex items-center">
                            Tiếp theo
                            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="quiz-results" class="hidden text-center py-12">
                    <div class="mb-8 relative inline-block">
                        <svg class="w-48 h-48 mx-auto" viewBox="0 0 36 36">
                            <path class="text-gray-100" stroke-width="3" fill="none"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path id="scoreCircle" class="text-green-500" stroke-width="3" stroke-dasharray="0, 100"
                                stroke-linecap="round" fill="none"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="scoreText" class="text-5xl font-black text-blue-900">0</span>
                            <span class="text-sm font-bold text-gray-400 uppercase">Điểm</span>
                        </div>
                    </div>
                    <h2 class="text-3xl font-black text-gray-800 mb-2" id="resultTitle">Hoàn thành!</h2>
                    <p class="text-gray-500 mb-10" id="resultMsg">Chúc mừng em đã hoàn thành bài luyện tập.</p>

                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="restartQuiz()"
                            class="bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-bold py-4 px-10 rounded-2xl transition-all active:scale-95">Làm
                            lại</button>
                        <button onclick="submitResults()"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-2xl shadow-lg transition-all active:scale-95">Nộp
                            bài</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Statistics Modal -->
        <div id="statsModal" class="modal">
            <div
                class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col m-4">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-blue-600 text-white">
                    <h2 class="text-2xl font-black">THỐNG KÊ KẾT QUẢ HỌC TẬP</h2>
                    <div class="flex items-center space-x-2">
                        <button onclick="exportToExcel()"
                            class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-xl flex items-center text-sm font-bold shadow-lg transition-all">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 1 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            Xuất Excel
                        </button>
                        <button onclick="closeModal()" class="hover:bg-blue-700 p-2 rounded-full transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-6 overflow-x-auto flex-1">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 uppercase text-xs font-bold tracking-widest">
                                <th class="p-4 border-b">STT</th>
                                <th class="p-4 border-b">Họ và tên</th>
                                <th class="p-4 border-b">Lớp</th>
                                <th class="p-4 border-b">Trường</th>
                                <th class="p-4 border-b text-center">Điểm số</th>
                                <th class="p-4 border-b text-center">Thời gian làm</th>
                                <th class="p-4 border-b text-right">Thời gian nộp</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-zinc-900 text-zinc-400 py-2 px-4 mt-2">
        <div class="container mx-auto text-center text-xs">
            <p>@ 2026 EduRobot - Phát triển bởi Lê Thành Long</p>
        </div>
    </footer>

    <script>
        function toggleAccordion(button) {
            const item = button.parentElement;
            const isOpen = item.classList.contains('accordion-open');
            document.querySelectorAll('.accordion-item').forEach(el => el.classList.remove('accordion-open'));
            if (!isOpen) {
                item.classList.add('accordion-open');
            }
        }

        const audio = document.getElementById('lessonAudio');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const audioStatus = document.getElementById('audioStatus');

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                audioStatus.innerText = "Đang phát...";
                audioStatus.classList.remove('text-gray-400');
                audioStatus.classList.add('text-green-500');
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.innerText = "Đang dừng...";
                audioStatus.classList.remove('text-green-500');
                audioStatus.classList.add('text-gray-400');
            }
        }

        audio.onended = function () {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.innerText = "Đang dừng...";
            audioStatus.classList.remove('text-green-500');
            audioStatus.classList.add('text-gray-400');
        };

        /* FIREBASE CONFIG */
        const firebaseConfig = {
            apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
            authDomain: "gamhoctap.firebaseapp.com",
            databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gamhoctap",
            storageBucket: "gamhoctap.firebasestorage.app",
            messagingSenderId: "833329613932",
            appId: "1:833329613932:web:0d8574827bcfe50b535c49",
            measurementId: "G-YT1PKCYS67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        /* TEACHER STATS LOGIC */
        function openTeacherStats() {
            const pin = prompt("Vui lòng nhập mã PIN giáo viên:");
            if (pin === 'dvn') {
                document.getElementById('statsModal').classList.add('active');
                loadStats();
            } else if (pin !== null) {
                alert("Mã PIN không chính xác!");
            }
        }

        function closeModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">Đang tải dữ liệu...</td></tr>';
            try {
                const snapshot = await db.collection("diem_tieng_viet_lop5")
                    .where("lessonTitle", "==", "Khu rừng của Mát")
                    .get();
                tbody.innerHTML = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">Chưa có dữ liệu học tập.</td></tr>';
                    return;
                }
                const results = [];
                snapshot.forEach(doc => results.push(doc.data()));
                results.sort((a, b) => (b.submittedAt?.seconds || 0) - (a.submittedAt?.seconds || 0));
                results.forEach((data, index) => {
                    const date = data.submittedAt ? data.submittedAt.toDate().toLocaleString('vi-VN') : '---';
                    let duration = '---';
                    if (data.startTime && data.endTime) {
                        const start = new Date(data.startTime);
                        const end = new Date(data.endTime);
                        const diffMs = end - start;
                        const mins = Math.floor(diffMs / 60000);
                        const secs = Math.floor((diffMs % 60000) / 1000);
                        duration = `${mins} phút ${secs} giây`;
                    }
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 transition-colors border-b border-gray-50";
                    tr.innerHTML = `
                    <td class="p-4 font-bold text-gray-400">${index + 1}</td>
                    <td class="p-4 font-bold text-gray-800">${data.studentName}</td>
                    <td class="p-4 text-gray-600">${data.className}</td>
                    <td class="p-4 text-gray-600">${data.school}</td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full font-black ${data.score >= 80 ? 'bg-green-100 text-green-700' : data.score >= 50 ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}">
                            ${Math.round(data.score)}/100
                        </span>
                    </td>
                    <td class="p-4 text-center text-gray-600 font-bold">${duration}</td>
                    <td class="p-4 text-right text-xs text-gray-400 font-bold">${date}</td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Error loading stats:", error);
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500">Lỗi khi tải dữ liệu.</td></tr>';
            }
        }

        function exportToExcel() {
            const table = document.querySelector("#statsModal table");
            const wb = XLSX.utils.table_to_book(table, { sheet: "Kết quả", raw: true });
            XLSX.writeFile(wb, "ThongKe_GiaoVien_EduRobot.xlsx");
        }

        /* TAB LOGIC */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-blue-600'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('btn-' + tabId).classList.add('active', 'text-blue-600');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        /* REGISTRATION LOGIC */
        const otherSchoolInput = document.getElementById('otherSchool');
        function checkSchool(select) {
            if (select.value === 'other') {
                otherSchoolInput.classList.remove('hidden');
                otherSchoolInput.required = true;
            } else {
                otherSchoolInput.classList.add('hidden');
                otherSchoolInput.required = false;
            }
        }
        let studentData = {};
        document.getElementById('regForm').onsubmit = function (e) {
            e.preventDefault();
            studentData = {
                name: document.getElementById('studentName').value,
                className: document.getElementById('studentClass').value,
                school: document.getElementById('schoolSelect').value === 'other' ? document.getElementById('otherSchool').value :
                    document.getElementById('schoolSelect').value,
                startTime: new Date().toISOString()
            };
            document.getElementById('quiz-registration').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            startQuiz();
        };

        /* QUIZ ENGINE */
        const allQuestions = [
            { q: "Mát sống cùng với ai và ở đâu?", a: ["Sống với bố mẹ ở thành phố", "Sống với ông nội ở \"Trang trại rừng\"", "Sống một mình trong rừng sâu", "Sống với bà lão ở ven biển"], c: 1 },
            { q: "\"Trang trại rừng\" nơi Mát sống có nguồn gốc như thế nào?", a: ["Do Mát tự khai phá", "Do ông nội mới mua được", "Là cơ nghiệp của tổ tiên để lại, nổi tiếng trong vùng", "Là đất thuê của nhà nước"], c: 2 },
            { q: "Ông nội đã dạy cho Mát những kiến thức gì khi chăm sóc rừng cây?", a: ["Cách săn bắt thú rừng", "Cách chặt cây lấy gỗ", "Tên và đặc tính của nhiều loại cây", "Cách dự báo thời tiết"], c: 2 },
            { q: "Trước khi qua đời, ông nội đã gửi gắm điều gì cho Mát?", a: ["Hãy bán trang trại để lên thành phố sống", "Bảo vệ trang trại thật tốt và gìn giữ hồi ức đẹp đã có cùng ông", "Hãy chặt hết cây cổ thụ để bán", "Hãy tìm một công việc mới tốt hơn"], c: 1 },
            { q: "Nguyên nhân nào đã gây ra vụ cháy lớn tại trang trại?", a: ["Do người dân đốt nương làm rẫy", "Do một tia sét đánh trúng ngọn cây cao nhất trong đêm mưa bão", "Do Mát sơ ý làm đổ đèn dầu", "Do nắng nóng kéo dài gây cháy rừng"], c: 1 },
            { q: "Mức độ thiệt hại của vụ cháy được miêu tả như thế nào?", a: ["Chỉ cháy một góc nhỏ của khu rừng", "Đám cháy được dập tắt ngay lập tức", "Trang trại cháy suốt một ngày và một đêm, cây cối bị thiêu rụi, cảnh vật hoang tàn", "Không có thiệt hại gì đáng kể"], c: 2 },
            { q: "Sau khi trang trại bị cháy rụi, tâm trạng của Mát như thế nào?", a: ["Bình tĩnh và lạc quan", "Tức giận và muốn tìm người chịu trách nhiệm", "Đau xót, kiệt sức, buồn bã và tuyệt vọng", "Thờ ơ vì không quan tâm"], c: 2 },
            { q: "Ai là người đã đưa ra lời khuyên giúp Mát bừng tỉnh trong bệnh viện?", a: ["Bác sĩ điều trị", "Ông nội hiện về trong mơ", "Một bà lão nằm giường bên cạnh", "Một người bạn thân của Mát"], c: 2 },
            { q: "Câu nói nào của bà lão đã trở thành động lực cho Mát?", a: ["\"Cáu hãy bán mảnh đất đó đi.\"", "\"Cây bị thiêu cháy thì trồng lại là được. Cậu còn trẻ mà!\"", "\"Chuyện đã rồi, hãy quên nó đi.\"", "\"Cậu nên chuyển nghề khác cho đỡ vất vả.\""], c: 1 },
            { q: "Theo nội dung tìm hiểu bài, vì sao lời khuyên của bà lão lại có tác động lớn đến Mát?", a: ["Vì bà lão hứa sẽ cho Mát tiền", "Vì bà đã chỉ ra hướng giải quyết (trồng lại) và nhắc nhở Mát về sức mạnh của tuổi trẻ", "Vì bà lão là người quen cũ của ông nội", "Vì Mát sợ bà lão buồn"], c: 1 },
            { q: "Mát đã nảy ra ý tưởng gì để kiếm vốn khôi phục lại trang trại?", a: ["Vay tiền ngân hàng", "Kêu gọi mọi người quyên góp", "Biến những thân cây bị đốt cháy thành than củi đem bán", "Bán bớt một phần đất đai"], c: 2 },
            { q: "Hành động biến thân cây cháy thành than củi để mua cây giống thể hiện phẩm chất gì của Mát?", a: ["Sự thông minh, sáng tạo và biết tận dụng cơ hội trong khó khăn", "Sự liều lĩnh và mạo hiểm", "Sự tham lam muốn kiếm tiền nhanh", "Sự lãng phí tài nguyên"], c: 0 },
            { q: "Kết quả sau nhiều năm nỗ lực của Mát là gì?", a: ["Trang trại vẫn chỉ là vùng đất trống", "Mát bỏ cuộc và chuyển đi nơi khác", "Trang trại lại được phủ một màu xanh mướt", "Mát bán trang trại cho người khác"], c: 2 },
            { q: "Vì sao mọi người gọi trang trại là \"Rừng của Mát\"?", a: ["Để phân biệt với rừng của người khác", "Thể hiện niềm khâm phục đối với cậu chủ mới đã hồi sinh khu rừng", "Vì Mát là người duy nhất sống ở đó", "Vì tên khu rừng vốn dĩ là như vậy"], c: 1 },
            { q: "Câu chuyện muốn gửi gắm thông điệp ý nghĩa nào đến người đọc?", a: ["Cần phải biết cách phòng cháy chữa cháy rừng", "Tuổi trẻ cần phải đi xa để lập nghiệp", "Nếu có ý chí, nghị lực vượt qua thất bại và khó khăn, chúng ta sẽ gặt hái được thành công", "Cần phải giữ gìn tài sản của tổ tiên bằng mọi giá"], c: 2 }
        ];

        let currentQuizQuestions = [];
        let currentQuestionIdx = 0;
        let score = 0;
        let selectedOption = null;
        let lastUsedQuestions = [];

        function startQuiz() {
            let available = [...allQuestions];
            available.sort(() => Math.random() - 0.5);

            if (lastUsedQuestions.length > 0) {
                let fresh = available.filter(q => !lastUsedQuestions.includes(q.q));
                let repeated = available.filter(q => lastUsedQuestions.includes(q.q));
                currentQuizQuestions = fresh.slice(0, 5);
                if (currentQuizQuestions.length < 5) {
                    currentQuizQuestions = currentQuizQuestions.concat(repeated.slice(0, 5 - currentQuizQuestions.length));
                }
            } else {
                currentQuizQuestions = available.slice(0, 5);
            }

            lastUsedQuestions = currentQuizQuestions.map(q => q.q);
            currentQuestionIdx = 0;
            score = 0;
            showQuestion();
        }

        function showQuestion() {
            const q = currentQuizQuestions[currentQuestionIdx];
            document.getElementById('questionNum').innerText = currentQuestionIdx + 1;
            document.getElementById('progressText').innerText = `Đang thực hiện: ${currentQuestionIdx + 1}/5`;
            document.getElementById('questionText').innerText = q.q;
            const optionsArea = document.getElementById('optionsArea');
            optionsArea.innerHTML = '';
            q.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option w-full p-4 rounded-2xl text-left font-bold text-gray-700 flex items-center group';
                btn.innerHTML = `<span class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-4 group-hover:bg-blue-100">${String.fromCharCode(65 + idx)}</span><span class="flex-1">${opt}</span>`;
                btn.onclick = () => selectOption(idx, btn);
                optionsArea.appendChild(btn);
            });
            document.getElementById('nextBtn').disabled = true;
            selectedOption = null;
        }

        function selectOption(idx, btn) {
            document.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected', 'border-blue-500'));
            btn.classList.add('selected', 'border-blue-500');
            selectedOption = idx;
            document.getElementById('nextBtn').disabled = false;
        }

        document.getElementById('nextBtn').onclick = function () {
            if (selectedOption === currentQuizQuestions[currentQuestionIdx].c) {
                score += 20;
            }
            currentQuestionIdx++;
            if (currentQuestionIdx < 5) {
                showQuestion();
            } else {
                showResults();
            }
        };

        function showResults() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('scoreText').innerText = Math.round(score);
            const circle = document.getElementById('scoreCircle');
            circle.setAttribute('stroke-dasharray', `${Math.round(score)}, 100`);
            if (score >= 80) {
                document.getElementById('resultTitle').innerText = "Xuất sắc!";
                document.getElementById('resultMsg').innerText = "Em rất hiểu nội dung bài học. Phát huy nhé!";
            } else if (score >= 50) {
                document.getElementById('resultTitle').innerText = "Rất tốt!";
                document.getElementById('resultMsg').innerText = "Em đã cảm nhận được ý nghĩa của câu chuyện.";
            } else {
                document.getElementById('resultTitle').innerText = "Cố gắng lên!";
                document.getElementById('resultMsg').innerText = "Em nên đọc lại bài và thử lại lần nữa nhé.";
            }
        }

        function restartQuiz() {
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            startQuiz();
        }

        async function submitResults() {
            const finalData = {
                studentName: studentData.name,
                className: studentData.className,
                school: studentData.school,
                lessonTitle: "Khu rừng của Mát",
                score: Math.round(score),
                startTime: studentData.startTime,
                endTime: new Date().toISOString(),
                submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            const btn = event.target;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Đang gửi...";
            try {
                await db.collection("diem_tieng_viet_lop5").add(finalData);
                alert(`Chúc mừng em ${studentData.name}!\nKết quả của em đã được gửi thành công.\nĐiểm: ${Math.round(score)}/100`);
                switchTab('lesson');
            } catch (error) {
                console.error("Error submitting quiz:", error);
                alert("Lỗi khi nộp bài. Thử lại sau nhé!");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
    </script>
</body>

</html>