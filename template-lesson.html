<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tên Bài Học - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- SheetJS for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
        }

        .bg-paper {
            background-color: #fcfaf2;
        }

        .tab-btn.active {
            color: #2563eb;
            background-color: #eff6ff;
            border-bottom: 3px solid #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Accordion Custom */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .accordion-open .accordion-content {
            max-height: 800px;
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <span class="text-xl font-black">E</span>
                </div>
                <span class="text-xl font-black text-blue-600 hidden md:block">EduRobot - Tiếng Việt 5</span>
            </div>
            <ul class="flex space-x-6 text-sm font-bold text-gray-500">
                <li><a href="index.html" class="hover:text-blue-500 transition-colors">Trang chủ</a></li>
                <li><button onclick="openTeacherStats()" class="hover:text-blue-500 transition-colors">Dành cho Giáo
                        viên</button></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-4">
        <!-- Navigation -->
        <div class="flex items-center justify-between mb-2">
            <a href="ve-dep-cuoc-song.html"
                class="flex items-center text-gray-500 hover:text-blue-600 transition-colors text-sm font-bold">
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Trở về
            </a>
        </div>

        <!-- Tab & Audio Header -->
        <div
            class="flex flex-col md:flex-row md:items-center justify-between border-b border-gray-200 mb-4 bg-white rounded-t-2xl overflow-hidden shadow-sm">
            <div class="flex-1 flex">
                <button onclick="switchTab('lesson')" id="btn-lesson"
                    class="tab-btn active flex-1 py-3 text-center font-bold text-gray-500 transition-all hover:bg-blue-50 border-r border-gray-100">
                    1. Bài học
                </button>
                <button onclick="switchTab('quiz')" id="btn-quiz"
                    class="tab-btn flex-1 py-3 text-center font-bold text-gray-500 transition-all hover:bg-blue-50">
                    2. Luyện tập
                </button>
            </div>

            <div id="audio-container" class="p-2 md:pr-4">
                <div
                    class="flex items-center space-x-3 bg-blue-50/50 rounded-full p-1 pr-6 border border-blue-100 shadow-sm transition-all hover:bg-blue-50">
                    <button id="audioControl" onclick="toggleAudio()"
                        class="w-11 h-11 bg-blue-600 rounded-full flex items-center justify-center text-white hover:bg-blue-700 transition-all shadow-md active:scale-95">
                        <svg id="playIcon" class="w-5 h-5 ml-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col">
                        <p class="text-[11px] font-black text-blue-600 uppercase tracking-widest leading-none mb-1">
                            NGHE ĐỌC MẪU</p>
                        <p id="audioStatus" class="text-[12px] text-gray-400 font-bold italic leading-none">Đang dừng...
                        </p>
                    </div>
                </div>
                <audio id="lessonAudio">
                    <source src="am_thanh/lesson.mp3" type="audio/mpeg">
                </audio>
            </div>
        </div>

        <!-- TAB 1: BÀI HỌC -->
        <div id="tab-lesson" class="tab-content active">

            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Cột trái (70%) - Bài đọc -->
                <section class="w-full lg:w-[70%] text-left">
                    <div class="bg-white rounded-[30px] shadow-sm border border-blue-100 p-6 md:p-8">
                        <div class="p-6 md:p-10 bg-paper rounded-2xl shadow-inner border border-gray-100">
                            <h1 class="text-3xl font-black mb-10 text-blue-900 text-center uppercase tracking-tight">
                                Tên Bài Học</h1>
                            <div class="serif-font text-gray-800 md:columns-2 gap-12">
                                <p class="mb-4">Nội dung bài học sẽ được viết ở đây...</p>
                            </div>
                        </div>

                        <!-- Nội dung chính -->
                        <div class="mt-8 bg-blue-50 rounded-3xl p-6 border border-blue-100 relative overflow-hidden">
                            <div class="absolute -right-10 -top-10 w-40 h-40 bg-blue-100 rounded-full opacity-50">
                            </div>
                            <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                                <div class="bg-blue-600 p-6 rounded-2xl text-white shadow-lg shrink-0 text-center">
                                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-80 mb-1">Thông
                                        điệp</p>
                                    <h3 class="text-xl font-black uppercase">Nội dung chính</h3>
                                </div>
                                <div class="flex-grow">
                                    <p class="text-gray-700 font-bold leading-relaxed">
                                        Tóm tắt nội dung chính và ý nghĩa của bài học.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Cột phải (30%) - Tìm hiểu bài -->
                <aside class="w-full lg:w-[30%]">
                    <div class="bg-yellow-50 rounded-[30px] shadow-sm border border-yellow-100 p-4 sticky top-20">
                        <h2 class="text-xl font-black text-blue-900 mb-4 flex items-center">
                            <span class="w-10 h-10 bg-yellow-400 rounded-xl flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </span>
                            Tìm hiểu bài
                        </h2>

                        <div class="space-y-4">
                            <!-- Câu 1 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-4 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        1. Câu hỏi số 1?
                                    </span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform shrink-0 ml-2" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-4 pb-4 text-sm text-gray-700 leading-relaxed border-t border-gray-50 pt-3 bg-blue-50/30">
                                        <span class="text-green-600 font-bold block mb-1">Gợi ý trả lời:</span>
                                        <p>Nội dung câu trả lời gợi ý...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- TAB 2: LUYỆN TẬP -->
        <div id="tab-quiz" class="tab-content">
            <div
                class="max-w-4xl mx-auto bg-white rounded-[32px] shadow-xl border border-blue-100 overflow-hidden flex flex-col">
                <!-- Registration -->
                <div id="quiz-registration"
                    class="p-6 md:p-8 flex flex-col items-center justify-center min-h-[400px] text-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-black text-gray-800 mb-2">Đăng ký luyện tập</h2>
                    <p class="text-gray-500 mb-8 max-w-sm font-medium text-sm">Vui lòng điền thông tin để bắt đầu bài
                        tập trắc
                        nghiệm.</p>

                    <form onsubmit="startQuiz(event)" class="w-full max-w-sm space-y-4">
                        <input type="text" id="studentName" required placeholder="Họ và tên của em"
                            class="w-full px-5 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all font-bold placeholder:text-gray-400 text-sm">

                        <div class="grid grid-cols-2 gap-4">
                            <select id="studentClass" required
                                class="px-5 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-bold text-sm bg-white">
                                <option value="">Chọn Lớp</option>
                                <option value="5/1">5/1</option>
                                <option value="5/2">5/2</option>
                                <option value="5/3">5/3</option>
                                <option value="5/4">5/4</option>
                                <option value="5/5">5/5</option>
                            </select>

                            <select id="schoolSelect" required onchange="checkSchool()"
                                class="px-5 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-bold text-sm bg-white text-left">
                                <option value="Tiểu học Đỗ Văn Nại">TH Đỗ Văn Nại</option>
                                <option value="Khác">Trường khác...</option>
                            </select>
                        </div>

                        <input type="text" id="otherSchool" placeholder="Tên trường của em"
                            class="hidden w-full px-5 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all font-bold text-sm">

                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-3 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 text-base">
                            BẮT ĐẦU NGAY
                        </button>
                    </form>
                </div>

                <!-- Quiz Engine -->
                <div id="quiz-container" class="hidden flex-grow flex flex-col">
                    <div class="bg-blue-50 px-6 py-3 flex justify-between items-center border-b border-blue-100">
                        <div class="flex items-center">
                            <span
                                class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center font-black mr-3 shadow-md text-sm"
                                id="questionNum">1</span>
                            <p class="font-black text-blue-900 uppercase tracking-wider text-[10px]" id="progressText">
                                Đang thực hiện: 1/5</p>
                        </div>
                        <div
                            class="text-blue-600 font-bold text-xs bg-white px-3 py-1 rounded-full shadow-sm border border-blue-100">
                            Tên Bài Học
                        </div>
                    </div>

                    <div class="p-5 md:p-6 flex-grow">
                        <h3 class="text-lg font-black text-gray-800 mb-4 leading-tight" id="questionText">Câu hỏi?</h3>
                        <div class="grid grid-cols-1 gap-2" id="optionsArea">
                            <!-- Options -->
                        </div>
                    </div>

                    <div class="p-3 border-t border-gray-50 flex justify-end">
                        <button id="nextBtn" disabled
                            class="bg-blue-600 disabled:opacity-30 hover:bg-blue-700 text-white font-black py-2.5 px-8 rounded-xl shadow-lg transition-all active:scale-95 text-sm">
                            CÂU TIẾP THEO
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="quiz-results"
                    class="hidden p-6 md:p-8 flex-grow flex flex-col items-center justify-center text-center">
                    <div class="relative w-32 h-32 mb-4">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="64" cy="64" r="58" stroke="currentColor" stroke-width="10" fill="transparent"
                                class="text-gray-100" />
                            <circle id="scoreCircle" cx="64" cy="64" r="58" stroke="currentColor" stroke-width="10"
                                fill="transparent" class="text-blue-500" stroke-dasharray="0, 364.4"
                                stroke-linecap="round" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-4xl font-black text-gray-800" id="scoreText">0</span>
                            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest italic">Điểm
                                số</span>
                        </div>
                    </div>

                    <h2 class="text-2xl font-black text-gray-800 mb-1" id="resultTitle">Hoàn thành bài tập!</h2>
                    <p class="text-gray-500 mb-8 max-w-sm font-medium text-sm" id="resultMsg">Em đã nỗ lực hết mình rồi
                        đấy!
                    </p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-xs">
                        <button onclick="restartQuiz()"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-black py-2.5 rounded-xl transition-all text-sm">LÀM
                            LẠI</button>
                        <button onclick="submitResults(event)"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-black py-2.5 rounded-xl shadow-lg shadow-blue-200 transition-all text-sm">NỘP
                            KẾT QUẢ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="flex justify-end mt-8 pb-4">
            <a href="ve-dep-cuoc-song.html"
                class="flex items-center text-gray-500 hover:text-blue-600 transition-colors text-xs font-bold bg-white/80 backdrop-blur-sm px-5 py-2.5 rounded-full border border-gray-100 shadow-sm hover:shadow-md active:scale-95 transition-all">
                Trở về
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                        d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
            </a>
        </div>
    </main>

    <!-- Modal Teacher Stats -->
    <div id="statsModal" class="modal">
        <div class="bg-white rounded-[32px] w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl m-4">
            <div class="p-6 border-b flex justify-between items-center bg-blue-50">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-black text-blue-900">Bảng kết quả học tập</h2>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="exportToExcel()"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg> Xuất Excel
                    </button>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow overflow-auto p-6 bg-gray-50">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="text-left text-gray-500 uppercase text-xs font-black tracking-widest border-b pb-4">
                            <th class="p-4">STT</th>
                            <th class="p-4">Họ và Tên</th>
                            <th class="p-4">Lớp</th>
                            <th class="p-4">Trường</th>
                            <th class="p-4 text-center">Điểm số</th>
                            <th class="p-4 text-center">Thời gian</th>
                            <th class="p-4 text-right">Ngày nộp</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="bg-zinc-900 text-zinc-400 py-3 px-4 mt-8">
        <div class="container mx-auto text-center text-xs">
            <p>@ 2026 EduRobot - Phát triển bởi Lê Thành Long</p>
        </div>
    </footer>

    <script>
        /* UI LOGIC */
        function toggleAccordion(button) {
            const item = button.parentElement;
            const isOpen = item.classList.contains('accordion-open');
            document.querySelectorAll('.accordion-item').forEach(el => el.classList.remove('accordion-open'));
            if (!isOpen) item.classList.add('accordion-open');
        }

        const audio = document.getElementById('lessonAudio');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const audioStatus = document.getElementById('audioStatus');

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                audioStatus.innerText = "Đang phát...";
                audioStatus.classList.replace('text-gray-400', 'text-green-500');
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.innerText = "Đang dừng...";
                audioStatus.classList.replace('text-green-500', 'text-gray-400');
            }
        }

        audio.onended = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.innerText = "Đang dừng...";
            audioStatus.classList.replace('text-green-500', 'text-gray-400');
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('btn-' + tabId).classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        /* QUIZ ENGINE */
        const allQuestions = [
            { q: "Câu hỏi mẫu số 1?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 0 },
            { q: "Câu hỏi mẫu số 2?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 1 },
            { q: "Câu hỏi mẫu số 3?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 2 },
            { q: "Câu hỏi mẫu số 4?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 3 },
            { q: "Câu hỏi mẫu số 5?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 0 },
            { q: "Câu hỏi mẫu số 6?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 1 },
            { q: "Câu hỏi mẫu số 7?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 2 },
            { q: "Câu hỏi mẫu số 8?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 3 },
            { q: "Câu hỏi mẫu số 9?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 0 },
            { q: "Câu hỏi mẫu số 10?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 1 },
            { q: "Câu hỏi mẫu số 11?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 2 },
            { q: "Câu hỏi mẫu số 12?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 3 },
            { q: "Câu hỏi mẫu số 13?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 0 },
            { q: "Câu hỏi mẫu số 14?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 1 },
            { q: "Câu hỏi mẫu số 15?", a: ["Đáp án A", "Đáp án B", "Đáp án C", "Đáp án D"], c: 2 },
        ];

        let selectedQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let studentData = {};
        let startTime = null;

        function checkSchool() {
            const select = document.getElementById('schoolSelect');
            const other = document.getElementById('otherSchool');
            if (select.value === 'Khác') {
                other.classList.remove('hidden');
                other.required = true;
            } else {
                other.classList.add('hidden');
                other.required = false;
            }
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function startQuiz(e) {
            e.preventDefault();
            const schoolVal = document.getElementById('schoolSelect').value;
            studentData = {
                studentName: document.getElementById('studentName').value,
                studentClass: document.getElementById('studentClass').value,
                school: schoolVal === 'Khác' ? document.getElementById('otherSchool').value : schoolVal
            };
            // Chọn ngẫu nhiên 5 câu từ 15 câu bằng thuật toán Fisher-Yates để đảm bảo tính ngẫu nhiên cao
            const shuffled = shuffle([...allQuestions]);
            selectedQuestions = shuffled.slice(0, 5);
            currentIdx = 0;
            score = 0;
            startTime = new Date();
            document.getElementById('quiz-registration').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            const q = selectedQuestions[currentIdx];
            document.getElementById('questionNum').innerText = currentIdx + 1;
            document.getElementById('progressText').innerText = `Đang thực hiện: ${currentIdx + 1}/5`;
            document.getElementById('questionText').innerText = q.q;

            const area = document.getElementById('optionsArea');
            area.innerHTML = '';
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 text-left border-2 border-gray-100 rounded-2xl font-bold transition-all hover:border-blue-200 hover:bg-blue-50/50 flex items-center group";
                btn.innerHTML = `
                    <span class="w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center mr-4 group-hover:border-blue-400 group-hover:bg-blue-600 group-hover:text-white transition-all text-sm">${String.fromCharCode(65 + i)}</span>
                    <span class="flex-1">${opt}</span>
                `;
                btn.onclick = () => selectOption(i, btn);
                area.appendChild(btn);
            });
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('nextBtn').onclick = nextQuestion;
        }

        function selectOption(idx, btn) {
            document.querySelectorAll('#optionsArea button').forEach(b => {
                b.classList.remove('border-blue-600', 'bg-blue-50');
                b.querySelector('span').classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            });
            btn.classList.add('border-blue-600', 'bg-blue-50');
            btn.querySelector('span').classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('nextBtn').dataset.selected = idx;
        }

        function nextQuestion() {
            const selected = parseInt(document.getElementById('nextBtn').dataset.selected);
            if (selected === selectedQuestions[currentIdx].c) score += 20;

            currentIdx++;
            if (currentIdx < 5) showQuestion();
            else showResults();
        }

        function showResults() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('scoreText').innerText = score;
            const dash = (score / 100) * 364.4; // 2 * PI * 58
            document.getElementById('scoreCircle').style.strokeDasharray = `${dash}, 364.4`;

            if (score >= 80) {
                document.getElementById('resultTitle').innerText = "Rất tuyệt vời!";
                document.getElementById('resultMsg').innerText = "Em đã hoàn thành bài tập xuất sắc. Tiếp tục phát huy nhé!";
            } else if (score >= 60) {
                document.getElementById('resultTitle').innerText = "Làm tốt lắm!";
                document.getElementById('resultMsg').innerText = "Em đã hiểu bài khá tốt rồi đấy!";
            } else {
                document.getElementById('resultTitle').innerText = "Cố gắng lên nhé!";
                document.getElementById('resultMsg').innerText = "Hãy xem lại bài đọc và làm lại bài tập để đạt điểm cao hơn.";
            }
        }

        function restartQuiz() {
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-registration').classList.remove('hidden');
        }

        /* FIREBASE CONFIG */
        const firebaseConfig = {
            apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
            authDomain: "gamhoctap.firebaseapp.com",
            databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gamhoctap",
            storageBucket: "gamhoctap.firebasestorage.app",
            messagingSenderId: "833329613932",
            appId: "1:833329613932:web:0d8574827bcfe50b535c49",
            measurementId: "G-YT1PKCYS67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function submitResults(e) {
            const btn = e.target;
            btn.disabled = true;
            btn.innerText = "Đang gửi...";
            const duration = Math.floor((new Date() - startTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            const timeStr = `${minutes}p ${seconds}s`;

            try {
                await db.collection("diem_tieng_viet_lop5").add({
                    ...studentData,
                    lessonTitle: "Tên Bài Học", // Thay bằng tên bài học cụ thể
                    score: score,
                    duration: duration,
                    timeDisplay: timeStr,
                    endTime: new Date().toISOString(),
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`Chúc mừng ${studentData.studentName} đã nộp bài thành công!`);
                restartQuiz();
                switchTab('lesson');
            } catch (err) {
                console.error(err);
                alert("Có lỗi khi gửi kết quả. Em vui lòng thử lại nhé!");
            } finally {
                btn.disabled = false;
                btn.innerText = "NỘP KẾT QUẢ";
            }
        }

        /* TEACHER STATS */
        function openTeacherStats() {
            const pin = prompt("Vui lòng nhập mã PIN bảo mật:");
            if (pin === "dvn") {
                document.getElementById('statsModal').classList.add('active');
                loadStats();
            } else if (pin !== null) {
                alert("Mã PIN không chính xác!");
            }
        }

        function closeModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        let currentStatsData = [];
        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="p-10 text-center text-gray-400 font-bold italic">Đang tải dữ liệu...</td></tr>';

            try {
                const snapshot = await db.collection("diem_tieng_viet_lop5")
                    .where("lessonTitle", "==", "Tên Bài Học") // Thay bằng tên bài học cụ thể
                    .orderBy("submittedAt", "desc")
                    .get();

                currentStatsData = [];
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-10 text-center text-gray-400 font-bold italic">Chưa có dữ liệu học sinh nộp bài.</td></tr>';
                    return;
                }

                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    currentStatsData.push(data);
                    const row = document.createElement('tr');
                    row.className = "border-b hover:bg-gray-50 transition-colors bg-white";
                    row.innerHTML = `
                        <td class="p-4 font-bold text-gray-400">${index + 1}</td>
                        <td class="p-4 font-black text-gray-800">${data.studentName}</td>
                        <td class="p-4"><span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-black">${data.studentClass}</span></td>
                        <td class="p-4 text-gray-600 font-medium">${data.school}</td>
                        <td class="p-4 text-center"><span class="text-xl font-black ${data.score >= 80 ? 'text-green-600' : 'text-blue-600'}">${data.score}</span></td>
                        <td class="p-4 text-center font-bold text-gray-500">${data.timeDisplay || 'N/A'}</td>
                        <td class="p-4 text-right text-gray-400 text-xs font-bold">${data.submittedAt ? data.submittedAt.toDate().toLocaleString('vi-VN') : 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="7" class="p-10 text-center text-red-500 font-bold">Lỗi khi tải dữ liệu. Hãy thử lại!</td></tr>';
            }
        }

        function exportToExcel() {
            if (currentStatsData.length === 0) {
                alert("Không có dữ liệu để xuất!");
                return;
            }

            const dataToExport = currentStatsData.map((item, index) => ({
                'STT': index + 1,
                'Họ và Tên': item.studentName,
                'Lớp': item.studentClass,
                'Trường': item.school,
                'Điểm số': item.score,
                'Thời gian làm bài': item.timeDisplay || 'N/A',
                'Ngày nộp': item.submittedAt ? item.submittedAt.toDate().toLocaleString('vi-VN') : 'N/A'
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);

            // Force Class column to be text
            ws['!cols'] = [{}, {}, { t: 's' }, {}, {}, {}, {}];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQua");
            XLSX.writeFile(wb, "KetQua_BaiHoc.xlsx");
        }
    </script>
    <a href="ve-dep-cuoc-song.html"
        class="fixed bottom-8 right-8 z-[100] group flex items-center space-x-3 bg-white/80 backdrop-blur-xl p-2 pr-6 rounded-2xl shadow-2xl border border-white/50 hover:scale-105 transition-all active:scale-95">
        <div
            class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200 group-hover:rotate-12 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </div>
        <span class="text-sm font-black text-slate-700 uppercase tracking-wider">Trở về</span>
    </a>
</body>

</html>