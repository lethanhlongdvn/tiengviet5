<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Về thăm Đất Mũi - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- SheetJS for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        .hidden {
            display: none !important;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
        }

        .bg-paper {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .tab-btn.active {
            color: var(--primary);
            background: white;
            box-shadow: inset 0 -3px 0 var(--primary);
        }

        .tab-content {
            display: none !important;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block !important;
        }

        #tab-quiz.active {
            display: flex !important;
        }

        /* Compact Quiz styles */
        #quiz-container {
            height: calc(100vh - 180px);
            /* Adjust based on header/footer */
            max-height: 600px;
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid #e2e8f0;
        }

        .option-btn:hover:not(:disabled) {
            transform: translateX(4px);
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option-btn.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Accordion Custom */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-open .accordion-content {
            max-height: 500px;
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .reading-content p {
            text-indent: 2rem;
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        /* Success Modal Styles */
        .success-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 200;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        .success-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .success-card {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .success-modal.active .success-card {
            transform: scale(1);
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="sticky top-0 z-50 px-4 py-2">
        <nav class="container mx-auto glass-card rounded-xl px-5 py-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-3">
                <div
                    class="w-8 h-8 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg flex items-center justify-center text-white shadow-xl transform hover:rotate-6 transition-transform">
                    <span class="text-lg font-black">E</span>
                </div>
                <div class="flex flex-col md:flex-row md:items-center md:space-x-4">
                    <div class="flex items-center space-x-2">
                        <span
                            class="text-base font-black bg-gradient-to-r from-blue-600 to-indigo-800 bg-clip-text text-transparent hidden md:block">EduRobot</span>
                        <span
                            class="text-[11px] font-black px-2.5 py-0.5 rounded-full bg-gradient-to-r from-amber-400 to-orange-500 text-white shadow-sm shadow-amber-200 animate-pulse">TIẾNG
                            VIỆT 5</span>
                    </div>
                    <div class="h-4 w-px bg-gray-200 hidden md:block"></div>
                    <div class="flex items-center space-x-2 overflow-hidden">
                        <span class="text-[10px] font-black uppercase tracking-widest text-gray-400">Chủ điểm:</span>
                        <span
                            class="text-sm font-black uppercase tracking-wider text-blue-800 truncate max-w-[180px] md:max-w-none">Tên
                            Chủ Điểm</span>
                    </div>
                </div>
            </div>
            <ul class="flex space-x-6 text-xs font-bold items-center">
                <li><a href="index.html" class="flex items-center text-blue-600 hover:text-blue-700 transition-colors">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Quay lại
                    </a></li>
                <li class="border-l border-gray-200 pl-6"><a href="index.html"
                        class="text-gray-500 hover:text-blue-600 transition-colors">Trang chủ</a></li>
                <li><button onclick="openTeacherStats()"
                        class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-all">Giáo
                        viên</button></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-2">

        <!-- Tab & Audio Header -->
        <div class="glass-card mb-4 rounded-2xl overflow-hidden flex flex-col md:flex-row items-stretch shadow-lg">
            <div class="flex-1 flex bg-white/40">
                <button onclick="switchTab('lesson')" id="btn-lesson"
                    class="tab-btn active flex-1 py-4 text-center font-black text-base text-gray-400 transition-all border-r border-gray-100/50 uppercase tracking-wider">
                    1. Bài học
                </button>
                <button onclick="switchTab('quiz')" id="btn-quiz"
                    class="tab-btn flex-1 py-4 text-center font-black text-base text-gray-400 transition-all uppercase tracking-wider">
                    2. Luyện tập
                </button>
            </div>

            <div id="audio-container"
                class="p-2 md:px-4 flex items-center bg-blue-50/20 border-t md:border-t-0 md:border-l border-gray-100/50">
                <div
                    class="flex items-center space-x-3 bg-white/60 backdrop-blur-md rounded-xl p-1.5 pr-4 border border-white shadow-inner">
                    <button id="audioControl" onclick="toggleAudio()"
                        class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center text-white hover:scale-105 active:scale-95 transition-all shadow-md shadow-blue-200">
                        <svg id="playIcon" class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col">
                        <span
                            class="text-[9px] font-black text-blue-600 uppercase tracking-widest leading-none mb-0.5 whitespace-nowrap">ĐỌC
                            MẪU</span>
                        <span id="audioStatus"
                            class="text-[10px] text-gray-400 font-bold italic leading-none whitespace-nowrap">Đang
                            dừng...</span>
                    </div>
                </div>
                <audio id="lessonAudio">
                    <source src="am_thanh/vethamdatmui.mp3" type="audio/mpeg">
                </audio>
            </div>
        </div>

        <!-- TAB 1: BÀI HỌC -->
        <div id="tab-lesson" class="tab-content active">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Cột trái (70%) - Bài đọc -->
                <section class="w-full lg:w-[70%]">
                    <div class="glass-card rounded-[40px] p-6 md:p-10 shadow-2xl">
                        <div
                            class="bg-paper rounded-[32px] p-8 md:p-12 shadow-inner border border-white/50 relative overflow-hidden">
                            <!-- Trang trí góc -->
                            <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-100/30 rounded-full blur-3xl"></div>
                            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-amber-100/30 rounded-full blur-3xl">
                            </div>

                            <h1
                                class="text-4xl font-black mb-12 text-blue-950 text-center uppercase tracking-tighter leading-tight relative">
                                <span
                                    class="bg-blue-600 w-12 h-1.5 absolute -bottom-4 left-1/2 -translate-x-1/2 rounded-full"></span>
                                Về thăm Đất Mũi
                            </h1>

                            <div class="serif-font text-gray-800 text-lg leading-relaxed relative reading-content">
                                <p
                                    class="first-letter:text-5xl first-letter:font-black first-letter:text-blue-600 first-letter:mr-3 first-letter:float-left">
                                    Về đây nghe đất thở<br>
                                    Phập phồng trước bình minh<br>
                                    Về đây trông đước chạy<br>
                                    Những bước chân ngập sình.
                                </p>
                                <p>
                                    Gặp ngọn gió châu thổ<br>
                                    Đang mở hội trên đồng<br>
                                    Ca bài ca mở cõi<br>
                                    Của bao đời cha ông.
                                </p>
                                <p>
                                    Ngút ngàn rừng mắm, đước<br>
                                    Xanh đến tận vô cùng<br>
                                    Phù sa như dòng sữa<br>
                                    Nuôi đất rừng Năm Căn.
                                </p>
                                <p>
                                    Rễ mắm thì ăn lên<br>
                                    Rễ đước thì cắm xuống<br>
                                    Bền bỉ suốt ngày đêm<br>
                                    Trong tình yêu của đất.
                                </p>
                                <p>
                                    Nơi đây biển gặp rừng<br>
                                    Đất và trời gắn lại<br>
                                    Cho bãi bồi vươn xa<br>
                                    Đất nước mình lớn mãi.
                                </p>
                                <p>
                                    Lần đầu về Đất Mũi<br>
                                    Như về với nhà mình<br>
                                    Nơi địa đầu Tổ quốc<br>
                                    Rạng ngời ánh bình minh!
                                </p>
                                <p class="text-right italic text-sm text-gray-400 mt-8">(Hoài Anh)</p>
                            </div>
                        </div>

                        <!-- Nội dung chính -->
                        <div
                            class="mt-8 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[32px] p-8 text-white relative overflow-hidden shadow-xl transform hover:scale-[1.01] transition-transform">
                            <div
                                class="absolute right-0 top-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl">
                            </div>
                            <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                                <div
                                    class="bg-white/20 backdrop-blur-md p-6 rounded-2xl border border-white/30 shadow-lg shrink-0 text-center min-w-[160px]">
                                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-100 mb-1">
                                        Thông điệp</p>
                                    <h3 class="text-2xl font-black uppercase tracking-tight">Ý NGHĨA</h3>
                                </div>
                                <div class="flex-grow">
                                    <p class="text-lg font-bold leading-relaxed text-blue-50">
                                        Bài thơ ca ngợi vẻ đẹp thiên nhiên hùng vĩ và độc đáo (cây cối, đất, trời, rừng,
                                        biển...) của Đất Mũi Cà Mau - vùng đất thiêng liêng nơi cực Nam của Tổ quốc. Qua
                                        đó thể hiện tình yêu, niềm tự hào và sự gắn bó của tác giả đối với mảnh đất này.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Cột phải (30%) - Tìm hiểu bài -->
                <aside class="w-full lg:w-[30%]">
                    <div class="glass-card rounded-[40px] p-6 sticky top-28 shadow-xl border-amber-100/50">
                        <!-- Ảnh minh họa -->
                        <div class="mb-6 -mt-2">
                            <img src="hinh_anh/datmui.png" alt="Minh họa"
                                class="w-full h-auto rounded-3xl object-contain drop-shadow-xl transform hover:scale-105 transition-transform duration-500">
                        </div>

                        <div class="flex items-center space-x-4 mb-8">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg shadow-amber-200">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-black text-gray-800 tracking-tight">Tìm hiểu bài</h2>
                        </div>

                        <div class="space-y-4">
                            <!-- Câu 1 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        1. Tìm những hình ảnh cho thấy vẻ đẹp độc đáo của cây cối ở Đất Mũi.
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Cây cối được miêu tả mang đặc trưng của vùng Đất Mũi sình
                                            lầy: cây mắm, cây đước mọc thành rừng ngút ngàn, xanh tận vô cùng. Đặc biệt
                                            là bộ rễ: "rễ mắm thì ăn lên, rễ đước thì cắm xuống", bền bỉ bám sâu vào đất
                                            ngập sình.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 2 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        2. Những hình ảnh thiên nhiên ở Đất Mũi (gió, biển, đất trời,...) được miêu tả
                                        như thế nào?
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Thiên nhiên ở Đất Mũi rất độc đáo và sống động:
                                            <br>• Đất: biết "thở", "phập phồng".
                                            <br>• Gió: gió châu thổ đang "mở hội" trên đồng, ca bài ca mở cổi.
                                            <br>• Biển và rừng: gặp nhau ("biển gặp rừng").
                                            <br>• Đất và trời: gắn lại, khiến bãi bồi vươn xa.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 3 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        3. Hai dòng thơ "Nơi địa đầu Tổ quốc / Rạng ngời ánh bình minh" gợi cho em suy
                                        nghĩ gì về Đất Mũi?
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Hai dòng thơ ca ngợi vẻ đẹp rạng rỡ của Đất Mũi. Đồng
                                            thời thể hiện niềm tin của nhà thơ vào sự phát triển tốt đẹp, tươi sáng của
                                            mảnh đất nơi địa đầu thiêng liêng của Tổ quốc.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 4 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        4. Theo em, vì sao "lần đầu về Đất Mũi" tác giả lại có cảm giác "như về với nhà
                                        mình"?
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Tác giả có cảm giác như vậy vì thấy Đất Mũi vô cùng thân
                                            thương, gần gũi và gắn bó; vì tác giả rất yêu cảnh vật thiên nhiên nơi đây
                                            và thấy bóng dáng quê hương chung của dân tộc mình ở đó.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 5 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        5. Dựa vào bài đọc, em hãy giới thiệu Đất Mũi Cà Mau với bạn bè.
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">• Vị trí: Đất Mũi là mảnh đất nhô ra ở điểm cực Nam trên
                                            đất liền của Tổ quốc Việt Nam (thuộc huyện Ngọc Hiển, tỉnh Cà Mau).<br>• Vẻ
                                            đẹp tự nhiên: Có hệ sinh thái rừng ngập mặn độc đáo với cây mắm, cây đước
                                            mọc thành rừng (rễ mắm ăn lên, rễ đước cắm xuống). Đất đai là đất phù sa màu
                                            mỡ luôn được bồi đắp lấn ra biển ("đất nước mình lớn mãi").</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- TAB 2: LUYỆN TẬP -->
        <div id="tab-quiz" class="tab-content">
            <div
                class="max-w-4xl mx-auto glass-card rounded-[40px] shadow-2xl overflow-hidden flex flex-col min-h-[500px]">
                <!-- Registration -->
                <div id="quiz-registration" class="p-4 md:p-8 flex-grow flex flex-col justify-center overflow-auto">
                    <div class="text-center mb-6">
                        <div
                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl shadow-blue-200 mx-auto transform -rotate-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-black text-gray-800 mb-1 tracking-tight">Đăng ký luyện tập</h2>
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Về thăm Đất Mũi</p>
                    </div>

                    <form onsubmit="startQuiz(event)" class="w-full max-w-sm mx-auto space-y-4">
                        <div class="relative group">
                            <input type="text" id="studentName" required placeholder="Họ và tên của em"
                                class="w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold placeholder:text-gray-300 shadow-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <select id="studentClass" required
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="">Chọn Lớp</option>
                                <option value="5/1">5/1</option>
                                <option value="5/2">5/2</option>
                                <option value="5/3">5/3</option>
                                <option value="5/4">5/4</option>
                                <option value="5/5">5/5</option>
                            </select>

                            <select id="schoolSelect" required onchange="checkSchool()"
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="Tiểu học Đỗ Văn Nại">TH Đỗ Văn Nại</option>
                                <option value="Khác">Trường khác...</option>
                            </select>
                        </div>

                        <input type="text" id="otherSchool" placeholder="Tên trường của em"
                            class="hidden w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all font-bold shadow-sm">

                        <button type="submit"
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-base uppercase tracking-wider">
                            Bắt đầu luyện tập
                        </button>
                    </form>
                </div>

                <!-- Quiz Engine - COMPACT VERSION -->
                <div id="quiz-container" class="hidden flex-grow flex flex-col">
                    <div class="bg-blue-600/5 px-6 py-4 flex justify-between items-center border-b border-blue-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center font-black mr-4 shadow-lg shadow-blue-200"
                                id="questionNum">1</div>
                            <div class="flex flex-col">
                                <span
                                    class="text-[10px] font-black text-blue-600 uppercase tracking-widest leading-none mb-1"
                                    id="progressText">CÂU TRẮC NGHIỆM: 1/5</span>
                                <span class="text-xs text-gray-400 font-bold leading-none">Về thăm Đất Mũi</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 flex-grow flex flex-col justify-center overflow-auto">
                        <h3 class="text-xl md:text-2xl font-black text-gray-800 mb-6 leading-tight transition-all"
                            id="questionText">Nội dung câu hỏi?</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="optionsArea">
                            <!-- Options rendered by JS -->
                        </div>
                    </div>

                    <div class="px-6 py-4 border-t border-gray-50 flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold text-gray-400 italic">* Chọn đáp án đúng nhất</span>
                        <button id="nextBtn" disabled
                            class="bg-blue-600 disabled:opacity-30 hover:bg-blue-700 text-white font-black py-3 px-10 rounded-2xl shadow-lg shadow-blue-100 transition-all active:scale-95 uppercase text-sm tracking-widest">
                            Câu tiếp theo
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="quiz-results"
                    class="hidden p-8 flex-grow flex flex-col items-center justify-center text-center">
                    <div class="relative w-40 h-40 mb-8">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="80" cy="80" r="74" stroke="currentColor" stroke-width="12" fill="transparent"
                                class="text-gray-100" />
                            <circle id="scoreCircle" cx="80" cy="80" r="74" stroke="url(#scoreGrad)" stroke-width="12"
                                fill="transparent" class="transition-all duration-1000 ease-out"
                                stroke-dasharray="0, 465" stroke-linecap="round" />
                            <defs>
                                <linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#3b82f6" />
                                    <stop offset="100%" stop-color="#818cf8" />
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-5xl font-black text-gray-800" id="scoreText">0</span>
                            <span class="text-[10px] text-gray-400 font-black uppercase tracking-[0.2em] mt-1">Điểm
                                số</span>
                        </div>
                    </div>

                    <h2 class="text-3xl font-black text-gray-800 mb-2" id="resultTitle">Hoàn thành bài tập!</h2>
                    <p class="text-gray-500 mb-10 max-w-sm font-bold" id="resultMsg">Em đã nỗ lực hết mình rồi đấy!</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-md">
                        <button onclick="restartQuiz()"
                            class="bg-white hover:bg-gray-50 text-gray-700 font-black py-4 rounded-2xl border-2 border-gray-100 transition-all shadow-sm">LÀM
                            LẠI</button>
                        <button onclick="submitResults(event)"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-100 transition-all">NỘP
                            KẾT QUẢ</button>
                    </div>
                </div>
            </div>
        </div>


    </main>

    <!-- Modal Teacher Stats -->
    <div id="statsModal" class="modal">
        <div
            class="bg-white rounded-[40px] w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl m-4 transform transition-all">
            <div class="p-8 border-b flex justify-between items-center bg-gray-50/50 backdrop-blur-xl">
                <div class="flex items-center space-x-4">
                    <div
                        class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-gray-800 tracking-tight">Bảng kết quả học tập</h2>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Dành riêng cho giáo
                            viên</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="exportToExcel()"
                        class="bg-green-600 hover:bg-green-700 text-white font-black py-3 px-6 rounded-2xl text-sm flex items-center shadow-lg shadow-green-100 transition-all active:scale-95">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg> XUẤT EXCEL
                    </button>
                    <button onclick="closeModal()"
                        class="w-12 h-12 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-2xl transition-all">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow overflow-auto p-8 bg-gray-50/30">
                <table class="w-full">
                    <thead>
                        <tr
                            class="text-left text-gray-400 uppercase text-[10px] font-black tracking-[0.2em] border-b-2 border-gray-100 pb-4">
                            <th class="px-6 py-4">STT</th>
                            <th class="px-6 py-4">Họ và Tên</th>
                            <th class="px-6 py-4">Lớp</th>
                            <th class="px-6 py-4">Trường</th>
                            <th class="px-6 py-4 text-center">Điểm</th>
                            <th class="px-6 py-4 text-center">Lần</th>
                            <th class="px-6 py-4 text-center">Thời gian</th>
                            <th class="px-6 py-4 text-right">Hoàn thành</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="divide-y divide-gray-100">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal">
        <div class="glass-card success-card rounded-[40px] p-10 max-w-sm w-full text-center shadow-3xl border-white/50">
            <div
                class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-xl shadow-green-100 transform rotate-6 scale-110">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-3xl font-black text-gray-800 mb-2 tracking-tight">Nộp bài thành công!</h2>
            <p class="text-gray-500 mb-10 font-bold leading-relaxed">Chúc mừng em đã hoàn thành thử thách kiến thức!</p>
            <button onclick="closeSuccessModal()"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 uppercase tracking-widest text-sm">
                Trở về bài học
            </button>
        </div>
    </div>

    <footer class="py-5 px-4 mt-12 bg-white/30 backdrop-blur-md border-t border-white/50">
        <div class="container mx-auto text-center">
            <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em]">@ 2026 EduRobot - Hệ thống học
                tập thông minh</p>
            <p class="text-xs font-bold text-blue-600 mt-2">Phát triển bởi Lê Thành Long</p>
        </div>
    </footer>

    <script>
        /* UI LOGIC */
        function toggleAccordion(button) {
            const item = button.parentElement;
            const isOpen = item.classList.contains('accordion-open');
            document.querySelectorAll('.accordion-item').forEach(el => el.classList.remove('accordion-open'));
            if (!isOpen) item.classList.add('accordion-open');
        }

        const audio = document.getElementById('lessonAudio');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const audioStatus = document.getElementById('audioStatus');

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                audioStatus.innerText = "Đang phát...";
                audioStatus.classList.replace('text-gray-400', 'text-green-500');
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.innerText = "Đang dừng...";
                audioStatus.classList.replace('text-green-500', 'text-gray-400');
            }
        }

        audio.onended = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.innerText = "Đang dừng...";
            audioStatus.classList.replace('text-green-500', 'text-gray-400');
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('btn-' + tabId).classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        /* QUIZ ENGINE */
        const allQuestions = [
            { q: "Bài thơ \"Về thăm Đất Mũi\" viết về vùng đất thuộc tỉnh nào của nước ta?", a: ["Kiên Giang", "Bạc Liêu", "Cà Mau", "Sóc Trăng"], c: 2 },
            { q: "Trong khổ thơ đầu, tác giả nghe thấy đất có hoạt động gì?", a: ["Đất hát", "Đất thở", "Đất ngủ", "Đất rung chuyển"], c: 1 },
            { q: "Hình ảnh \"đước chạy\" được miêu tả gắn liền với đặc điểm địa hình nào?", a: ["Những đồi núi cao", "Những bãi cát trắng", "Những bước chân ngập sình", "Những cánh đồng lúa chín"], c: 2 },
            { q: "Ngọn gió châu thổ đang làm gì trên cánh đồng?", a: ["Đang ngủ yên", "Đang thổi mạnh gây bão", "Đang mở hội và ca bài ca mở cõi", "Đang đuổi chim"], c: 2 },
            { q: " \"Bài ca mở cõi\" được nhắc đến là của ai?", a: ["Của những người lính biên phòng", "Của bao đời cha ông", "Của những người nông dân", "Của sóng biển"], c: 1 },
            { q: "Hai loài cây đặc trưng nào của rừng ngập mặn được nhắc đến trong bài?", a: ["Cây tràm và cây dừa", "Cây sú và cây vẹt", "Cây mắm và cây đước", "Cây tre và cây lúa"], c: 2 },
            { q: "Tác giả so sánh \"phù sa\" với hình ảnh nào?", a: ["Dòng máu", "Dòng sữa", "Dòng mật", "Dòng sông"], c: 1 },
            { q: "Đặc điểm sinh trưởng độc đáo của rễ cây mắm là gì?", a: ["Cắm sâu xuống lòng đất", "Ăn lên (mọc ngược lên mặt đất)", "Mọc lan ra mặt nước", "Quấn quanh thân cây khác"], c: 1 },
            { q: "Ngược lại với rễ mắm, rễ cây đước có đặc điểm gì?", a: ["Ăn lên", "Cắm xuống", "Bay trong gió", "Nổi trên mặt nước"], c: 1 },
            { q: "Sự sinh trưởng bền bỉ của cây cối diễn ra trong điều kiện tình cảm nào?", a: ["Trong sự khắc nghiệt của bão tố", "Trong tình yêu của đất", "Trong nỗi nhớ của biển", "Trong sự cô đơn của rừng"], c: 1 },
            { q: "Nơi Đất Mũi được miêu tả là điểm gặp gỡ của hai yếu tố thiên nhiên nào?", a: ["Sông và suối", "Núi và đồi", "Biển và rừng", "Mây và gió"], c: 2 },
            { q: "Hình ảnh \"Bãi bồi vươn xa\" mang ý nghĩa gì về địa lý của Đất Mũi?", a: ["Đất đai đang bị biển xâm thực", "Diện tích đất liền đang ngày càng mở rộng ra biển (Đất nước mình lớn mãi)", "Bãi biển rất dài và đẹp", "Người dân đang lấn biển xây nhà"], c: 1 },
            { q: "Cảm xúc của tác giả trong lần đầu về Đất Mũi là gì?", a: ["Xa lạ và bỡ ngỡ", "Thân thương, gần gũi như về với nhà mình", "Lo lắng vì đường xa", "Ngạc nhiên vì cảnh lạ"], c: 1 },
            { q: "Cụm từ \"Nơi địa đầu Tổ quốc\" dùng để chỉ vị trí nào của Đất Mũi?", a: ["Điểm cực Bắc", "Điểm cực Đông", "Điểm cực Nam trên đất liền", "Điểm cực Tây"], c: 2 },
            { q: "Nội dung chính của bài thơ là gì?", a: ["Kể lại chuyến đi du lịch của tác giả", "Miêu tả quy trình trồng rừng ngập mặn", "Ca ngợi vẻ đẹp thiên nhiên độc đáo, sức sống mãnh liệt và ý nghĩa thiêng liêng của vùng Đất Mũi", "Giới thiệu các món ăn đặc sản của Cà Mau"], c: 2 }
        ];

        let selectedQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let studentData = {};
        let startTime = null;

        function checkSchool() {
            const select = document.getElementById('schoolSelect');
            const other = document.getElementById('otherSchool');
            if (select.value === 'Khác') {
                other.classList.remove('hidden');
                other.required = true;
            } else {
                other.classList.add('hidden');
                other.required = false;
            }
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function startQuiz(e) {
            e.preventDefault();
            const schoolVal = document.getElementById('schoolSelect').value;
            studentData = {
                studentName: document.getElementById('studentName').value,
                studentClass: document.getElementById('studentClass').value,
                school: schoolVal === 'Khác' ? document.getElementById('otherSchool').value : schoolVal
            };
            // Chọn ngẫu nhiên 5 câu từ 15 câu bằng thuật toán Fisher-Yates để đảm bảo tính ngẫu nhiên cao
            const shuffled = shuffle([...allQuestions]);
            selectedQuestions = shuffled.slice(0, 5);
            currentIdx = 0;
            score = 0;
            startTime = new Date();
            document.getElementById('quiz-registration').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            const q = selectedQuestions[currentIdx];
            document.getElementById('questionNum').innerText = currentIdx + 1;
            document.getElementById('progressText').innerText = `CÂU TRẮC NGHIỆM: ${currentIdx + 1}/5`;
            document.getElementById('questionText').innerText = q.q;

            const area = document.getElementById('optionsArea');
            area.innerHTML = '';
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full p-4 text-left bg-white rounded-2xl font-bold flex items-center group shadow-sm";
                btn.innerHTML = `
                    <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-4 group-hover:bg-blue-600 group-hover:text-white transition-all text-xs font-black shadow-inner">${String.fromCharCode(65 + i)}</div>
                    <span class="flex-1 text-sm md:text-base text-gray-700">${opt}</span>
                `;
                btn.onclick = () => selectOption(i, btn);
                area.appendChild(btn);
            });
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('nextBtn').onclick = nextQuestion;
        }

        function selectOption(idx, btn) {
            document.querySelectorAll('#optionsArea button').forEach(b => {
                b.classList.remove('selected', 'border-blue-600', 'bg-blue-50/50');
                b.querySelector('div').classList.remove('bg-blue-600', 'text-white');
            });
            btn.classList.add('selected');
            btn.querySelector('div').classList.add('bg-blue-600', 'text-white');
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('nextBtn').dataset.selected = idx;
        }

        function nextQuestion() {
            const selected = parseInt(document.getElementById('nextBtn').dataset.selected);
            if (selected === selectedQuestions[currentIdx].c) score += 20;

            currentIdx++;
            if (currentIdx < 5) showQuestion();
            else showResults();
        }

        function showResults() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('scoreText').innerText = score;
            const dash = (score / 100) * 364.4; // 2 * PI * 58
            document.getElementById('scoreCircle').style.strokeDasharray = `${dash}, 364.4`;

            if (score >= 80) {
                document.getElementById('resultTitle').innerText = "Rất tuyệt vời!";
                document.getElementById('resultMsg').innerText = "Em đã hoàn thành bài tập xuất sắc. Tiếp tục phát huy nhé!";
            } else if (score >= 60) {
                document.getElementById('resultTitle').innerText = "Làm tốt lắm!";
                document.getElementById('resultMsg').innerText = "Em đã hiểu bài khá tốt rồi đấy!";
            } else {
                document.getElementById('resultTitle').innerText = "Cố gắng lên nhé!";
                document.getElementById('resultMsg').innerText = "Hãy xem lại bài đọc và làm lại bài tập để đạt điểm cao hơn.";
            }
        }

        function restartQuiz() {
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-registration').classList.remove('hidden');
        }

        /* FIREBASE CONFIG */
        const firebaseConfig = {
            apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
            authDomain: "gamhoctap.firebaseapp.com",
            databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gamhoctap",
            storageBucket: "gamhoctap.firebasestorage.app",
            messagingSenderId: "833329613932",
            appId: "1:833329613932:web:0d8574827bcfe50b535c49",
            measurementId: "G-YT1PKCYS67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            restartQuiz();
            switchTab('lesson');
        }

        async function submitResults(e) {
            const btn = e.target;
            btn.disabled = true;
            btn.innerText = "Đang gửi...";
            const duration = Math.floor((new Date() - startTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            const timeStr = `${minutes}p ${seconds}s`;

            try {
                await db.collection("diem_tieng_viet_lop5").add({
                    ...studentData,
                    lessonTitle: "Về thăm Đất Mũi", // Thay bằng tên bài học cụ thể
                    score: score,
                    duration: duration,
                    timeDisplay: timeStr,
                    endTime: new Date().toISOString(),
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('successModal').classList.add('active');
            } catch (err) {
                console.error(err);
                alert("Có lỗi khi gửi kết quả. Em vui lòng thử lại nhé!");
            } finally {
                btn.disabled = false;
                btn.innerText = "NỘP KẾT QUẢ";
            }
        }

        /* TEACHER STATS */
        function openTeacherStats() {
            const pin = prompt("Vui lòng nhập mã PIN bảo mật:");
            if (pin === "dvn") {
                document.getElementById('statsModal').classList.add('active');
                loadStats();
            } else if (pin !== null) {
                alert("Mã PIN không chính xác!");
            }
        }

        function closeModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        let currentStatsData = [];
        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="p-20 text-center"><div class="flex flex-col items-center"><div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div><p class="text-gray-400 font-black uppercase tracking-widest text-xs">Đang xử lý dữ liệu...</p></div></td></tr>';

            try {
                const snapshot = await db.collection("diem_tieng_viet_lop5")
                    .where("lessonTitle", "==", "Về thăm Đất Mũi")
                    .get();

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" class="p-20 text-center text-gray-400 font-bold italic">Chưa có dữ liệu học sinh nộp bài.</td></tr>';
                    return;
                }

                // Aggregating logic: Highest score per student
                const studentGroups = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const key = `${data.studentName}_${data.studentClass}_${data.school}`.toLowerCase().trim();

                    if (!studentGroups[key]) {
                        studentGroups[key] = {
                            ...data,
                            attempts: 1,
                            bestScore: data.score,
                            latestSubmitted: data.submittedAt ? data.submittedAt.toDate() : new Date(0)
                        };
                    } else {
                        studentGroups[key].attempts++;
                        if (data.score > studentGroups[key].bestScore) {
                            studentGroups[key].bestScore = data.score;
                            studentGroups[key].timeDisplay = data.timeDisplay; // Use time from best attempt
                        }
                        const currentSubmitted = data.submittedAt ? data.submittedAt.toDate() : new Date(0);
                        if (currentSubmitted > studentGroups[key].latestSubmitted) {
                            studentGroups[key].latestSubmitted = currentSubmitted;
                        }
                    }
                });

                // Convert to array and sort by bestScore DESC
                currentStatsData = Object.values(studentGroups).sort((a, b) => b.bestScore - a.bestScore);

                tbody.innerHTML = '';
                currentStatsData.forEach((data, index) => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-blue-50/30 transition-colors group";
                    row.innerHTML = `
                        <td class="px-6 py-5 font-black text-gray-300 group-hover:text-blue-600 transition-colors">${index + 1}</td>
                        <td class="px-6 py-5">
                            <div class="font-black text-gray-800">${data.studentName}</div>
                        </td>
                        <td class="px-6 py-5">
                            <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider group-hover:bg-blue-100 group-hover:text-blue-700 transition-colors">${data.studentClass}</span>
                        </td>
                        <td class="px-6 py-5 text-gray-500 font-bold text-sm">${data.school}</td>
                        <td class="px-6 py-5 text-center">
                            <span class="text-xl font-black ${data.bestScore >= 80 ? 'text-green-600' : 'text-blue-600'}">${data.bestScore}</span>
                        </td>
                        <td class="px-6 py-5 text-center">
                            <span class="w-8 h-8 rounded-full bg-amber-50 text-amber-600 flex items-center justify-center mx-auto text-xs font-black border border-amber-100">${data.attempts}</span>
                        </td>
                        <td class="px-6 py-5 text-center font-bold text-gray-500 text-sm italic">${data.timeDisplay || 'N/A'}</td>
                        <td class="px-6 py-5 text-right">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">${data.latestSubmitted.toLocaleDateString('vi-VN')}</div>
                            <div class="text-xs font-bold text-gray-800">${data.latestSubmitted.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="8" class="p-20 text-center text-red-500 font-bold">Lỗi khi tải dữ liệu. Hãy thử lại!</td></tr>';
            }
        }

        function exportToExcel() {
            if (currentStatsData.length === 0) {
                alert("Không có dữ liệu để xuất!");
                return;
            }

            const dataToExport = currentStatsData.map((item, index) => ({
                'STT': index + 1,
                'Họ và Tên': item.studentName,
                'Lớp': item.studentClass,
                'Trường': item.school,
                'Điểm cao nhất': item.bestScore,
                'Số lần làm': item.attempts,
                'Thời gian làm bài (Lần tốt nhất)': item.timeDisplay || 'N/A',
                'Lần nộp cuối': item.latestSubmitted.toLocaleString('vi-VN')
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);

            // Force Class column to be text
            ws['!cols'] = [{}, {}, { t: 's' }, {}, {}, {}, {}];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQua");
            XLSX.writeFile(wb, "KetQua_BaiHoc.xlsx");
        }
    </script>
    <a href="ve-dep-cuoc-song.html"
        class="fixed bottom-8 right-8 z-[100] group flex items-center space-x-3 bg-white/80 backdrop-blur-xl p-2 pr-6 rounded-2xl shadow-2xl border border-white/50 hover:scale-105 transition-all active:scale-95">
        <div
            class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200 group-hover:rotate-12 transition-transform">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </div>
        <span class="text-sm font-black text-slate-700 uppercase tracking-wider">Trở về</span>
    </a>
</body>

</html>