<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vi·∫øt b√†i vƒÉn t·∫£ ng∆∞·ªùi (B√†i vi·∫øt s·ªë 1) - EduRobot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        .hidden {
            display: none !important;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .notebook-paper {
            background-color: #fff;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 100% 2.5rem;
            line-height: 2.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">
    <header class="sticky top-0 z-50 px-4 py-2">
        <nav class="container mx-auto glass-card rounded-xl px-5 py-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-4">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 shrink-0">
                    <span class="text-xl font-black">E</span>
                </div>
                <div class="flex flex-col md:flex-row md:items-center md:space-x-6">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl font-black text-blue-700">EduRobot</span>
                        <span
                            class="text-[11px] font-bold px-3 py-1 rounded-full bg-orange-500 text-white shadow-sm shadow-orange-200 tracking-wide">TI·∫æNG
                            VI·ªÜT 5</span>
                    </div>
                    <div
                        class="flex items-center space-x-3 overflow-hidden border-l-0 md:border-l-2 md:border-gray-100 md:pl-6">
                        <div class="flex items-center space-x-2">
                            <span
                                class="text-[10px] font-black uppercase tracking-widest text-gray-400 whitespace-nowrap">TU·∫¶N
                                21</span>
                            <span
                                class="text-[11px] font-black uppercase tracking-wider text-blue-800 whitespace-nowrap">B√ÄI:
                                TH∆Ø C·ª¶A B·ªê</span>
                        </div>
                        <div class="h-4 w-px bg-gray-200 hidden md:block"></div>
                        <div class="flex items-center space-x-2">
                            <span
                                class="text-[10px] font-black uppercase tracking-widest text-gray-400 whitespace-nowrap">CH·ª¶
                                ƒêI·ªÇM:</span>
                            <span
                                class="text-[11px] font-black uppercase tracking-wider text-blue-800 truncate max-w-[150px] md:max-w-none">V·∫∫
                                ƒê·∫∏P CU·ªòC S·ªêNG</span>
                        </div>
                    </div>
                </div>
            </div>
            <ul class="flex space-x-2 md:space-x-6 text-xs font-bold items-center relative">
                <!-- Home -->
                <li>
                    <a href="index.html"
                        class="flex items-center text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Trang ch·ªß
                    </a>
                </li>

                <!-- Lessons Dropdown -->
                <li class="relative group">
                    <button id="top-menu-lesson-btn"
                        class="flex items-center text-gray-500 hover:text-blue-600 transition-colors focus:outline-none py-2 font-black">
                        B√†i h·ªçc
                        <svg class="w-4 h-4 ml-1 transition-transform duration-200" id="top-menu-chevron" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <!-- Dropdown Content (Hidden by default) -->
                    <div id="top-menu-lessons-dropdown"
                        class="absolute top-full right-[-100px] md:right-auto md:left-1/2 md:-translate-x-1/2 mt-4 w-[320px] bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 hidden max-h-[70vh] overflow-y-auto z-[60] p-2">
                        <!-- Content rendered by floating-menu.js -->
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-5xl flex-1">
        <!-- Student Info -->
        <div class="mb-8 bg-white border-2 border-blue-100 rounded-3xl p-6 shadow-sm flex flex-col items-center gap-4">
            <div class="flex items-center space-x-4 w-full">
                <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                    <span>üë§</span>
                </div>
                <div class="flex-1">
                    <label
                        class="block text-[10px] font-black text-blue-400 uppercase tracking-widest leading-none mb-1">H·ªç
                        t√™n c·ªßa em</label>
                    <input type="text" id="studentName" placeholder="Nh·∫≠p t√™n em..."
                        class="w-full text-lg font-black text-gray-800 bg-transparent border-none focus:outline-none focus:ring-0 p-0">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                <div
                    class="flex items-center space-x-3 bg-gray-50 p-3 rounded-2xl border border-gray-100 focus-within:border-blue-300 transition-all">
                    <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest px-2">L·ªõp:</label>
                    <select id="studentClass"
                        class="flex-1 bg-transparent border-none focus:outline-none font-black text-gray-700 text-sm cursor-pointer">
                        <option value="">Ch·ªçn L·ªõp</option>
                        <option value="5/1">5/1</option>
                        <option value="5/2">5/2</option>
                        <option value="5/3">5/3</option>
                        <option value="5/4">5/4</option>
                        <option value="5/5">5/5</option>
                    </select>
                </div>

                <div
                    class="flex items-center space-x-3 bg-gray-50 p-3 rounded-2xl border border-gray-100 focus-within:border-blue-300 transition-all">
                    <label class="text-[9px] font-black text-gray-400 uppercase tracking-widest px-2">Tr∆∞·ªùng:</label>
                    <select id="schoolSelect" onchange="checkSchool()"
                        class="flex-1 bg-transparent border-none focus:outline-none font-black text-gray-700 text-sm cursor-pointer">
                        <option value="Ti·ªÉu h·ªçc ƒê·ªó VƒÉn N·∫°i">Ti·ªÉu h·ªçc ƒê·ªó VƒÉn N·∫°i</option>
                        <option value="Kh√°c">Tr∆∞·ªùng kh√°c...</option>
                    </select>
                </div>
            </div>

            <input type="text" id="otherSchool" placeholder="Nh·∫≠p t√™n tr∆∞·ªùng c·ªßa em..."
                class="hidden w-full p-4 rounded-2xl bg-orange-50 border-2 border-orange-100 focus:border-orange-300 focus:outline-none font-black text-sm transition-all">
        </div>

        <!-- Title -->
        <div class="glass-card rounded-[32px] p-8 shadow-xl border-t-8 border-blue-500 mb-8">
            <h1 class="text-3xl font-black text-blue-800 mb-4 uppercase flex items-center">
                <span class="bg-blue-600 text-white px-4 py-1 rounded-xl mr-4 not-italic text-lg">VI·∫æT</span>
                Vi·∫øt b√†i vƒÉn t·∫£ ng∆∞·ªùi (B√†i vi·∫øt s·ªë 1)
            </h1>

            <div class="bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 mb-6">
                <h2 class="text-orange-800 font-black text-lg mb-3">Ch·ªçn 1 trong 2 ƒë·ªÅ d∆∞·ªõi ƒë√¢y:</h2>
                <ul class="space-y-3 font-bold text-gray-700">
                    <li class="flex items-start gap-3">
                        <span class="bg-orange-200 text-orange-700 px-2 py-0.5 rounded text-xs mt-1">ƒê·ªÅ 1</span>
                        <span>Vi·∫øt b√†i vƒÉn t·∫£ m·ªôt ng∆∞·ªùi th√¢n trong gia ƒë√¨nh em.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <span class="bg-orange-200 text-orange-700 px-2 py-0.5 rounded text-xs mt-1">ƒê·ªÅ 2</span>
                        <span>Vi·∫øt b√†i vƒÉn t·∫£ m·ªôt ng∆∞·ªùi ƒë√£ ƒë·ªÉ l·∫°i cho em nh·ªØng ·∫•n t∆∞·ª£ng t·ªët ƒë·∫πp.</span>
                    </li>
                </ul>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Instructions -->
                <div class="space-y-4">
                    <h3 class="font-black text-blue-700 uppercase text-xs tracking-widest flex items-center">
                        <span class="mr-2">üí°</span> L∆∞u √Ω khi vi·∫øt:
                    </h3>
                    <ul class="space-y-3 text-sm font-bold text-gray-600">
                        <li class="flex gap-2"><span>-</span> <span>T·∫≠p trung t·∫£ nh·ªØng n√©t n·ªïi b·∫≠t l√†m n√™n v·∫ª ri√™ng c·ªßa
                                ng∆∞·ªùi ƒë∆∞·ª£c t·∫£.</span></li>
                        <li class="flex gap-2"><span>-</span> <span>K·∫øt h·ª£p t·∫£ v·ªõi b·ªôc l·ªô c·∫£m nghƒ© c·ªßa em v·ªÅ ng∆∞·ªùi
                                ƒë√≥.</span></li>
                        <li class="flex gap-2"><span>-</span> <span>S·ª≠ d·ª•ng bi·ªán ph√°p so s√°nh, t·ª´ ng·ªØ g·ª£i t·∫£ ƒë·ªÉ b√†i vƒÉn
                                sinh ƒë·ªông.</span></li>
                    </ul>
                </div>
                <!-- Word requirement -->
                <div
                    class="bg-blue-50 p-6 rounded-2xl border-2 border-dashed border-blue-200 flex flex-col justify-center items-center text-center">
                    <span class="text-4xl mb-2">‚úçÔ∏è</span>
                    <p class="font-black text-blue-800">Y√™u c·∫ßu: ƒê·ªß 3 ph·∫ßn</p>
                    <p class="text-sm font-bold text-blue-600">ƒê·ªô d√†i t·ªëi thi·ªÉu 100 t·ª´</p>
                </div>
            </div>
        </div>

        <!-- Writing Area -->
        <div class="glass-card p-8 md:p-12 rounded-[40px] shadow-2xl bg-white/90 relative mb-8">
            <div class="flex justify-between items-end mb-6">
                <h3 class="text-2xl font-black text-gray-800 flex items-center">
                    <span
                        class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 mr-3 text-xl shadow-inner">üìù</span>
                    B√†i l√†m c·ªßa em:
                </h3>
                <div
                    class="bg-gray-100 px-4 py-2 rounded-xl text-xs font-black text-gray-500 uppercase tracking-widest">
                    S·ªë t·ª´: <span id="word-count" class="text-blue-600">0</span>
                </div>
            </div>

            <textarea id="ai-main-essay"
                class="notebook-paper w-full p-8 focus:outline-none text-lg font-medium text-gray-700"
                placeholder="Em h√£y vi·∫øt b√†i vƒÉn v√†o ƒë√¢y nh√©. Nh·ªõ ƒë·ªß 3 ph·∫ßn: M·ªü b√†i, Th√¢n b√†i v√† K·∫øt b√†i..."></textarea>

            <div class="mt-8 flex flex-col md:flex-row gap-4">
                <button onclick="askAI('main-essay')"
                    class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-black py-4 px-8 rounded-2xl shadow-xl transition-all transform hover:-translate-y-1 flex items-center justify-center">
                    <span class="text-xl mr-2">ü§ñ</span> EduRobot Ch·∫•m B√†i
                </button>
                <button onclick="submitEssayWithUpload(event)"
                    class="flex-1 bg-white hover:bg-green-50 text-green-600 border-4 border-green-600 font-black py-4 px-8 rounded-2xl shadow-xl transition-all transform hover:-translate-y-1 flex items-center justify-center">
                    <span class="text-xl mr-2">üöÄ</span> N·ªôp B√†i Cho Th·∫ßy/C√¥
                </button>
            </div>

            <div id="fb-main-essay" class="hidden mt-8"></div>

            <!-- Alternative Upload -->
            <div class="mt-12 pt-8 border-t-2 border-dashed border-gray-100">
                <div class="bg-gray-50 p-6 rounded-2xl border-2 border-gray-100">
                    <h4 class="font-black text-gray-600 mb-4 uppercase text-xs tracking-widest text-center">N·∫øu em vi·∫øt
                        tay, h√£y ch·ª•p ·∫£nh b√†i l√†m ƒë·ªÉ n·ªôp:</h4>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <!-- Choose from library -->
                        <input type="file" id="photo-upload" accept="image/*" class="hidden"
                            onchange="updateUploadLabel('photo-upload')">
                        <button onclick="document.getElementById('photo-upload').click()"
                            class="flex-1 max-w-xs inline-flex items-center justify-center px-6 py-4 bg-white border-2 border-blue-500 text-blue-600 rounded-xl font-black hover:bg-blue-50 transition-all shadow-sm">
                            <span class="mr-2">üñºÔ∏è</span> CH·ªåN ·∫¢NH
                        </button>

                        <!-- Capture from camera -->
                        <input type="file" id="camera-capture" accept="image/*" capture="environment" class="hidden"
                            onchange="updateUploadLabel('camera-capture')">
                        <button onclick="document.getElementById('camera-capture').click()"
                            class="flex-1 max-w-xs inline-flex items-center justify-center px-6 py-4 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700 transition-all shadow-lg transform hover:-translate-y-1">
                            <span class="mr-2">üì∏</span> CH·ª§P ·∫¢NH NGAY
                        </button>
                    </div>
                    <p id="upload-status-label" class="mt-4 text-xs font-bold text-blue-600 text-center hidden italic">
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script src="js/ai-grader.js"></script>
    <script src="js/firebase-logic.js"></script>
    <script src="js/floating-menu.js"></script>
    <script>
        // Firebase Config (Placeholder)
        const firebaseConfig = {
            apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
            authDomain: "gamhoctap.firebaseapp.com",
            projectId: "gamhoctap",
            storageBucket: "gamhoctap.firebasestorage.app",
            messagingSenderId: "833329613932",
            appId: "1:833329613932:web:0d8574827bcfe50b535c49"
        };

        // Initialize Firebase if not already
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Word counter logic
        const textarea = document.getElementById('ai-main-essay');
        const countDisplay = document.getElementById('word-count');

        textarea.addEventListener('input', () => {
            const text = textarea.value.trim();
            const words = text ? text.split(/\s+/).length : 0;
            countDisplay.innerText = words;
            if (words < 100) {
                countDisplay.classList.replace('text-blue-600', 'text-red-500');
            } else {
                countDisplay.classList.replace('text-red-500', 'text-blue-600');
            }
        });

        function checkSchool() {
            const select = document.getElementById('schoolSelect');
            const otherInput = document.getElementById('otherSchool');
            if (select.value === 'Kh√°c') {
                otherInput.classList.remove('hidden');
            } else {
                otherInput.classList.add('hidden');
            }
        }

        function updateUploadLabel(inputId) {
            const input = document.getElementById(inputId);
            const statusLabel = document.getElementById('upload-status-label');

            if (inputId === 'photo-upload') {
                document.getElementById('camera-capture').value = "";
            } else {
                document.getElementById('photo-upload').value = "";
            }

            if (input.files.length > 0) {
                statusLabel.classList.remove('hidden');
                statusLabel.innerHTML = `‚ú® ƒê√£ ch·ªçn file: <span class="text-blue-800 font-black">${input.files[0].name}</span>`;
            }
        }

        async function submitEssayWithUpload(event) {
            const name = document.getElementById('studentName').value.trim();
            const cls = document.getElementById('studentClass').value;
            const schoolSelect = document.getElementById('schoolSelect').value;
            const otherSchool = document.getElementById('otherSchool').value.trim();
            const school = schoolSelect === 'Kh√°c' ? otherSchool : schoolSelect;

            const content = textarea.value.trim();

            const fileInputStd = document.getElementById('photo-upload');
            const fileInputCam = document.getElementById('camera-capture');
            const file = fileInputStd.files[0] || fileInputCam.files[0];

            if (!name || !cls) {
                alert("Em h√£y ƒëi·ªÅn T√™n v√† L·ªõp tr∆∞·ªõc nh√©!");
                return;
            }

            if (!content && !file) {
                alert("Em h√£y vi·∫øt b√†i ho·∫∑c ch·ª•p ·∫£nh b√†i l√†m r·ªìi m·ªõi n·ªôp nh√©!");
                return;
            }

            const btn = event ? event.currentTarget : document.querySelector('button[onclick*="submitEssayWithUpload"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = " ƒëang g·ª≠i b√†i...";

            try {
                let fileUrl = "";
                if (file) {
                    const storageRef = storage.ref(`essays_v2/${Date.now()}_${file.name}`);
                    const uploadTask = await storageRef.put(file);
                    fileUrl = await uploadTask.ref.getDownloadURL();
                }

                await db.collection("essays_v2").add({
                    studentName: name,
                    studentClass: cls,
                    studentSchool: school,
                    content: content,
                    fileUrl: fileUrl,
                    lessonTitle: "Vi·∫øt b√†i vƒÉn t·∫£ ng∆∞·ªùi (B√†i vi·∫øt s·ªë 1)",
                    aiGrade: document.querySelector('.text-4xl.font-black')?.innerText || "Ch∆∞a ch·∫•m",
                    aiFeedback: document.querySelector('.serif-font.text-lg')?.innerText || "",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: "Ch∆∞a ch·∫•m"
                });

                alert("Ch√∫c m·ª´ng! B√†i l√†m c·ªßa em ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng.");
                if (typeof confetti === 'function') confetti();
            } catch (e) {
                console.error("Submission error:", e);
                alert("L·ªói khi g·ª≠i b√†i: " + e.message + "\nEm h√£y ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i nh√©!");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>

</html>
