<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Những búp chè trên cây cổ thụ - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Nunito & Merriweather -->
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        body {
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
            line-height: 1.8;
        }

        .bg-paper {
            background-color: #fdfbf7;
            background-image: url("https://www.transparenttextures.com/patterns/natural-paper.png");
        }

        .tab-btn.active {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease-out;
            opacity: 0;
        }

        .accordion-open .accordion-content {
            max-height: 500px;
            opacity: 1;
            padding-bottom: 20px;
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .quiz-option.selected {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        /* Modal Teacher Stats */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="sticky top-0 z-50 px-4 py-2">
        <nav class="container mx-auto glass-card rounded-xl px-5 py-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-4">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 shrink-0">
                    <span class="text-xl font-black">E</span>
                </div>
                <div class="flex flex-col md:flex-row md:items-center md:space-x-6">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl font-black text-blue-700">EduRobot</span>
                        <span
                            class="text-[11px] font-bold px-3 py-1 rounded-full bg-orange-500 text-white shadow-sm shadow-orange-200 tracking-wide whitespace-nowrap">TIẾNG
                            VIỆT 5</span>
                    </div>

                    <div class="flex items-center space-x-2 overflow-hidden">
                        <span
                            class="text-[11px] font-black uppercase tracking-widest text-gray-400 whitespace-nowrap">CHỦ
                            ĐIỂM:</span>
                        <span
                            class="text-sm font-black uppercase tracking-wider text-blue-800 truncate max-w-[180px] md:max-w-none">HƯƠNG
                            SẮC TRĂM MIỀN</span>
                    </div>
                </div>
            </div>
            <ul class="flex space-x-2 md:space-x-6 text-xs font-bold items-center relative">
                <!-- Home -->
                <li>
                    <a href="index.html"
                        class="flex items-center text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Trang chủ
                    </a>
                </li>

                <!-- Lessons Dropdown -->
                <li class="relative group">
                    <button id="top-menu-lesson-btn"
                        class="flex items-center text-gray-500 hover:text-blue-600 transition-colors focus:outline-none py-2">
                        Bài học
                        <svg class="w-4 h-4 ml-1 transition-transform duration-200" id="top-menu-chevron" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <!-- Dropdown Content (Hidden by default) -->
                    <div id="top-menu-lessons-dropdown"
                        class="absolute top-full right-[-100px] md:right-auto md:left-1/2 md:-translate-x-1/2 mt-4 w-[320px] bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 hidden max-h-[70vh] overflow-y-auto z-[60] p-2">
                        <!-- Content rendered by floating-menu.js -->
                    </div>
                </li>

                <!-- Teacher -->
                <li>
                    <button onclick="openTeacherStats()"
                        class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Giáo viên
                    </button>
                </li>

                <!-- Contact -->
                <li>
                    <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Liên hệ
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-4">


        <!-- Tab & Audio Header -->
        <div class="glass-card mb-4 rounded-2xl overflow-hidden flex flex-col md:flex-row items-stretch shadow-lg">
            <div class="flex-1 flex bg-white/40">
                <button onclick="switchTab('lesson')" id="btn-lesson"
                    class="tab-btn active flex-1 py-4 text-center font-black text-base text-gray-400 transition-all border-r border-gray-100/50 uppercase tracking-wider">
                    1. Đọc và tìm hiểu bài
                </button>
                <button onclick="switchTab('quiz')" id="btn-quiz"
                    class="tab-btn flex-1 py-4 text-center font-black text-base text-gray-400 transition-all uppercase tracking-wider">
                    2. Luyện tập
                </button>
            </div>

            <div id="audio-container"
                class="p-2 md:px-4 flex items-center bg-blue-50/20 border-t md:border-t-0 md:border-l border-gray-100/50">
                <div
                    class="flex items-center space-x-3 bg-white/60 backdrop-blur-md rounded-xl p-1.5 pr-4 border border-white shadow-inner">
                    <button id="audioControl" onclick="toggleAudio()"
                        class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center text-white hover:scale-105 active:scale-95 transition-all shadow-md shadow-blue-200">
                        <svg id="playIcon" class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col">
                        <span
                            class="text-[9px] font-black text-blue-600 uppercase tracking-widest leading-none mb-0.5 whitespace-nowrap">ĐỌC
                            MẪU</span>
                        <span id="audioStatus"
                            class="text-[10px] text-gray-400 font-bold italic leading-none whitespace-nowrap">Đang
                            dừng...</span>
                    </div>
                </div>
                <audio id="lessonAudio">
                    <source src="am_thanh/nhungbupche.wav" type="audio/mpeg">
                </audio>
            </div>
        </div>
        <!-- TAB 1: 1. Đọc và tìm hiểu bài -->
        <div id="tab-lesson" class="tab-content active">

            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Cột trái (70%) - Bài đọc -->
                <section class="w-full lg:w-[70%]">
                    <div class="bg-white rounded-[30px] shadow-sm border border-blue-100 p-6 md:p-8">
                        <div class="p-6 md:p-10 bg-paper rounded-2xl shadow-inner border border-gray-100">
                            <div class="serif-font text-gray-800 text-justify">
                                <h1
                                    class="text-3xl md:text-4xl font-black text-blue-800 mb-6 uppercase italic tracking-tight flex items-center justify-center text-center">
                                    <span
                                        class="bg-blue-600 text-white px-4 py-1 rounded-xl mr-4 not-italic text-lg shrink-0">ĐỌC</span>
                                    <span>Những búp chè trên cây cổ thụ</span>
                                </h1>

                                <p class="mb-4">
                                    Tôi có một cậu bạn người Mông tên là Thào A Sùng. Mỗi lần gặp cậu, tôi lại được nghe
                                    cậu kể về bản làng Tà Xùa quê hương cậu, về những cây chè cổ thụ cao lớn ở đó với
                                    giọng tự hào. Cậu luôn trăn trở vì còn ít người biết đến chè Tà Xùa.
                                </p>
                                <p class="mb-4">
                                    Một lần, huyện tôi tổ chức cuộc thi "Bảy sắc cầu vồng" giữa các trường. Chúng tôi
                                    gặp nhau trong một trận đấu. Chỉ còn câu hỏi cuối cùng khi tỉ số đang nghiêng về
                                    trường tôi.
                                </p>
                                <p class="mb-4 italic">
                                    – Quê hương Bắc Yên của chúng ta có loại chè rất ngon. Em biết gì về loại chè ấy?
                                </p>
                                <p class="mb-4">
                                    Tim tôi đập mạnh. Đèn bên đội Thào A Sùng loé sáng. Cậu từ từ đứng lên.
                                </p>
                                <p class="mb-4">
                                    – Thưa cô,... Đó là chè ở Tà Xùa quê em ạ.
                                </p>
                                <p class="mb-4 italic text-blue-700">
                                    – Đúng rồi! Em biết những gì về chè Tà Xùa?
                                </p>
                                <p class="mb-4">
                                    – Chè Tà Xùa được làm từ những búp chè to, dưới lá có lớp lông tơ mịn, trắng như
                                    tuyết, mọc trên những cây cổ thụ cao lớn. Nước chè khi pha có màu vàng ánh xanh,
                                    thơm ngan ngát. Mẹ em bảo khi uống, vị ban đầu sẽ hơi chát, sau đó đọng lại là vị
                                    ngọt. Chè ngon, nhưng cây chè còn ít, nên không được nhiều người biết đến ạ.
                                </p>
                                <p class="mb-4 italic text-blue-700">
                                    – Em có ước mơ nào cho chè Tà Xùa không?
                                </p>
                                <p class="mb-4">
                                    Cậu cười, ánh mắt tràn ngập khát khao.
                                </p>
                                <p class="mb-4 font-bold">
                                    – Em ước làm kĩ sư nông nghiệp để giúp bản trồng được nhiều chè hơn. Em sẽ mang chè
                                    Tà Xùa đi khắp thế giới.
                                </p>
                                <p class="mb-4">
                                    Hội trường rộ tiếng vỗ tay. Trong phút chốc, chúng tôi như quên mất cuộc thi, chỉ
                                    xôn xao hỏi nhau về cây chè quê hương.
                                </p>
                                <p class="mb-4">
                                    Buổi tối, Thào A Sùng đến nhà tôi chơi. Mẹ tôi nói ngày mai sẽ đến Tà Xùa để mua
                                    chè. Mẹ bảo cứ nghĩ đến chén nước chè trong veo, hương thiên nhiên nồng nàn, nóng
                                    đến sưởi ấm bàn tay là muốn đến Tà Xùa ngay.
                                </p>
                                <p class="mb-4">
                                    Thào A Sùng cười thật tươi. Trong mắt cậu, tôi như thấy những đồi chè bạt ngàn, thân
                                    cây đẫm sương còn ngọn vươn cao đón nắng.
                                </p>
                                <p class="text-right italic font-bold text-gray-600 mt-6">(Theo Nguyễn Hương)</p>
                            </div>
                        </div>

                        <!-- Nội dung chính -->
                        <div class="mt-8 bg-blue-50 rounded-3xl p-6 border border-blue-100 relative overflow-hidden">
                            <div class="absolute -right-10 -top-10 w-40 h-40 bg-blue-100 rounded-full opacity-50">
                            </div>
                            <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                                <div class="bg-blue-600 p-6 rounded-2xl text-white shadow-lg shrink-0 text-center">
                                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-80 mb-1">Thông
                                        điệp</p>
                                    <h3 class="text-xl font-black uppercase">Nội dung chính</h3>
                                </div>
                                <div>
                                    <p class="text-gray-700 font-bold leading-relaxed">
                                        Bài đọc ca ngợi vẻ đẹp độc đáo của những búp chè trên cây cổ thụ ở Tà Xùa với
                                        những nét đặc trưng về búp, lá và vị chè. Qua đó, tác giả khắc họa tình yêu quê
                                        hương tha thiết và ước mơ đẹp đẽ của bạn nhỏ Thào A Sùng: mong muốn lan tỏa và
                                        giới thiệu sản vật quý giá của quê hương đến với mọi người khắp thế giới.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Cột phải (30%) - Tìm hiểu bài -->
                <aside class="w-full lg:w-[30%]">
                    <div class="bg-yellow-50 rounded-[30px] shadow-sm border border-yellow-100 p-4 sticky top-20">
                        <!-- Ảnh minh họa -->
                        <div class="mb-6 -mt-2">
                            <img src="hinh_anh/nhungbupche.png" alt="Minh họa"
                                class="w-full h-auto rounded-3xl object-contain drop-shadow-xl transform hover:scale-105 transition-transform duration-500">
                        </div>
                        <h2 class="text-xl font-black text-blue-900 mb-4 flex items-center">
                            <span class="w-10 h-10 bg-yellow-400 rounded-xl flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </span>
                            Tìm hiểu bài
                        </h2>

                        <div class="space-y-4">
                            <!-- Câu 1 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-4 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">1.
                                        Thào A Sùng kể những gì về quê hương?</span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content px-4">
                                    <div class="text-sm text-gray-600 border-t border-gray-50 pt-2">
                                        <span class="text-green-600 font-bold">Trả lời:</span> Thào A Sùng kể về bản
                                        làng Tà Xùa quê hương cậu, về những cây chè cổ thụ cao lớn ở đó với giọng tự
                                        hào. Cậu luôn trăn trở vì còn ít người biết đến chè Tà Xùa.
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 2 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-4 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">2.
                                        Sùng giới thiệu thế nào về chè Tà Xùa?</span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content px-4">
                                    <div class="text-sm text-gray-600 border-t border-gray-50 pt-2">
                                        <span class="text-green-600 font-bold">Trả lời:</span>
                                        <ul class="list-disc ml-4 space-y-1">
                                            <li><b>Cây chè:</b> Mọc trên những cây cổ thụ cao lớn.</li>
                                            <li><b>Búp chè:</b> Búp chè to, dưới lá có lớp lông tơ mịn, trắng như tuyết.
                                            </li>
                                            <li><b>Nước chè:</b> Có màu vàng ánh xanh, thơm ngan ngát; ban đầu hơi chát,
                                                sau đọng vị ngọt.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 3 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-4 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">3.
                                        Thào A Sùng mơ ước điều gì?</span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content px-4">
                                    <div class="text-sm text-gray-600 border-t border-gray-50 pt-2">
                                        <span class="text-green-600 font-bold">Trả lời:</span> Mơ ước làm kĩ sư nông
                                        nghiệp để giúp bản trồng nhiều chè hơn và mang chè Tà Xùa đi khắp thế giới. Chi
                                        tiết: cậu cười, ánh mắt tràn ngập khát khao khi trả lời.
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 4 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-4 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">4.
                                        Vì sao các bạn quên mất cuộc thi?</span>
                                    <svg class="w-4 h-4 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content px-4">
                                    <div class="text-sm text-gray-600 border-t border-gray-50 pt-2">
                                        <span class="text-green-600 font-bold">Trả lời:</span> Vì các bạn bị cuốn hút
                                        bởi lời giới thiệu đầy tự hào và hấp dẫn của Sùng, nhận ra mình còn biết ít về
                                        sản vật quê hương và muốn tìm hiểu thêm.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- TAB 2: LUYỆN TẬP -->
        <div id="tab-quiz" class="tab-content">
            <div
                class="max-w-4xl mx-auto bg-white rounded-[32px] shadow-xl border border-blue-100 overflow-hidden min-h-[500px] flex flex-col">
                <!-- Registration -->
                <div id="quiz-registration"
                    class="p-8 md:p-12 flex flex-col items-center justify-center flex-grow text-center">
                    <div
                        class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl flex items-center justify-center text-white mb-6 shadow-xl shadow-blue-200 transform -rotate-3">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-black text-gray-800 mb-3 tracking-tight">Đăng ký luyện tập</h2>
                    <p class="text-gray-500 mb-10 max-w-sm font-bold">Hãy điền thông tin để bắt đầu thử thách kiến thức
                        nhé!</p>

                    <form onsubmit="startQuiz(event)" class="w-full max-w-sm space-y-5">
                        <div class="relative group">
                            <input type="text" id="studentName" required placeholder="Họ và tên của em"
                                class="w-full px-6 py-4 rounded-2xl bg-white/50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold placeholder:text-gray-300 shadow-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <select id="studentClass" required
                                class="px-6 py-4 rounded-2xl bg-white/50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none">
                                <option value="">Chọn Lớp</option>
                                <option value="5/1">5/1</option>
                                <option value="5/2">5/2</option>
                                <option value="5/3">5/3</option>
                                <option value="5/4">5/4</option>
                                <option value="5/5">5/5</option>
                            </select>

                            <select id="schoolSelect" required onchange="checkSchool()"
                                class="px-6 py-4 rounded-2xl bg-white/50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none">
                                <option value="Tiểu học Đỗ Văn Nại">TH Đỗ Văn Nại</option>
                                <option value="Khác">Trường khác...</option>
                            </select>
                        </div>

                        <input type="text" id="otherSchool" placeholder="Tên trường của em"
                            class="hidden w-full px-6 py-4 rounded-2xl bg-white/50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all font-bold shadow-sm">

                        <button type="submit"
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-lg uppercase tracking-wider">
                            Bắt đầu ngay
                        </button>
                    </form>
                </div>

                <!-- Quiz Engine -->
                <div id="quiz-container" class="hidden flex-grow flex flex-col">
                    <div class="bg-blue-50 px-8 py-4 flex justify-between items-center border-b border-blue-100">
                        <div class="flex items-center">
                            <span
                                class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center font-black mr-3 shadow-md"
                                id="questionNum">1</span>
                            <div id="quiz-feedback" class="text-sm font-black transition-all opacity-0 ml-4"></div>
                            <p class="font-black text-blue-900 uppercase tracking-wider text-sm" id="progressText">
                                Đang thực hiện: 1/15</p>
                        </div>
                        <div
                            class="text-blue-600 font-bold text-sm bg-white px-4 py-2 rounded-full shadow-sm border border-blue-100">
                            Chè cổ thụ Tà Xùa
                        </div>
                    </div>

                    <div class="p-8 md:p-12 flex-grow">
                        <h3 class="text-2xl font-black text-gray-800 mb-8 leading-tight" id="questionText">Câu hỏi?</h3>
                        <div class="grid grid-cols-1 gap-4" id="optionsArea">
                            <!-- Options -->
                        </div>
                    </div>

                    <div class="p-8 border-t border-gray-50 flex justify-end">
                        <button id="nextBtn" disabled
                            class="bg-blue-600 disabled:opacity-30 hover:bg-blue-700 text-white font-black py-4 px-12 rounded-2xl shadow-lg transition-all active:scale-95">
                            CÂU TIẾP THEO
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="quiz-results"
                    class="hidden p-8 md:p-12 flex-grow flex flex-col items-center justify-center text-center">
                    <div class="relative w-48 h-48 mb-6">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="96" cy="96" r="80" stroke="currentColor" stroke-width="12" fill="transparent"
                                class="text-gray-100" />
                            <circle id="scoreCircle" cx="96" cy="96" r="80" stroke="currentColor" stroke-width="12"
                                fill="transparent" class="text-blue-500" stroke-dasharray="0, 100"
                                stroke-linecap="round" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-5xl font-black text-gray-800" id="scoreText">0</span>
                            <span class="text-gray-400 font-bold uppercase tracking-widest text-xs italic">Điểm
                                số</span>
                        </div>
                    </div>

                    <h2 class="text-3xl font-black text-gray-800 mb-2" id="resultTitle">Hoàn thành bài tập!</h2>
                    <p class="text-gray-500 mb-10 max-w-md font-medium" id="resultMsg">
                    <div class="mb-8 text-blue-600 font-black text-sm uppercase tracking-widest mt-4">Tự động quay lại
                        sau <span id="countdown">5</span> giây</div>Em đã nỗ lực hết mình rồi đấy!
                    </p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-md">
                        <button onclick="restartQuiz()"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-black py-4 rounded-2xl transition-all">LÀM
                            LẠI</button>
                        <button onclick="submitResults(event)"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-200 transition-all">NỘP
                            KẾT QUẢ</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Teacher Stats -->
    <div id="statsModal" class="modal">
        <div class="bg-white rounded-[32px] w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl m-4">
            <div class="p-6 border-b flex justify-between items-center bg-blue-50">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-black text-blue-900">Bảng kết quả học tập</h2>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="exportToExcel()"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl text-sm flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg> Xuất Excel
                    </button>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow overflow-auto p-6 bg-gray-50">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="text-left text-gray-500 uppercase text-xs font-black tracking-widest border-b pb-4">
                            <th class="p-4">STT</th>
                            <th class="p-4">Họ và Tên</th>
                            <th class="p-4">Lớp</th>
                            <th class="p-4">Trường</th>
                            <th class="p-4 text-center">Điểm số</th>
                            <th class="p-4 text-center">Thời gian</th>
                            <th class="p-4 text-right">Ngày nộp</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="py-5 px-4 mt-12 bg-white/30 backdrop-blur-md border-t border-white/50">
        <div class="container mx-auto text-center">
            <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em]">@ 2026 EduRobot - Hệ thống học
                tập thông minh</p>
            <p class="text-xs font-bold text-blue-600 mt-2">Phát triển bởi Lê Thành Long</p>
        </div>
    </footer>

    <script>

        function celebrate() {
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#2563eb', '#f59e0b', '#10b981', '#ef4444'] });
            const audio = document.getElementById('clapSound');
            if (audio) { audio.currentTime = 0; audio.play().catch(e => { }); }
        }

        /* UI LOGIC */
        function toggleAccordion(button) {
            const item = button.parentElement;
            const isOpen = item.classList.contains('accordion-open');
            document.querySelectorAll('.accordion-item').forEach(el => el.classList.remove('accordion-open'));
            if (!isOpen) item.classList.add('accordion-open');
        }

        const audio = document.getElementById('lessonAudio');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const audioStatus = document.getElementById('audioStatus');

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                audioStatus.innerText = "Đang phát...";
                audioStatus.classList.replace('text-gray-400', 'text-green-500');
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.innerText = "Đang dừng...";
                audioStatus.classList.replace('text-green-500', 'text-gray-400');
            }
        }

        audio.onended = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.innerText = "Đang dừng...";
            audioStatus.classList.replace('text-green-500', 'text-gray-400');
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('btn-' + tabId).classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        /* FIREBASE & TEACHER STATS */
        const firebaseConfig = {
            apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
            authDomain: "gamhoctap.firebaseapp.com",
            databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gamhoctap",
            storageBucket: "gamhoctap.firebasestorage.app",
            messagingSenderId: "833329613932",
            appId: "1:833329613932:web:0d8574827bcfe50b535c49",
            measurementId: "G-YT1PKCYS67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function openTeacherStats() {
            const pin = prompt("Vui lòng nhập mã PIN giáo viên:");
            if (pin === 'dvn') {
                document.getElementById('statsModal').classList.add('active');
                loadStats();
            } else if (pin !== null) alert("Mã PIN không chính xác!");
        }

        function closeModal() { document.getElementById('statsModal').classList.remove('active'); }

        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">Đang tải dữ liệu...</td></tr>';
            try {
                const snapshot = await db.collection("diem_tieng_viet_lop5").where("lessonTitle", "==", "Những búp chè trên cây cổ thụ").get();
                tbody.innerHTML = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">Chưa có dữ liệu học tập.</td></tr>';
                    return;
                }
                const results = [];
                snapshot.forEach(doc => results.push(doc.data()));
                results.sort((a, b) => (b.submittedAt?.seconds || 0) - (a.submittedAt?.seconds || 0));

                results.forEach((data, index) => {
                    const date = data.submittedAt ? data.submittedAt.toDate().toLocaleString('vi-VN') : '---';
                    let duration = '---';
                    if (data.startTime && data.endTime) {
                        const diffMs = new Date(data.endTime) - new Date(data.startTime);
                        duration = `${Math.floor(diffMs / 60000)} phút ${Math.floor((diffMs % 60000) / 1000)} giây`;
                    }
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 transition-colors border-b border-gray-50 text-sm";
                    tr.innerHTML = `
                        <td class="p-4 font-bold text-gray-400">${index + 1}</td>
                        <td class="p-4 font-bold text-gray-800">${data.studentName}</td>
                        <td class="p-4 text-gray-600">${data.className}</td>
                        <td class="p-4 text-gray-600">${data.school}</td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 rounded-full font-black ${data.score >= 80 ? 'bg-green-100 text-green-700' : data.score >= 50 ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}">${data.score}/100</span>
                        </td>
                        <td class="p-4 text-center text-gray-600 font-bold">${duration}</td>
                        <td class="p-4 text-right text-xs text-gray-400 font-bold">${date}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-red-500">Lỗi khi tải dữ liệu.</td></tr>'; }
        }

        function exportToExcel() {
            const dataToExport = currentStatsData.map((item, index) => ({
                'STT': index + 1,
                'Họ và Tên': item.studentName,
                'Lớp': item.studentClass,
                'Trường': item.school,
                'Điểm cao nhất': item.bestScore,
                'Số lần làm': item.attempts,
                'Thời gian làm bài (Lần tốt nhất)': item.timeDisplay || 'N/A',
                'Lần nộp cuối': item.latestSubmitted.toLocaleString('vi-VN')
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Kết quả");
            const fileName = `KetQua_${document.title.replace(' - EduRobot', '').replace(/[^a-zA-Z0-9]/g, '_')}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        /* QUIZ ENGINE */
        const allQuestions = [
            { q: "Nhân vật Thào A Sùng trong bài là người dân tộc nào?", a: ["Dân tộc Thái", "Dân tộc Mông", "Dân tộc Dao", "Dân tộc Mường"], c: 1 },
            { q: "Quê hương của Thào A Sùng ở đâu?", a: ["Mộc Châu, Sơn La", "Bản Tà Xùa, huyện Bắc Yên", "Sa Pa, Lào Cai", "Đồng Văn, Hà Giang"], c: 1 },
            { q: "Thái độ của Sùng khi kể về những cây chè cổ thụ quê mình là gì?", a: ["Buồn bã", "Lo lắng", "Tự hào", "Ngại ngùng"], c: 2 },
            { q: "Điều gì khiến Sùng luôn cảm thấy trăn trở về đặc sản quê hương?", a: ["Vì chè bị sâu bệnh", "Vì còn ít người biết đến chè Tà Xùa", "Vì giá chè quá rẻ", "Vì không ai biết trồng chè"], c: 1 },
            { q: "Cuộc thi mà các bạn học sinh tham gia có tên là gì?", a: ["Bảy sắc cầu vồng", "Rung chuông vàng", "Đường lên đỉnh Olympia", "Em yêu Tiếng Việt"], c: 0 },
            { q: "Câu hỏi quyết định trong cuộc thi hỏi về sản vật nào?", a: ["Một loại bánh đặc sản", "Một loài hoa quý", "Một loại chè rất ngon của quê hương Bắc Yên", "Một loại gạo nếp nương"], c: 2 },
            { q: "Búp chè Tà Xùa được miêu tả có đặc điểm gì đặc biệt?", a: ["Búp nhỏ, màu tím ngắt", "Búp to, dưới lá có lớp lông tơ mịn, trắng như tuyết", "Búp dài, nhọn và không có lông", "Búp màu đỏ tía, lá dày"], c: 1 },
            { q: "Cây chè ở Tà Xùa có hình dáng như thế nào?", a: ["Là những bụi cây thấp ngang lưng người", "Là những cây cổ thụ cao lớn", "Là những dây leo trên giàn", "Là những cây thân cỏ mọc sát đất"], c: 1 },
            { q: "Nước chè Tà Xùa khi pha ra có màu sắc và hương thơm như thế nào?", a: ["Màu đỏ đậm, không mùi", "Màu vàng ánh xanh, thơm ngan ngát", "Màu nâu nhạt, mùi hắc", "Màu xanh ngắt, thơm mùi hoa nhài"], c: 1 },
            { q: "Vị của chè Tà Xùa được Sùng miêu tả ra sao?", a: ["Ngọt lịm ngay từ đầu", "Ban đầu hơi chát, sau đó đọng lại là vị ngọt", "Rất đắng, khó uống", "Chua thanh và mát"], c: 1 },
            { q: "Ước mơ nghề nghiệp trong tương lai của Thào A Sùng là gì?", a: ["Trở thành hướng dẫn viên du lịch", "Trở thành thầy giáo", "Trở thành kĩ sư nông nghiệp", "Trở thành nhà kinh doanh"], c: 2 },
            { q: "Mục đích chính trong ước mơ của Sùng là gì?", a: ["Để làm giàu cho bản thân", "Giúp bản trồng nhiều chè hơn và mang chè đi khắp thế giới", "Để được đi du lịch nhiều nơi", "Để chiến thắng trong cuộc thi"], c: 1 },
            { q: "Phản ứng của mọi người trong hội trường sau câu trả lời của Sùng là gì?", a: ["Im lặng lắng nghe", "Cười chê ước mơ của Sùng", "Vỗ tay rộ lên, quên mất cuộc thi và xôn xao hỏi về cây chè", "Yêu cầu ban giám khảo chấm điểm ngay"], c: 2 },
            { q: "Mẹ của nhân vật \"tôi\" đã quyết định làm gì sau khi nghe chuyện?", a: ["Mời Sùng đến nhà ăn cơm", "Đặt mua chè qua mạng", "Ngày mai sẽ đến Tà Xùa ngay để mua chè", "Đi học cách pha chè"], c: 2 },
            { q: "Nội dung chính của bài đọc muốn ca ngợi điều gì?", a: ["Ca ngợi tài năng hùng biện của bạn Sùng", "Ca ngợi vẻ đẹp của chè Tà Xùa và tình yêu, khát vọng lan tỏa sản vật quê hương của bạn nhỏ", "Ca ngợi cảnh đẹp hùng vĩ của núi rừng Tây Bắc", "Ca ngợi sự kịch tính của cuộc thi kiến thức"], c: 1 }
        ];

        let studentData = {}, currentQuizQuestions = [], currentQuestionIdx = 0, score = 0, selectedOption = null;

        function checkSchool(s) { document.getElementById('otherSchool').classList.toggle('hidden', s.value !== 'other'); }

        document.getElementById('regForm').onsubmit = (e) => {
            e.preventDefault();
            studentData = {
                studentName: document.getElementById('studentName').value,
                className: document.getElementById('studentClass').value,
                school: document.getElementById('schoolSelect').value === 'other' ? document.getElementById('otherSchool').value : document.getElementById('schoolSelect').value,
                startTime: new Date().toISOString()
            };
            document.getElementById('quiz-registration').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            startQuiz();
        };

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function startQuiz() {
            currentQuizQuestions = shuffle([...allQuestions]).slice(0, 5);
            currentQuestionIdx = 0; score = 0; showQuestion();
        }

        function showQuestion() {
            const q = currentQuizQuestions[currentQuestionIdx];
            document.getElementById('questionNum').innerText = currentQuestionIdx + 1;
            document.getElementById('progressText').innerText = `Đang thực hiện: ${currentQuestionIdx + 1}/5`;
            document.getElementById('questionText').innerText = q.q;
            const area = document.getElementById('optionsArea'); area.innerHTML = '';
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option w-full p-4 rounded-2xl text-left font-bold text-gray-700 flex items-center group border-2 border-transparent bg-gray-50 hover:bg-blue-50 transition-all';
                btn.innerHTML = `<span class="w-8 h-8 rounded-lg bg-white flex items-center justify-center mr-4 shadow-sm group-hover:bg-blue-100">${String.fromCharCode(65 + i)}</span><span class="flex-1">${opt}</span>`;
                btn.onclick = () => {
                    const currentQ = currentQuizQuestions[currentQuestionIdx];
                    const isCorrect = i === currentQ.c;
                    const feedback = document.getElementById('quiz-feedback');
                    document.querySelectorAll('#optionsArea button').forEach(b => b.disabled = true);
                    if (isCorrect) {
                        btn.classList.add('bg-green-50', 'border-green-500');
                        btn.querySelector('div, span').classList.add('bg-green-600', 'text-white');
                        if (feedback) { feedback.innerText = "CHÍNH XÁC! 🎉"; feedback.classList.add('text-green-600'); }
                        score += 20;
                    } else {
                        btn.classList.add('bg-red-50', 'border-red-500');
                        btn.querySelector('div, span').classList.add('bg-red-600', 'text-white');
                        if (feedback) { feedback.innerText = "SAI RỒI! ❌"; feedback.classList.add('text-red-600'); }
                        const correctBtn = document.querySelectorAll('#optionsArea button')[currentQ.c];
                        if (correctBtn) correctBtn.classList.add('bg-green-50', 'border-green-500');
                    }
                    if (feedback) feedback.style.opacity = '1';
                    setTimeout(() => {
                        currentQuestionIdx++;
                        (currentQuestionIdx < 5) ? showQuestion() : showResults();
                    }, 1000);
                };;;
                area.appendChild(btn);
            });
            document.getElementById('nextBtn').disabled = true; selectedOption = null;
        }

        document.getElementById('nextBtn').onclick = () => {
            if (selectedOption === currentQuizQuestions[currentQuestionIdx].c) score += 20;
            currentQuestionIdx++;
            if (currentQuestionIdx < 5) showQuestion(); else showResults();
        };

        function showResults() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('scoreText').innerText = score;
            document.getElementById('scoreCircle').setAttribute('stroke-dasharray', `${score}, 100`);
            const title = document.getElementById('resultTitle'), msg = document.getElementById('resultMsg');
            if (score >= 90) { title.innerText = "Xuất sắc!"; msg.innerText = "Em thật sự là một chuyên gia về chè Tà Xùa!"; }
            else if (score >= 70) { title.innerText = "Rất tốt!"; msg.innerText = "Em hiểu rất rõ về niềm tự hào của bạn Sùng!"; }
            else { title.innerText = "Cần cố gắng!"; msg.innerText = "Hãy đọc kĩ lại bài để hiểu thêm về cây chè cổ thụ nhé!"; }
        }

        function restartQuiz() { document.getElementById('quiz-results').classList.add('hidden'); document.getElementById('quiz-registration').classList.remove('hidden'); }


        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            document.getElementById('successModal').classList.add('hidden');
            restartQuiz();
            switchTab('lesson');
        }

        function submitResults(e) {
            if (e) e.preventDefault();
            const btn = e.target || document.querySelector('#quiz-results button:last-child');
            if (btn) { btn.innerHTML = "Đang nộp..."; btn.disabled = true; }
            const data = {
                studentName: document.getElementById('studentName').value,
                studentClass: document.getElementById('studentClass').value || studentData.studentClass || studentData.className,
                school: document.getElementById('schoolSelect').value === 'Khác' || document.getElementById('schoolSelect').value === 'other' ? document.getElementById('otherSchool').value : document.getElementById('schoolSelect').value,
                lessonTitle: "Những búp chè trên cây cổ thụ",
                score: score,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            let successShown = false;
            const showSuccess = () => {
                if (successShown) return;
                successShown = true;
                const modal = document.getElementById('successModal');
                if (modal) {
                    modal.classList.add('active');
                    modal.classList.remove('hidden');
                }
                celebrate();
                let timeLeft = 5;
                const countdownEl = document.getElementById('countdown');
                const timer = setInterval(() => {
                    timeLeft--;
                    if (countdownEl) countdownEl.innerText = timeLeft;
                    if (timeLeft <= 0) { clearInterval(timer); closeSuccessModal(); }
                }, 1000);
            };
            const dbTimeout = setTimeout(() => { if (!successShown) showSuccess(); }, 3000);
            db.collection("diem_tieng_viet_lop5").add(data).then(() => { clearTimeout(dbTimeout); showSuccess(); }).catch(e => { console.error(e); clearTimeout(dbTimeout); showSuccess(); });
        }
    </script>

    <audio id="clapSound" src="https://www.soundjay.com/human/applause-01.mp3" preload="auto"></audio>
    <script src="js/floating-menu.js"></script>
</body>

</html>
