<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hoa tháng Năm - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- SheetJS for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        .hidden {
            display: none !important;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
        }

        .bg-paper {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .tab-btn.active {
            color: var(--primary);
            background: white;
            box-shadow: inset 0 -3px 0 var(--primary);
        }

        .tab-content {
            display: none !important;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block !important;
        }

        #tab-quiz.active {
            display: flex !important;
        }

        /* Compact Quiz styles */
        #quiz-container {
            height: calc(100vh - 180px);
            /* Adjust based on header/footer */
            max-height: 600px;
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid #e2e8f0;
        }

        .option-btn:hover:not(:disabled) {
            transform: translateX(4px);
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option-btn.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Accordion Custom */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-open .accordion-content {
            max-height: 500px;
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .reading-content p {
            text-indent: 2rem;
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        /* Success Modal Styles */
        .success-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 200;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        .success-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .success-card {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .success-modal.active .success-card {
            transform: scale(1);
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="sticky top-0 z-50 px-4 py-2">
        <nav class="container mx-auto glass-card rounded-xl px-5 py-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-4">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 shrink-0">
                    <span class="text-xl font-black">E</span>
                </div>
                <div class="flex flex-col md:flex-row md:items-center md:space-x-6">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl font-black text-blue-700">EduRobot</span>
                        <span
                            class="text-[11px] font-bold px-3 py-1 rounded-full bg-orange-500 text-white shadow-sm shadow-orange-200 tracking-wide whitespace-nowrap">TIẾNG
                            VIỆT 5</span>
                    </div>

                    <div class="flex items-center space-x-2 overflow-hidden">
                        <span
                            class="text-[11px] font-black uppercase tracking-widest text-gray-400 whitespace-nowrap">CHỦ
                            ĐIỂM:</span>
                        <span
                            class="text-sm font-black uppercase tracking-wider text-blue-800 truncate max-w-[180px] md:max-w-none">VẺ
                            ĐẸP CUỘC SỐNG</span>
                    </div>
                </div>
            </div>
            <ul class="flex space-x-2 md:space-x-6 text-xs font-bold items-center relative">
                <!-- Home -->
                <li>
                    <a href="index.html"
                        class="flex items-center text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Trang chủ
                    </a>
                </li>

                <!-- Lessons Dropdown -->
                <li class="relative group">
                    <button id="top-menu-lesson-btn"
                        class="flex items-center text-gray-500 hover:text-blue-600 transition-colors focus:outline-none py-2">
                        Bài học
                        <svg class="w-4 h-4 ml-1 transition-transform duration-200" id="top-menu-chevron" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <!-- Dropdown Content (Hidden by default) -->
                    <div id="top-menu-lessons-dropdown"
                        class="absolute top-full right-[-100px] md:right-auto md:left-1/2 md:-translate-x-1/2 mt-4 w-[320px] bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 hidden max-h-[70vh] overflow-y-auto z-[60] p-2">
                        <!-- Content rendered by floating-menu.js -->
                    </div>
                </li>

                <!-- Teacher -->
                <li>
                    <button onclick="openTeacherStats()"
                        class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Giáo viên
                    </button>
                </li>

                <!-- Contact -->
                <li>
                    <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Liên hệ
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-2">

        <!-- Tab & Audio Header -->
        <div class="glass-card mb-4 rounded-2xl overflow-hidden flex flex-col md:flex-row items-stretch shadow-lg">
            <div class="flex-1 flex bg-white/40">
                <button onclick="switchTab('lesson')" id="btn-lesson"
                    class="tab-btn active flex-1 py-4 text-center font-black text-base text-gray-400 transition-all border-r border-gray-100/50 uppercase tracking-wider">
                    1. Bài học
                </button>
                <button onclick="switchTab('quiz')" id="btn-quiz"
                    class="tab-btn flex-1 py-4 text-center font-black text-base text-gray-400 transition-all uppercase tracking-wider">
                    2. Luyện tập
                </button>
            </div>

            <div id="audio-container"
                class="p-2 md:px-4 flex items-center bg-blue-50/20 border-t md:border-t-0 md:border-l border-gray-100/50">
                <div
                    class="flex items-center space-x-3 bg-white/60 backdrop-blur-md rounded-xl p-1.5 pr-4 border border-white shadow-inner">
                    <button id="audioControl" onclick="toggleAudio()"
                        class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center text-white hover:scale-105 active:scale-95 transition-all shadow-md shadow-blue-200">
                        <svg id="playIcon" class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col">
                        <span
                            class="text-[9px] font-black text-blue-600 uppercase tracking-widest leading-none mb-0.5 whitespace-nowrap">ĐỌC
                            MẪU</span>
                        <span id="audioStatus"
                            class="text-[10px] text-gray-400 font-bold italic leading-none whitespace-nowrap">Đang
                            dừng...</span>
                    </div>
                </div>
                <audio id="lessonAudio">
                    <source src="am_thanh/giohoathangnam.mp3" type="audio/mpeg">
                </audio>
            </div>
        </div>

        <!-- TAB 1: BÀI HỌC -->
        <div id="tab-lesson" class="tab-content active">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Cột trái (70%) - Bài đọc -->
                <section class="w-full lg:w-[70%]">
                    <div class="glass-card rounded-[40px] p-6 md:p-10 shadow-2xl">
                        <div
                            class="bg-paper rounded-[32px] p-8 md:p-12 shadow-inner border border-white/50 relative overflow-hidden">
                            <!-- Trang trí góc -->
                            <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-100/30 rounded-full blur-3xl"></div>
                            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-amber-100/30 rounded-full blur-3xl">
                            </div>

                            <h1 class="text-3xl font-black mb-6 text-blue-900 text-center uppercase tracking-tight">
                                Giỏ hoa tháng Năm
                            </h1>

                            <div class="serif-font text-gray-800 text-lg leading-relaxed relative reading-content">
                                <p class="mb-4">Với bọn trẻ chúng tôi, ngày lễ Mừng xuân vào tháng Năm luôn đáng mong
                                    chờ, bởi đó là dịp chúng tôi được vui đùa thoả thích. Chúng tôi thường bí mật làm
                                    những giỏ hoa rực rỡ, đặt lên bậc thềm nhà người quen hoặc bạn bè, gõ cửa rồi ba
                                    chân bốn cẳng chạy trốn thật nhanh. Từ xa, chúng tôi hồi hộp theo dõi chủ nhà mở
                                    cửa, cầm món quà lên với vẻ ngạc nhiên, thích thú.</p>
                                <p>
                                    Tôi còn nhớ lễ Mừng xuân năm tôi học lớp Năm. Lúc đó, tôi đang giận Pam, cô bạn thân
                                    nhất của mình. Từ nhỏ Pam và tôi đã thân nhau như hình với bóng. Gần đây, một gia
                                    đình mới dọn đến thị trấn của chúng tôi và Pam đã kết thân với con gái của họ. Mặc
                                    dù chúng tôi vẫn chơi với nhau, nhưng thời gian Pam dành cho tôi không còn nhiều như
                                    trước. Tôi cảm thấy như bị bỏ rơi. Giận Pam, tôi không chơi với bạn mấy ngày. Khi mẹ
                                    hỏi tôi có mang hoa cho Pam không, tôi trả lời: "Không bao giờ, mẹ ạ!". Mẹ dừng tay
                                    làm bếp, ôm tôi và an ủi. Cơn tủi thân bỗng dâng lên và tôi oà khóc nức nở. Mẹ dịu
                                    dàng vuốt tóc và lau nước mắt cho tôi. Mẹ bảo càng lớn, chúng tôi sẽ càng có nhiều
                                    bạn. Những người bạn không thể chỉ chơi với một mình tôi. Và ngay cả tôi cũng không
                                    thể chỉ chơi với một người bạn.
                                </p>
                                <p>
                                    Cuối cùng, tôi cũng quyết định tặng Pam một giỏ hoa. Tôi chọn thật nhiều hoa màu
                                    vàng mà Pam yêu thích, rồi nhờ chị tôi đem đến nhà bạn. Từ chỗ nấp, tôi thấy Pam
                                    nâng giỏ hoa lên, dịu dàng áp mặt vào những bông hoa và nói to như để tôi nghe được:
                                    "Cảm ơn Xu-di, hi vọng cậu không còn giận mình!".
                                </p>
                                <p>
                                    Lần ấy tôi học được rằng là bạn bè đích thực, ta sẽ đặt bạn trong tim nhưng không
                                    buộc họ luôn ở bên mình.
                                </p>
                                <p class="text-right italic font-bold text-gray-600 mt-6">(Theo Minh Hương)</p>
                            </div>
                        </div>

                        <!-- Nội dung chính -->
                        <div
                            class="mt-8 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[32px] p-8 text-white relative overflow-hidden shadow-xl transform hover:scale-[1.01] transition-transform">
                            <div
                                class="absolute right-0 top-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl">
                            </div>
                            <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                                <div
                                    class="bg-white/20 backdrop-blur-md p-6 rounded-2xl border border-white/30 shadow-lg shrink-0 text-center min-w-[160px]">
                                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-100 mb-1">
                                        Thông điệp</p>
                                    <h3 class="text-2xl font-black uppercase tracking-tight">Ý NGHĨA</h3>
                                </div>
                                <div class="flex-grow">
                                    <p class="text-lg font-bold leading-relaxed text-blue-50">
                                        Đã là bạn bè đích thực luôn có sự gắn bó thân thiết, chân thành, luôn ở bên
                                        nhau, quan tâm đến nhau dù không ở cạnh nhau thường xuyên nhưng tấm lòng luôn
                                        hướng về nhau, luôn trân trọng và có vị trí nhất định trong lòng mỗi người.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Cột phải (30%) - Tìm hiểu bài -->
                <aside class="w-full lg:w-[30%]">
                    <div class="glass-card rounded-[40px] p-6 sticky top-28 shadow-xl border-amber-100/50">
                        <!-- Ảnh minh họa -->
                        <div class="mb-6 -mt-2">
                            <img src="hinh_anh/giohoathangnam.png" alt="Minh họa"
                                class="w-full h-auto rounded-3xl object-contain drop-shadow-xl transform hover:scale-105 transition-transform duration-500">
                        </div>

                        <div class="flex items-center space-x-4 mb-8">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg shadow-amber-200">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-black text-gray-800 tracking-tight">Tìm hiểu bài</h2>
                        </div>

                        <div class="space-y-4">
                            <!-- Câu 1 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">1.
                                        Ngày lễ nào trong năm được các bạn nhỏ mong chờ? Việc làm nào trong ngày đó
                                        khiến các bạn thấy thú vị?</span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Ngày lễ được các bạn nhỏ mong chờ là ngày lễ mừng xuân
                                            vào tháng năm. Các bạn thường bí mật làm những giỏ hoa rực rỡ, đặt lên bậc
                                            thềm nhà người quen hoặc bạn bè, gõ cửa rồi ba chân bốn cẳng chạy trốn thật
                                            nhanh, hồi hộp theo dõi chủ nhà có cảm xúc như thế nào trước món quà đó.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 2 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">2.
                                        Bạn thân của Xu-di là ai? Vì sao Xu-di lại giận người bạn thân của mình?</span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Bạn thân của Xu-di là Pam. Xu-di giận người bạn thân của
                                            mình vì có một gia đình mới dọn đến thị trấn của hai người và Pam đã kết
                                            thân với con gái của gia đình đó, thời gian Pam dành cho Xu-di không còn
                                            nhiều như trước, Xu-di cảm thấy như bị bỏ rơi.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 3 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">3.
                                        Việc Xu-di vẫn quyết định tặng bạn giỏ hoa với nhiều bông màu vàng mà bạn yêu
                                        thích thể hiện điều gì?</span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Việc đó cho thấy Xu-di rất yêu quý Pam và hiểu sở thích
                                            của bạn.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 4 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">4.
                                        Người bạn của Xu-di đón nhận giỏ hoa như thế nào? Theo em, Xu-di có cảm nghĩ gì
                                        trước cử chỉ, lời nói của bạn lúc nhận giỏ hoa?</span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Pam nâng giỏ hoa lên, dịu dàng áp mặt vào những bông hoa
                                            và nói to như để Xu-di nghe được: "Cảm ơn Xu-di, hi vọng cậu không còn giận
                                            mình!". Chắc hẳn là Xu-di rất cảm động trước cử chỉ, lời nói của Pam lúc
                                            nhận hoa.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 5 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">5.
                                        Đoạn kết của câu chuyện muốn nói điều gì?</span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="font-medium">Đã là bạn bè đích thực luôn có sự gắn bó thân thiết, chân
                                            thành, luôn ở bên nhau, quan tâm đến nhau dù không ở cạnh nhau thường xuyên
                                            nhưng tấm lòng luôn hướng về nhau, luôn trân trọng và có vị trí nhất định
                                            trong lòng mỗi người.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- TAB 2: LUYỆN TẬP -->
        <div id="tab-quiz" class="tab-content">
            <div
                class="max-w-4xl mx-auto glass-card rounded-[40px] shadow-2xl overflow-hidden flex flex-col min-h-[500px]">
                                                <!-- Registration -->
                <div id="quiz-registration" class="p-8 md:p-12 flex flex-col items-center justify-center flex-grow text-center">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-3xl flex items-center justify-center text-white mb-6 shadow-xl shadow-blue-200 transform -rotate-3">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-black text-gray-800 mb-3 tracking-tight">Đăng ký luyện tập</h2>
                    <p class="text-gray-500 mb-10 max-w-sm font-bold">Hãy điền thông tin để bắt đầu thử thách kiến thức nhé!</p>

                    <form onsubmit="startQuiz(event)" class="w-full max-w-sm space-y-5">
                        <div class="relative group">
                            <input type="text" id="studentName" required placeholder="Họ và tên của em" class="w-full px-6 py-4 rounded-2xl bg-white/50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold placeholder:text-gray-300 shadow-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <select id="studentClass" required class="px-6 py-4 rounded-2xl bg-white/50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none">
                                <option value="">Chọn Lớp</option>
                                <option value="5/1">5/1</option>
                                <option value="5/2">5/2</option>
                                <option value="5/3">5/3</option>
                                <option value="5/4">5/4</option>
                                <option value="5/5">5/5</option>
                            </select>

                            <select id="schoolSelect" required onchange="checkSchool()" class="px-6 py-4 rounded-2xl bg-white/50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none">
                                <option value="Tiểu học Đỗ Văn Nại">TH Đỗ Văn Nại</option>
                                <option value="Khác">Trường khác...</option>
                            </select>
                        </div>

                        <input type="text" id="otherSchool" placeholder="Tên trường của em" class="hidden w-full px-6 py-4 rounded-2xl bg-white/50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all font-bold shadow-sm">

                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-lg uppercase tracking-wider">
                            Bắt đầu ngay
                        </button>
                    </form>
                </div>

                <!-- Quiz Engine - COMPACT VERSION -->
                <div id="quiz-container" class="hidden flex-grow flex flex-col">
                    <div class="bg-blue-600/5 px-6 py-4 flex justify-between items-center border-b border-blue-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center font-black mr-4 shadow-lg shadow-blue-200"
                                id="questionNum">1</div>
                            <div class="flex flex-col">
                                <span
                                    class="text-[10px] font-black text-blue-600 uppercase tracking-widest leading-none mb-1"
                                    id="progressText">CÂU TRẮC NGHIỆM: 1/5</span>
                                <span class="text-xs text-gray-400 font-bold leading-none">Giỏ hoa tháng Năm</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 flex-grow flex flex-col justify-center overflow-auto">
                        <h3 class="text-xl md:text-2xl font-black text-gray-800 mb-6 leading-tight transition-all"
                            id="questionText">Nội dung câu hỏi?</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="optionsArea">
                            <!-- Options rendered by JS -->
                        </div>
                    </div>

                    <div class="px-6 py-4 border-t border-gray-50 flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold text-gray-400 italic">* Chọn đáp án đúng nhất để tiếp tục</span>
                        <div id="quiz-feedback" class="text-sm font-black transition-all opacity-0"></div>
                        <button id="nextBtn" disabled
                            class="bg-blue-600 disabled:opacity-30 hover:bg-blue-700 text-white font-black py-3 px-10 rounded-2xl shadow-lg shadow-blue-100 transition-all active:scale-95 uppercase text-sm tracking-widest">
                            Câu tiếp theo
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="quiz-results"
                    class="hidden p-8 flex-grow flex flex-col items-center justify-center text-center">
                    <div class="relative w-40 h-40 mb-8">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="80" cy="80" r="74" stroke="currentColor" stroke-width="12" fill="transparent"
                                class="text-gray-100" />
                            <circle id="scoreCircle" cx="80" cy="80" r="74" stroke="url(#scoreGrad)" stroke-width="12"
                                fill="transparent" class="transition-all duration-1000 ease-out"
                                stroke-dasharray="0, 465" stroke-linecap="round" />
                            <defs>
                                <linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#3b82f6" />
                                    <stop offset="100%" stop-color="#818cf8" />
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-5xl font-black text-gray-800" id="scoreText">0</span>
                            <span class="text-[10px] text-gray-400 font-black uppercase tracking-[0.2em] mt-1">Điểm
                                số</span>
                        </div>
                    </div>

                    <h2 class="text-3xl font-black text-gray-800 mb-2" id="resultTitle">Hoàn thành bài tập!</h2>
                    <p class="text-gray-500 mb-10 max-w-sm font-bold" id="resultMsg">Em đã nỗ lực hết mình rồi đấy!</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-md">
                        <button onclick="restartQuiz()"
                            class="bg-white hover:bg-gray-50 text-gray-700 font-black py-4 rounded-2xl border-2 border-gray-100 transition-all shadow-sm">LÀM
                            LẠI</button>
                        <button onclick="submitResults(event)"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all">NỘP
                            KẾT QUẢ</button>
                    </div>
                </div>
            </div>
        </div>


    </main>

    <!-- Modal Teacher Stats -->
    <div id="statsModal" class="modal">
        <div
            class="bg-white rounded-[40px] w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl m-4 transform transition-all">
            <div class="p-8 border-b flex justify-between items-center bg-gray-50/50 backdrop-blur-xl">
                <div class="flex items-center space-x-4">
                    <div
                        class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-gray-800 tracking-tight">Bảng kết quả học tập</h2>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Dành riêng cho giáo
                            viên</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="exportToExcel()"
                        class="bg-green-600 hover:bg-green-700 text-white font-black py-3 px-6 rounded-2xl text-sm flex items-center shadow-lg shadow-green-100 transition-all active:scale-95">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg> XUẤT EXCEL
                    </button>
                    <button onclick="closeModal()"
                        class="w-12 h-12 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-2xl transition-all">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow overflow-auto p-8 bg-gray-50/30">
                <table class="w-full">
                    <thead>
                        <tr
                            class="text-left text-gray-400 uppercase text-[10px] font-black tracking-[0.2em] border-b-2 border-gray-100 pb-4">
                            <th class="px-6 py-4">STT</th>
                            <th class="px-6 py-4">Họ và Tên</th>
                            <th class="px-6 py-4">Lớp</th>
                            <th class="px-6 py-4">Trường</th>
                            <th class="px-6 py-4 text-center">Điểm</th>
                            <th class="px-6 py-4 text-center">Lần</th>
                            <th class="px-6 py-4 text-center">Thời gian</th>
                            <th class="px-6 py-4 text-right">Hoàn thành</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="divide-y divide-gray-100">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal">
        <div class="glass-card success-card rounded-[40px] p-10 max-w-sm w-full text-center shadow-3xl border-white/50">
            <div
                class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-xl shadow-green-100 transform rotate-6 scale-110">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-3xl font-black text-gray-800 mb-2 tracking-tight">Nộp bài thành công!</h2>
            <p class="text-gray-500 mb-10 font-bold leading-relaxed">Chúc mừng em đã hoàn thành thử thách kiến thức!</p>
            <div class="mb-8 text-blue-600 font-black text-sm uppercase tracking-widest">Tự động quay lại sau <span id="countdown">5</span> giây</div>
            <button onclick="closeSuccessModal()"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 uppercase tracking-widest text-sm">
                Trở về bài học
            </button>
        </div>
    </div>

    <footer class="py-5 px-4 mt-12 bg-white/30 backdrop-blur-md border-t border-white/50">
        <div class="container mx-auto text-center">
            <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em]">@ 2026 EduRobot - Hệ thống học
                tập thông minh</p>
            <p class="text-xs font-bold text-blue-600 mt-2">Phát triển bởi Lê Thành Long</p>
        </div>
    </footer>

    <script>
        function celebrate() { 
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#2563eb', '#f59e0b', '#10b981', '#ef4444'] }); 
            const audio = document.getElementById('clapSound');
            if (audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
        }
        // --- 1. CONFIG & DATA ---
        const firebaseConfig = {
            databaseURL: "https://gamhoctap-default-rtdb.firebaseio.com/",
            projectId: "gamhoctap",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const allQuestions = [
            { q: "Ngày lễ Mừng xuân vào tháng Năm các bạn nhỏ thường làm gì?", a: ["Làm những giỏ hoa rực rỡ mang tặng người thân, bạn bè", "Đi du xuân cùng bố mẹ", "Tổ chức cắm trại ở trường", "Đi mua sắm quần áo mới"], c: 0 },
            { q: "Các bạn nhỏ tặng hoa cho người thân, bạn bè bằng cách nào?", a: ["Gửi qua bưu điện", "Đưa tận tay chủ nhà", "Đặt lên bậc thềm, gõ cửa rồi ba chân bốn cẳng chạy trốn", "Nhờ bố mẹ mang đến tặng"], c: 2 },
            { q: "Tại sao Xu-di lại giận Pam?", a: ["Vì Pam không tặng hoa cho Xu-di", "Vì Pam có thêm bạn mới và không dành nhiều thời gian cho Xu-di", "Vì Pam làm hỏng đồ chơi của Xu-di", "Vì Pam chuyển nhà đi nơi khác"], c: 1 },
            { q: "Khi thấy Xu-di buồn vì giận bạn, mẹ đã làm gì?", a: ["Mắng Xu-di vì tính hay dỗi", "Khuyên Xu-di nên tìm bạn mới", "Ôm ấp, an ủi và khuyên nhủ Xu-di về tình bạn", "Bảo Xu-di không nên chơi với Pam nữa"], c: 2 },
            { q: "Theo lời mẹ, Xu-di đã học được điều gì về tình bạn?", a: ["Càng lớn sẽ càng có nhiều bạn, không thể chỉ chơi với một người", "Bạn bè phải luôn ở bên cạnh nhau mọi lúc mợi nơi", "Chỉ nên chơi với một người bạn thân duy nhất", "Không nên giận dỗi bạn bè lâu"], c: 0 },
            { q: "Xu-di đã tặng Pam giỏ hoa có màu gì?", a: ["Màu đỏ", "Màu xanh", "Màu vàng", "Màu tím"], c: 2 },
            { q: "Tại sao Xu-di lại chọn hoa màu đó để tặng Pam?", a: ["Vì đó là màu hoa mẹ Xu-di thích", "Vì đó là màu hoa Pam yêu thích", "Vì trong vườn chỉ có duy nhất loại hoa đó", "Vì hoa đó rẻ nhất"], c: 1 },
            { q: "Pam đã làm gì khi nhận được giỏ hoa của Xu-di?", a: ["Mang vào nhà cất ngay", "Nâng giỏ hoa lên, áp mặt vào hoa và nói lời cảm ơn", "Chia cho người bạn mới cùng ngắm", "Cất vào một góc vì vẫn còn giận Xu-di"], c: 1 },
            { q: "Câu nói: 'hi vọng cậu không còn giận mình' của Pam cho thấy điều gì?", a: ["Pam không biết Xu-di đang giận", "Pam rất trân trọng tình bạn với Xu-di và mong muốn làm hòa", "Pam muốn Xu-di phải xin lỗi mình", "Pam đang trêu chọc Xu-di"], c: 1 },
            { q: "Bài học quan trọng nhất về tình bạn mà Xu-di rút ra ở cuối truyện là gì?", a: ["Phải luôn tặng quà cho bạn vào các ngày lễ", "Bạn bè đích thực là đặt bạn trong tim nhưng không buộc họ luôn ở bên mình", "Chỉ nên chơi với những người bạn thích hoa màu vàng", "Không bao giờ được giận bạn thân"], c: 1 },
            { q: "Từ 'bí mật' trong câu 'Chúng tôi thường bí mật làm những giỏ hoa rực rỡ' thuộc từ loại nào?", a: ["Danh từ", "Động từ", "Tính từ", "Trạng từ"], c: 2 },
            { q: "Từ 'rực rỡ' trong bài có nghĩa là gì?", a: ["Có màu sắc tươi sáng, đẹp mắt và nổi bật", "Có mùi thơm ngào ngạt", "Rất to lớn", "Rất đắt tiền"], c: 0 },
            { q: "Trong câu 'Tôi và Pam thân nhau như hình với bóng', tác giả sử dụng biện pháp nghệ thuật gì?", a: ["Nhân hóa", "So sánh", "Điệp ngữ", "Đảo ngữ"], c: 1 },
            { q: "Từ nào đồng nghĩa với từ 'đích thực'?", a: ["Giả tạo", "Chân thực", "Hờ hững", "Tạm thời"], c: 1 },
            { q: "Câu văn 'Mẹ dịu dàng vuốt tóc và lau nước mắt cho tôi' thuộc kiểu câu nào?", a: ["Câu kể", "Câu hỏi", "Câu cảm", "Câu khiến"], c: 0 }
        ];

        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let startTime;
        let endTime;

        // --- 2. UI LOGIC ---
        function toggleAccordion(btn) {
            const item = btn.parentElement;
            const isOpen = item.classList.contains('accordion-open');
            document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('accordion-open'));
            if (!isOpen) item.classList.add('accordion-open');
        }

        const audio = document.getElementById('lessonAudio');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const audioStatus = document.getElementById('audioStatus');

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                audioStatus.innerText = "Đang phát...";
                audioStatus.classList.add('text-blue-600');
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.innerText = "Đang dừng...";
                audioStatus.classList.remove('text-blue-600');
            }
        }

        audio.onended = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.innerText = "Đã phát xong";
        };

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('btn-' + tab).classList.add('active');
        }

        // --- 3. QUIZ ENGINE ---
        function checkSchool() {
            const select = document.getElementById('schoolSelect');
            const otherInput = document.getElementById('otherSchool');
            if (select.value === 'Khác') {
                otherInput.classList.remove('hidden');
                otherInput.required = true;
            } else {
                otherInput.classList.add('hidden');
                otherInput.required = false;
            }
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function startQuiz(e) {
            e.preventDefault();
            startTime = new Date();
            currentQuestions = shuffle([...allQuestions]).slice(0, 5);
            currentQuestionIndex = 0;
            score = 0;
            document.getElementById('quiz-registration').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            if(document.getElementById('quiz-feedback')) document.getElementById('quiz-feedback').style.opacity = '0';
            const q = currentQuestions[currentQuestionIndex];
            document.getElementById('questionNum').innerText = currentQuestionIndex + 1;
            document.getElementById('progressText').innerText = `CÂU TRẮC NGHIỆM: ${currentQuestionIndex + 1}/5`;
            document.getElementById('questionText').innerText = q.q;
            const area = document.getElementById('optionsArea');
            area.innerHTML = '';
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn p-4 rounded-xl text-left font-bold text-gray-700 bg-white hover:bg-blue-50 transition-all flex items-center group';
                btn.innerHTML = `
                    <span class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-4 text-xs font-black group-hover:bg-blue-600 group-hover:text-white transition-all">${String.fromCharCode(65 + i)}</span>
                    <span class="flex-1">${opt}</span>
                `;
                btn.onclick = () => selectOption(i);
                area.appendChild(btn);
            });
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('nextBtn').onclick = nextQuestion;
        }

        function selectOption(i, btn) {
            const currentQ = selectedQuestions[currentIdx];
            const isCorrect = i === currentQ.c;
            const feedback = document.getElementById('quiz-feedback');
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            if (isCorrect) {
                btn.classList.add('bg-green-50', 'border-green-500');
                btn.querySelector('div').classList.add('bg-green-600', 'text-white');
                if (feedback) { feedback.innerText = "CHÍNH XÁC! 🎉"; feedback.classList.add('text-green-600'); }
                score += 20;
            } else {
                btn.classList.add('bg-red-50', 'border-red-500');
                btn.querySelector('div').classList.add('bg-red-600', 'text-white');
                if (feedback) { feedback.innerText = "SAI RỒI! ❌"; feedback.classList.add('text-red-600'); }
                const correctBtn = document.querySelectorAll('.option-btn')[currentQ.c];
                if (correctBtn) correctBtn.classList.add('bg-green-50', 'border-green-500');
            }
            if (feedback) feedback.style.opacity = '1';
            setTimeout(() => {
                currentIdx++;
                (currentIdx < 5) ? showQuestion() : showResults();
            }, 1000);
        }

        function nextQuestion() {
            const selected = parseInt(document.getElementById('nextBtn').dataset.selected);
            if (selected === currentQuestions[currentQuestionIndex].c) score += 20;

            currentQuestionIndex++;
            if (currentQuestionIndex < 5) {
                showQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            endTime = new Date();
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('scoreText').innerText = score;

            const circle = document.getElementById('scoreCircle');
            const pct = (score / 100) * 465;
            circle.style.strokeDasharray = `${pct}, 465`;

            if (score >= 80) {
                document.getElementById('resultTitle').innerText = "Xuất sắc quá!";
                document.getElementById('resultMsg').innerText = "Em đã nắm rất vững nội dung bài đọc này.";
            } else if (score >= 50) {
                document.getElementById('resultTitle').innerText = "Làm tốt lắm!";
                document.getElementById('resultMsg').innerText = "Em chỉ cần chú ý thêm một chút nữa thôi.";
            } else {
                document.getElementById('resultTitle').innerText = "Cố gắng lên nhé!";
                document.getElementById('resultMsg').innerText = "Em nên đọc lại bài và luyện tập thêm một lần nữa.";
            }
        }

        function restartQuiz() {
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-registration').classList.remove('hidden');
            document.getElementById('studentName').value = '';
        }

        // --- 4. FIREBASE & STATS ---
        function submitResults(e) {
            if (e) e.preventDefault();
            const btn = document.querySelector('#quiz-results button:last-child');
            if (btn) { btn.innerHTML = "Đang nộp..."; btn.disabled = true; }
            const data = {
                studentName: document.getElementById('studentName').value,
                studentClass: document.getElementById('studentClass').value,
                school: document.getElementById('schoolSelect').value === 'Khác' ? document.getElementById('otherSchool').value : document.getElementById('schoolSelect').value,
                lessonTitle: document.title.replace(' - EduRobot', ''),
                score: score,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            let successShown = false;
            const showSuccess = () => {
                if (successShown) return;
                successShown = true;
                document.getElementById('successModal').classList.add('active');
                document.getElementById('successModal').classList.remove('hidden');
                celebrate();
                if (btn) { btn.innerHTML = "NỘP KẾT QUẢ"; btn.disabled = false; }
                let timeLeft = 5;
                const countdownEl = document.getElementById('countdown');
                const timer = setInterval(() => {
                    timeLeft--;
                    if (countdownEl) countdownEl.innerText = timeLeft;
                    if (timeLeft <= 0) { clearInterval(timer); closeSuccessModal(); }
                }, 1000);
            };
            const dbTimeout = setTimeout(() => { if (!successShown) showSuccess(); }, 3000);
            if (window.db || firebase.apps.length) {
                const database = window.db || firebase.firestore();
                database.collection("quiz_results").add(data).then(() => { clearTimeout(dbTimeout); showSuccess(); }).catch((err) => { console.error(err); clearTimeout(dbTimeout); showSuccess(); });
            } else { clearTimeout(dbTimeout); showSuccess(); }
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            document.getElementById('successModal').classList.add('hidden');
            restartQuiz();
            if (typeof switchTab === 'function') switchTab('lesson');
        }

        function openTeacherStats() {
            const pin = prompt("Nhập mã pin giáo viên:");
            if (pin === "dvn") {
                document.getElementById('statsModal').classList.add('active');
                loadStats();
            } else {
                alert("Mã pin không đúng!");
            }
        }

        function closeModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10 font-bold text-gray-400 italic">Đang tải dữ liệu...</td></tr>';

            try {
                const snapshot = await db.collection("diem_tieng_viet_lop5")
                    .where("lessonTitle", "==", "Giỏ hoa tháng Năm")
                    .limit(100)
                    .get();

                const docs = [];
                snapshot.forEach(doc => docs.push(doc.data()));
                docs.sort((a, b) => {
                    const tA = a.submittedAt ? a.submittedAt.toMillis() : 0;
                    const tB = b.submittedAt ? b.submittedAt.toMillis() : 0;
                    return tB - tA;
                });

                tbody.innerHTML = '';
                let index = 1;
                docs.forEach(data => {
                    const date = data.submittedAt ? data.submittedAt.toDate().toLocaleString('vi-VN') : '---';
                    const dur = data.duration ? `${Math.floor(data.duration / 60)}p ${data.duration % 60}s` : '---';

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50/50 transition-colors";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-black text-gray-400 text-xs">${index++}</td>
                        <td class="px-6 py-4 font-bold text-gray-800">${data.name}</td>
                        <td class="px-6 py-4 font-bold text-blue-600">${data.studentClass}</td>
                        <td class="px-6 py-4 font-medium text-gray-500 text-sm">${data.school}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-lg ${data.score >= 80 ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'} font-black text-sm">${data.score}</span>
                        </td>
                        <td class="px-6 py-4 text-center font-bold text-gray-400">1</td>
                        <td class="px-6 py-4 text-center font-bold text-gray-600 text-xs">${dur}</td>
                        <td class="px-6 py-4 text-right font-bold text-gray-400 text-[10px]">${date}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10 font-bold text-red-400">Lỗi khi tải dữ liệu.</td></tr>';
            }
        }

        function exportToExcel() {
            const table = document.querySelector("#statsModal table");
            const ws = XLSX.utils.table_to_sheet(table);

            // Ensure Class column is text
            Object.keys(ws).forEach(key => {
                if (key.startsWith('C')) { // Column C is Class
                    ws[key].t = 's';
                }
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQua");
            XLSX.writeFile(wb, "KetQua_GioHoaThangNam.xlsx");
        }
    </script>
    
    <!-- Audio Celebration -->
    <audio id="clapSound" src="https://www.soundjay.com/human/applause-01.mp3" preload="auto"></audio>
<script src="js/floating-menu.js"></script>
</body>

</html>
