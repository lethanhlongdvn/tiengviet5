<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiếng hát của người đá - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Nunito & Merriweather -->
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            font-size: 18px;
            /* Base font size increased */
        }

        .serif-font {
            font-family: 'Merriweather', serif;
            font-size: 18px;
            line-height: 1.8;
        }

        .serif-font p {
            text-indent: 2em;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-open .accordion-content {
            max-height: 800px;
            /* Ensure long answers are fully visible */
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .bg-paper {
            background-color: #fdfcf7;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        /* Tab Styles */
        .tab-btn.active {
            border-bottom: 4px solid #1d4ed8;
            color: #1d4ed8;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quiz Styles */
        .quiz-option {
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
        }

        .quiz-option:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .quiz-option.selected {
            border-color: #2563eb;
            background-color: #dbeafe;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="bg-white sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <a href="index.html" class="flex items-center space-x-2">
                    <div
                        class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white text-lg font-bold">
                        E</div>
                    <span class="text-lg font-extrabold text-blue-600 tracking-tight">EduRobot - <span
                            class="text-yellow-500">Tiếng Việt 5</span></span>
                </a>
            </div>

            <ul class="hidden md:flex space-x-6 font-semibold text-gray-600 text-sm">
                <li><a href="ve-dep-cuoc-song.html"
                        class="hover:text-blue-500 transition-colors font-bold text-blue-600 border-b-2 border-blue-600">Bài
                        học</a></li>
                <li><a href="#" onclick="openTeacherStats()" class="hover:text-blue-500 transition-colors">Thống kê</a>
                </li>
                <li><a href="#" class="hover:text-blue-500 transition-colors">Liên hệ</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-4">

        <!-- Navigation & Audio Player Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4">
            <div>
                <a href="ve-dep-cuoc-song.html?week=19"
                    class="flex items-center text-gray-600 hover:text-blue-600 font-bold transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </a>
            </div>
        </div>

        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-2xl overflow-hidden shadow-sm">
            <button onclick="switchTab('lesson')" id="btn-lesson"
                class="tab-btn active flex-1 py-4 text-center font-bold text-gray-500 transition-all hover:bg-blue-50">
                1. Bài học
            </button>
            <button onclick="switchTab('quiz')" id="btn-quiz"
                class="tab-btn flex-1 py-4 text-center font-bold text-gray-500 transition-all hover:bg-blue-50">
                2. Luyện tập
            </button>
        </div>

        <div id="tab-lesson" class="tab-content active">
            <div class="flex justify-end mb-4">
                <div
                    class="flex items-center space-x-4 bg-white rounded-full p-2 pr-6 shadow-sm border border-blue-100">
                    <button id="audioControl" onclick="toggleAudio()"
                        class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">
                        <svg id="playIcon" class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div>
                        <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Nghe đọc mẫu</p>
                        <p id="audioStatus" class="text-xs text-gray-400 font-bold italic">Đang dừng...</p>
                    </div>
                    <audio id="lessonAudio">
                        <source src="am_thanh/tienghatcuanguoida.wav" type="audio/wav">
                    </audio>
                </div>
            </div>
            <div class="flex flex-col lg:flex-row gap-8">

                <!-- Cột trái (70%) - Bài đọc -->
                <section class="w-full lg:w-[70%] text-center">
                    <div class="bg-white rounded-[30px] shadow-sm border border-gray-100 p-2 md:p-3">


                        <div class="p-6 md:p-10 bg-paper rounded-2xl shadow-inner border border-gray-50">
                            <div class="serif-font text-gray-800 text-justify">
                                <h1 class="text-3xl font-black mb-6 text-blue-900 text-center uppercase tracking-tight">
                                    Tiếng hát của người đá</h1>

                                <p class="mb-4">
                                    Trên đỉnh núi cao ở vùng Chư Bô-đa, có một mỏm đá xanh giống hình một em bé cưỡi
                                    voi.
                                    Những tia nắng vàng dịu, những hạt mưa trong vắt thay nhau tắm gội, sưởi ấm cho mỏm
                                    đá.
                                    Gió rì rào kể cho mỏm đá nghe những câu chuyện về mọi miền. Chim hót cho mỏm đá nghe
                                    những điệu ca du dương. Cứ thế, năm này qua năm khác, những câu chuyện của gió,
                                    những
                                    bài ca của chim thấm sâu vào mỏm đá hình em bé.
                                </p>
                                <p class="mb-4">
                                    Một buổi sáng, mỏm đá khẽ cựa quậy, rồi từ từ biến thành một em bé xinh đẹp. Em bước
                                    xuống núi, thấy muông thú từng đàn kéo về phá nương rẫy, dân làng đuổi đằng đông,
                                    dồn
                                    đằng tây mà chẳng ăn thua gì. Em bé liền cất giọng hát. Tiếng hát của em vang khắp
                                    núi
                                    rừng. Muông thú quên cả phá lúa, nhảy múa theo tiếng hát. Dân làng vây quanh em bé,
                                    hỏi
                                    em từ đâu tới, tên em là gì, nhưng em chỉ cười. Mọi người đặt tên cho em là Nai
                                    Ngọc.
                                </p>
                                <p class="mb-4">
                                    Ngày nọ, giặc kéo đến đông như lá rừng, nhanh như chớp giật, giáo mác chĩa lên trời
                                    tua
                                    tủa như bông lách, bông lau. Dân làng không kể trẻ già, trai gái vội cầm tên nỏ,
                                    khiên
                                    đao đuổi giặc. Bốn phương lửa cháy rừng rực. Nai Ngọc trèo lên một mỏm núi, cất
                                    tiếng
                                    hát kêu gọi những kẻ xâm lược chớ đi ăn cướp, hãy trở về với vợ con, đi hái rau
                                    ngọt,
                                    cắt lúa vàng, tối ngủ bên lửa ấm, sáng thức dậy theo mặt trời,... Giọng hát của Nai
                                    Ngọc
                                    khiến giặc đứng sững như những pho tượng, vũ khí tuột khỏi tay.
                                </p>
                                <p class="mb-4">
                                    Giặc tan, nhưng không thấy Nai Ngọc đâu. Dân làng bảo nhau rằng sau khi giúp dân trừ
                                    giặc, Nai Ngọc đã trở lên núi cao, biến thành đá như trước. Ai cũng tin rằng nhất
                                    định
                                    Nai Ngọc sẽ trở về với dân làng, cất tiếng hát giữa cảnh núi rừng thanh bình, tươi
                                    đẹp.
                                </p>
                                <p class="text-right italic font-bold text-gray-600 mt-6">(Theo Truyện cổ Việt Nam, Ngọc
                                    Anh
                                    và Văn Lang kể)</p>
                            </div>
                        </div>


                    </div>
                </section>

                <!-- Cột phải (30%) - Tìm hiểu bài -->
                <aside class="w-full lg:w-[30%]">
                    <div class="bg-yellow-50 rounded-[30px] shadow-sm border border-yellow-100 p-4 sticky top-20">
                        <h2 class="text-xl font-black text-blue-900 mb-4 flex items-center">
                            <span class="w-10 h-10 bg-yellow-400 rounded-xl flex items-center justify-center mr-3">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </span>
                            Tìm hiểu bài
                        </h2>

                        <div class="space-y-4">
                            <!-- Câu 1 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">1.
                                        Mỏm đá trên đỉnh núi cao có gì đặc biệt? Mỏm đá được mọi vật yêu quý như thế
                                        nào?</span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-base text-gray-700 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1 text-base">Gợi ý:</span>
                                        <ul class="list-disc ml-4 space-y-2">
                                            <li><span class="font-bold text-blue-600">Đặc biệt:</span> Trên đỉnh núi cao
                                                ở
                                                vùng Chư Bô-đa, có một mỏm đá xanh giống hình một em bé cưỡi voi.</li>
                                            <li><span class="font-bold text-blue-600">Được mọi vật yêu quý:</span>
                                                <ul class="ml-4 list-circle space-y-1 mt-1">
                                                    <li><span class="font-bold">Nắng:</span> Những tia nắng vàng dịu
                                                        thay
                                                        nhau sưởi ấm cho mỏm đá.</li>
                                                    <li><span class="font-bold">Mưa:</span> Những hạt mưa trong vắt thay
                                                        nhau tắm gội cho mỏm đá.</li>
                                                    <li><span class="font-bold">Gió:</span> Rì rào kể cho mỏm đá nghe
                                                        những
                                                        câu chuyện về mọi miền.</li>
                                                    <li><span class="font-bold">Chim:</span> Hót cho mỏm đá nghe những
                                                        điệu
                                                        ca du dương.</li>
                                                </ul>
                                            </li>
                                            <li class="italic text-gray-500 mt-2">=> Theo thời gian, những câu chuyện
                                                của
                                                gió và những bài ca của chim đã thấm sâu vào mỏm đá hình em bé.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 2 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">2.
                                        Chuyện gì xảy ra vào ngày mỏm đá hoá thành một em bé? Mọi người được chứng kiến
                                        điều
                                        gì kì lạ khi em bé người đã cất tiếng hát vang khắp núi rừng?</span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-base text-gray-700 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1 text-base">Gợi ý:</span>
                                        <ul class="list-disc ml-4 space-y-2">
                                            <li><span class="font-bold text-blue-600">Sự kiện:</span> Một buổi sáng, mỏm
                                                đá
                                                khẽ cựa quậy rồi từ từ biến thành một em bé xinh đẹp. Em bước xuống núi
                                                đúng
                                                lúc muông thú từng đàn kéo về phá nương rẫy, dân làng ra sức đuổi nhưng
                                                không có kết quả.</li>
                                            <li><span class="font-bold text-blue-600">Điều kì lạ:</span> Khi em bé cất
                                                tiếng
                                                hát vang khắp núi rừng, muông thú quên cả phá lúa, nhảy múa theo tiếng
                                                hát.
                                                Chứng kiến điều kì lạ này, dân làng vây quanh và đặt tên cho em là Nai
                                                Ngọc.
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 3 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">3.
                                        Khi giặc kéo đến, em bé người đá và dân làng đã làm gì để đuổi giặc?</span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-base text-gray-700 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1 text-base">Gợi ý:</span>
                                        <ul class="list-disc ml-4 space-y-2">
                                            <li><span class="font-bold text-blue-600">Dân làng:</span> Không kể trẻ già,
                                                trai gái vội cầm tên nỏ, khiên đao quyết tâm đuổi giặc bảo vệ buôn làng
                                                giữa
                                                khói lửa bốn phương cháy rực.</li>
                                            <li><span class="font-bold text-blue-600">Nai Ngọc:</span> Trèo lên một mỏm
                                                núi,
                                                cất tiếng hát thiết tha kêu gọi kẻ xâm lược dừng tay, hãy trở về với gia
                                                đình để đi hái rau ngọt, cắt lúa vàng, tối ngủ bên bếp lửa ấm và sáng ra
                                                đi
                                                làm theo mặt trời.</li>
                                            <li><span class="font-bold text-blue-600">Kết quả:</span> Tiếng hát khiến
                                                giặc
                                                sững sờ như những pho tượng, vũ khí tuột khỏi tay và cuối cùng giặc tan.
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 4 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">4.
                                        Theo em, lời hát của em bé người đá thể hiện ước nguyện gì của con người?</span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-base text-gray-700 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1 text-base">Gợi ý:</span>
                                        Lời hát của Nai Ngọc thể hiện ước nguyện về một cuộc sống <span
                                            class="font-bold text-blue-600">thanh bình, ấm no</span>. Đó là khát vọng
                                        hòa
                                        bình, nơi con người không còn chiến tranh, được chung sống hạnh phúc bên gia
                                        đình,
                                        lao động sản xuất và tận hưởng vẻ đẹp của quê hương.
                                    </div>
                                </div>
                            </div>

                            <!-- Câu hỏi 5 -->
                            <div
                                class="accordion-item bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-50">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">5.
                                        Nêu một kết thúc khác cho câu chuyện theo mong muốn của em.</span>
                                    <svg class="w-5 h-5 text-gray-400 transition-transform" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-5 pb-5 text-sm text-gray-600 leading-relaxed border-t border-gray-50 pt-3">
                                        <span class="text-green-600 font-bold block mb-1">Gợi ý:</span>
                                        <p>Sau khi giặc tan, Nai Ngọc không biến lại thành đá mà ở lại cùng dân làng. Em
                                            dạy
                                            mọi người hát những bài ca yêu đời, giúp buôn làng luôn tràn ngập tiếng cười
                                            và
                                            sự ấm no, hạnh phúc mãi mãi.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>

        </div>
        </div>

        <!-- Quiz Tab Content -->
        <div id="tab-quiz" class="tab-content">
            <div class="bg-white rounded-[30px] shadow-sm border border-gray-100 p-6 md:p-10 max-w-4xl mx-auto">
                <div id="quiz-registration">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-black text-blue-900 mb-2">THÔNG TIN HỌC SINH</h2>
                        <p class="text-gray-500">Vui lòng nhập thông tin để bắt đầu luyện tập: <b>Tiếng hát của người
                                đá</b></p>
                    </div>
                    <form id="regForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">Họ và tên:</label>
                            <input type="text" id="studentName" required
                                class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all"
                                placeholder="Nhập đầy đủ họ tên của em">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Lớp:</label>
                                <select id="studentClass" required
                                    class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all">
                                    <option value="">-- Chọn lớp --</option>
                                    <option value="5/1">Lớp 5/1</option>
                                    <option value="5/2">Lớp 5/2</option>
                                    <option value="5/3">Lớp 5/3</option>
                                    <option value="5/4">Lớp 5/4</option>
                                    <option value="5/5">Lớp 5/5</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Trường:</label>
                                <div class="relative">
                                    <select id="schoolSelect" onchange="checkSchool(this)"
                                        class="w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all">
                                        <option value="Tiểu học Đỗ Văn Nại">Tiểu học Đỗ Văn Nại</option>
                                        <option value="other">Trường khác...</option>
                                    </select>
                                    <input type="text" id="otherSchool"
                                        class="hidden mt-4 w-full p-4 border-2 border-gray-100 rounded-2xl focus:border-blue-500 outline-none transition-all"
                                        placeholder="Nhập tên trường của em">
                                </div>
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-lg uppercase tracking-wider">
                            Bắt đầu làm bài
                        </button>
                    </form>
                </div>

                <div id="quiz-container" class="hidden">
                    <div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <span id="questionNum"
                                class="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center font-black text-xl">1</span>
                            <div>
                                <p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Câu hỏi</p>
                                <p class="text-xs text-gray-400 font-bold" id="progressText">Đang thực hiện: 1/5</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Thời gian còn lại
                            </p>
                            <p id="timer" class="text-lg font-black text-blue-900">20:00</p>
                        </div>
                    </div>

                    <div id="questionArea" class="mb-8">
                        <h3 id="questionText" class="text-xl font-bold text-gray-800 mb-6 leading-relaxed"></h3>
                        <div id="optionsArea" class="grid grid-cols-1 gap-4"></div>
                    </div>

                    <div class="flex justify-end pt-6 border-t border-gray-100">
                        <button id="nextBtn" disabled
                            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 px-10 rounded-2xl shadow-lg transition-all active:scale-95 flex items-center">
                            Tiếp theo
                            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="quiz-results" class="hidden text-center py-12">
                    <div class="mb-8 relative inline-block">
                        <svg class="w-48 h-48 mx-auto" viewBox="0 0 36 36">
                            <path class="text-gray-100" stroke-width="3" fill="none"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path id="scoreCircle" class="text-green-500" stroke-width="3" stroke-dasharray="0, 100"
                                stroke-linecap="round" fill="none"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="scoreText" class="text-5xl font-black text-blue-900">0</span>
                            <span class="text-sm font-bold text-gray-400 uppercase">Điểm</span>
                        </div>
                    </div>
                    <h2 class="text-3xl font-black text-gray-800 mb-2" id="resultTitle">Hoàn thành!</h2>
                    <p class="text-gray-500 mb-10" id="resultMsg">Chúc mừng em đã hoàn thành bài luyện tập.</p>

                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="restartQuiz()"
                            class="bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-bold py-4 px-10 rounded-2xl transition-all active:scale-95">Làm
                            lại</button>
                        <button onclick="submitResults(event)"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-2xl shadow-lg transition-all active:scale-95">Nộp
                            bài</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Statistics Modal -->
        <div id="statsModal" class="modal">
            <div
                class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col m-4">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-blue-600 text-white">
                    <h2 class="text-2xl font-black">THỐNG KÊ KẾT QUẢ HỌC TẬP</h2>
                    <button onclick="closeModal()" class="hover:bg-blue-700 p-2 rounded-full transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-x-auto flex-1">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 uppercase text-xs font-bold tracking-widest">
                                <th class="p-4 border-b">STT</th>
                                <th class="p-4 border-b">Họ và tên</th>
                                <th class="p-4 border-b">Lớp</th>
                                <th class="p-4 border-b">Trường</th>
                                <th class="p-4 border-b text-center">Điểm số</th>
                                <th class="p-4 border-b text-center">Thời gian làm</th>
                                <th class="p-4 border-b text-right">Thời gian nộp</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-zinc-900 text-zinc-400 py-3 px-4 mt-2">
        <div class="container mx-auto text-center text-sm">
            <p>@ 2026 EduRobot - Phát triển bởi Lê Thành Long</p>
        </div>
    </footer>

    <script>
        function toggleAccordion(button) {
            const item = button.parentElement;
            const isOpen = item.classList.contains('accordion-open');
            document.querySelectorAll('.accordion-item').forEach(el => {
                el.classList.remove('accordion-open');
            });
            if (!isOpen) {
                item.classList.add('accordion-open');
            }
        }

        const audio = document.getElementById('lessonAudio');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const audioStatus = document.getElementById('audioStatus');

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                audioStatus.innerText = "Đang phát...";
                audioStatus.classList.remove('text-gray-400');
                audioStatus.classList.add('text-green-500');
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.innerText = "Đang dừng...";
                audioStatus.classList.remove('text-green-500');
                audioStatus.classList.add('text-gray-400');
            }
        }

        audio.onended = function () {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.innerText = "Đang dừng...";
            audioStatus.classList.remove('text-green-500');
            audioStatus.classList.add('text-gray-400');
        };

        /* FIREBASE CONFIG */
        const firebaseConfig = {
            apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
            authDomain: "gamhoctap.firebaseapp.com",
            databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gamhoctap",
            storageBucket: "gamhoctap.firebasestorage.app",
            messagingSenderId: "833329613932",
            appId: "1:833329613932:web:0d8574827bcfe50b535c49",
            measurementId: "G-YT1PKCYS67"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        /* TEACHER STATS LOGIC */
        function openTeacherStats() {
            const pin = prompt("Vui lòng nhập mã PIN giáo viên:");
            if (pin === 'dvn') {
                document.getElementById('statsModal').classList.add('active');
                loadStats();
            } else if (pin !== null) {
                alert("Mã PIN không chính xác!");
            }
        }

        function closeModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">Đang tải dữ liệu...</td></tr>';

            try {
                const snapshot = await db.collection("diem_tieng_viet_lop5")
                    .where("lessonTitle", "==", "Tiếng hát của người đá")
                    .get();

                tbody.innerHTML = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400">Chưa có dữ liệu học tập.</td></tr>';
                    return;
                }

                const results = [];
                snapshot.forEach(doc => results.push(doc.data()));
                results.sort((a, b) => (b.submittedAt?.seconds || 0) - (a.submittedAt?.seconds || 0));

                results.forEach((data, index) => {
                    const date = data.submittedAt ? data.submittedAt.toDate().toLocaleString('vi-VN') : '---';

                    let duration = '---';
                    if (data.startTime && data.endTime) {
                        const start = new Date(data.startTime);
                        const end = new Date(data.endTime);
                        const diffMs = end - start;
                        const mins = Math.floor(diffMs / 60000);
                        const secs = Math.floor((diffMs % 60000) / 1000);
                        duration = `${mins} phút ${secs} giây`;
                    }

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 transition-colors border-b border-gray-50";
                    tr.innerHTML = `
                        <td class="p-4 font-bold text-gray-400">${index + 1}</td>
                        <td class="p-4 font-bold text-gray-800">${data.studentName}</td>
                        <td class="p-4 text-gray-600">${data.className}</td>
                        <td class="p-4 text-gray-600">${data.school}</td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 rounded-full font-black ${data.score >= 80 ? 'bg-green-100 text-green-700' : data.score >= 50 ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}">
                                ${data.score}/100
                            </span>
                        </td>
                        <td class="p-4 text-center text-gray-600 font-bold">${duration}</td>
                        <td class="p-4 text-right text-xs text-gray-400 font-bold">${date}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error("Error loading stats:", error);
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-500">Lỗi khi tải dữ liệu. Vui lòng thử lại.</td></tr>';
            }
        }

        function exportToExcel() {
            const table = document.querySelector("#statsModal table");
            const wb = XLSX.utils.table_to_book(table, { sheet: "Kết quả", raw: true });
            XLSX.writeFile(wb, "ThongKe_GiaoVien_EduRobot.xlsx");
        }

        /* TAB LOGIC */
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'text-blue-600'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.getElementById('btn-' + tabId).classList.add('active', 'text-blue-600');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        /* REGISTRATION LOGIC */
        const regForm = document.getElementById('regForm');
        const otherSchoolInput = document.getElementById('otherSchool');

        function checkSchool(select) {
            if (select.value === 'other') {
                otherSchoolInput.classList.remove('hidden');
                otherSchoolInput.required = true;
            } else {
                otherSchoolInput.classList.add('hidden');
                otherSchoolInput.required = false;
            }
        }

        let studentData = {};

        regForm.onsubmit = function (e) {
            e.preventDefault();
            studentData = {
                name: document.getElementById('studentName').value,
                className: document.getElementById('studentClass').value,
                school: document.getElementById('schoolSelect').value === 'other' ?
                    document.getElementById('otherSchool').value :
                    document.getElementById('schoolSelect').value,
                startTime: new Date().toISOString()
            };
            document.getElementById('quiz-registration').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            startQuiz();
        };

        /* QUIZ ENGINE */
        const allQuestions = [
            { q: "Mỏm đá xanh hình em bé cưỡi voi nằm ở đâu?", a: ["Trên đỉnh núi Ngự", "Trên đỉnh núi cao ở vùng Chư Bô-đa", "Trong một hang động sâu", "Bên cạnh bờ suối"], c: 1 },
            { q: "Hình dáng của mỏm đá xanh được mô tả như thế nào?", a: ["Giống hình một con voi khổng lồ", "Giống hình một người mẹ đang bồng con", "Giống hình một em bé cưỡi voi", "Giống hình một bông hoa đá"], c: 2 },
            { q: "Những yếu tố thiên nhiên nào đã \"kể chuyện\" và \"hát\" cho mỏm đá nghe suốt nhiều năm?", a: ["Mưa và nắng", "Gió và chim", "Suối và cây rừng", "Mây và sương mù"], c: 1 },
            { q: "Điều kỳ diệu gì đã xảy ra vào một buổi sáng?", a: ["Mỏm đá vỡ tan thành nhiều mảnh", "Mỏm đá khẽ cựa quậy, rồi biến thành một em bé xinh đẹp", "Mỏm đá bay lên trời", "Mỏm đá phát ra ánh sáng rực rỡ"], c: 1 },
            { q: "Khi em bé bước xuống núi, chuyện gì đang xảy ra với dân làng?", a: ["Giặc ngoại xâm đang tấn công", "Muông thú kéo về phá nương rẫy mà dân làng đuổi không được", "Dân làng đang tổ chức lễ hội", "Dân làng đang bị hạn hán"], c: 1 },
            { q: "Em bé đã làm cách nào để muông thú ngừng phá hoại mùa màng?", a: ["Dùng cung tên bắn đuổi", "Dùng phép thuật hóa phép", "Cất tiếng hát vang khắp núi rừng", "Nhờ sự giúp đỡ của thần núi"], c: 2 },
            { q: "Dân làng đã đặt tên cho em bé là gì?", a: ["Sơn Tinh", "Chư Bô-đa", "Nai Ngọc", "Hơ Bia"], c: 2 },
            { q: "Khi giặc ngoại xâm kéo đến, quân giặc được miêu tả như thế nào?", a: ["Đông như lá rừng, nhanh như chớp giật", "Đông như kiến cỏ, dữ như hổ báo", "Ít nhưng tinh nhuệ", "Chậm chạp nhưng trang bị vũ khí hiện đại"], c: 0 },
            { q: "Thái độ của dân làng khi giặc đến xâm lược là gì?", a: ["Sợ hãi bỏ chạy vào rừng sâu", "Không kể trẻ già trai gái vội cầm vũ khí đuổi giặc", "Đầu hàng ngay lập tức", "Cầu xin thần linh giúp đỡ"], c: 1 },
            { q: "Nai Ngọc đã làm gì để giúp dân làng chống giặc?", a: ["Cầm gươm xông pha ra trận", "Biến thành người khổng lồ dẫm nát quân giặc", "Trèo lên mỏm núi và cất tiếng hát kêu gọi quân giặc", "Dùng voi thần đuổi giặc"], c: 2 },
            { q: "Nội dung tiếng hát của Nai Ngọc khuyên quân giặc điều gì?", a: ["Hãy đầu hàng sẽ được tha chết", "Chớ đi ăn cướp, hãy trở về với vợ con, làm ruộng và sống thanh bình", "Hãy chiến đấu dũng cảm hơn nữa", "Hãy đi xâm lược vùng đất khác"], c: 1 },
            { q: "Tiếng hát của Nai Ngọc đã tác động đến quân giặc như thế nào?", a: ["Làm quân giặc tức giận hơn", "Làm quân giặc lăn ra ngủ say", "Khiến giặc đứng sững như tượng, vũ khí tuột khỏi tay", "Làm quân giặc hoảng sợ bỏ chạy tán loạn"], c: 2 },
            { q: "Sau khi giặc tan, Nai Ngọc đã đi đâu?", a: ["Ở lại làm tù trưởng của buôn làng", "Đi chu du thiên hạ", "Về trời", "Trở lên núi cao, biến thành đá như trước"], c: 3 },
            { q: "Người dân tin rằng Nai Ngọc sẽ trở về khi nào?", a: ["Khi có giặc ngoại xâm lần nữa", "Khi dân làng gặp thiên tai", "Khi cảnh núi rừng thanh bình, tươi đẹp", "Vào ngày hội mùa xuân"], c: 2 },
            { q: "Câu chuyện ca ngợi sức mạnh của điều gì?", a: ["Sức mạnh quân sự", "Sức mạnh của thiên nhiên hùng vĩ", "Sức mạnh của tiếng hát, lòng yêu chuộng hòa bình và cuộc sống ấm no", "Sức mạnh của những tảng đá thần"], c: 2 }
        ];

        let currentQuizQuestions = [];
        let currentQuestionIdx = 0;
        let score = 0;
        let selectedOption = null;
        let lastUsedQuestions = [];

        function startQuiz() {
            let available = [...allQuestions];
            available.sort(() => Math.random() - 0.5);

            if (lastUsedQuestions.length > 0) {
                let fresh = available.filter(q => !lastUsedQuestions.includes(q.q));
                let repeated = available.filter(q => lastUsedQuestions.includes(q.q));
                currentQuizQuestions = fresh.slice(0, 5);
                if (currentQuizQuestions.length < 5) {
                    currentQuizQuestions = currentQuizQuestions.concat(repeated.slice(0, 5 - currentQuizQuestions.length));
                }
            } else {
                currentQuizQuestions = available.slice(0, 5);
            }

            lastUsedQuestions = currentQuizQuestions.map(q => q.q);
            currentQuestionIdx = 0;
            score = 0;
            showQuestion();
        }

        function showQuestion() {
            const q = currentQuizQuestions[currentQuestionIdx];
            document.getElementById('questionNum').innerText = currentQuestionIdx + 1;
            document.getElementById('progressText').innerText = `Đang thực hiện: ${currentQuestionIdx + 1}/5`;
            document.getElementById('questionText').innerText = q.q;

            const optionsArea = document.getElementById('optionsArea');
            optionsArea.innerHTML = '';

            q.a.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option w-full p-4 rounded-2xl text-left font-bold text-gray-700 flex items-center group';
                btn.innerHTML = `
                    <span class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-4 group-hover:bg-blue-100 transition-colors">${String.fromCharCode(65 + idx)}</span>
                    <span class="flex-1">${opt}</span>
                `;
                btn.onclick = () => selectOption(idx, btn);
                optionsArea.appendChild(btn);
            });

            document.getElementById('nextBtn').disabled = true;
            selectedOption = null;
        }

        function selectOption(idx, btn) {
            document.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected', 'border-blue-500'));
            btn.classList.add('selected', 'border-blue-500');
            selectedOption = idx;
            document.getElementById('nextBtn').disabled = false;
        }

        document.getElementById('nextBtn').onclick = function () {
            if (selectedOption === currentQuizQuestions[currentQuestionIdx].c) {
                score += 20;
            }

            currentQuestionIdx++;
            if (currentQuestionIdx < 5) {
                showQuestion();
            } else {
                showResults();
            }
        };

        function showResults() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');

            document.getElementById('scoreText').innerText = score;
            const circle = document.getElementById('scoreCircle');
            circle.setAttribute('stroke-dasharray', `${score}, 100`);

            if (score >= 80) {
                document.getElementById('resultTitle').innerText = "Thật tuyệt vời!";
                document.getElementById('resultMsg').innerText = "Em hiểu rất rõ về ý nghĩa câu chuyện này.";
            } else if (score >= 50) {
                document.getElementById('resultTitle').innerText = "Rất tốt!";
                document.getElementById('resultMsg').innerText = "Em đã cảm nhận được lòng nhân ái qua câu chuyện.";
            } else {
                document.getElementById('resultTitle').innerText = "Cố gắng lên!";
                document.getElementById('resultMsg').innerText = "Em hãy đọc lại câu chuyện và thử lại nhé.";
            }
        }

        function restartQuiz() {
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            startQuiz();
        }

        async function submitResults(e) {
            const finalData = {
                studentName: studentData.name,
                className: studentData.className,
                school: studentData.school,
                lessonTitle: "Tiếng hát của người đá",
                score: score,
                startTime: studentData.startTime,
                endTime: new Date().toISOString(),
                submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const btn = e.target;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Đang gửi...";

            try {
                await db.collection("diem_tieng_viet_lop5").add(finalData);
                alert(`Chúc mừng em ${studentData.name}!\nKết quả của em đã được gửi thành công đến thầy cô.\nĐiểm: ${score}/100`);
                // Reset Quiz UI for next time
                document.getElementById('quiz-results').classList.add('hidden');
                document.getElementById('quiz-registration').classList.remove('hidden');
                switchTab('lesson');
            } catch (error) {
                console.error("Error submitting quiz:", error);
                alert("Có lỗi xảy ra khi nộp bài. Em hãy kiểm tra lại kết nối mạng nhé!");
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
    </script>
</body>

</html>