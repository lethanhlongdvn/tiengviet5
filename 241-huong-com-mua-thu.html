<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hương Cốm Mùa Thu - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- SheetJS for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        .hidden {
            display: none !important;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
        }

        .bg-paper {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .tab-btn.active {
            color: var(--primary);
            background: white;
            box-shadow: inset 0 -3px 0 var(--primary);
        }

        .tab-content {
            display: none !important;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block !important;
        }

        #tab-quiz.active {
            display: flex !important;
        }

        /* Compact Quiz styles */
        #quiz-container {
            height: calc(100vh - 180px);
            /* Adjust based on header/footer */
            max-height: 600px;
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid #e2e8f0;
        }

        .option-btn:hover:not(:disabled) {
            transform: translateX(4px);
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option-btn.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Accordion Custom */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-open {
            background: white !important;
            border-color: var(--primary) !important;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1) !important;
        }

        .accordion-open .accordion-content {
            max-height: 500px;
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .reading-content p {
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        /* Success Modal Styles */
        .success-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 200;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        .success-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .success-card {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .success-modal.active .success-card {
            transform: scale(1);
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="sticky top-0 z-50 px-4 py-2">
                                <nav class="container mx-auto glass-card rounded-xl px-5 py-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 shrink-0">
                    <span class="text-xl font-black">E</span>
                </div>
                <div class="flex flex-col md:flex-row md:items-center md:space-x-6">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl font-black text-blue-700">EduRobot</span>
                        <span class="text-[11px] font-bold px-3 py-1 rounded-full bg-orange-500 text-white shadow-sm shadow-orange-200 tracking-wide whitespace-nowrap">TIẾNG VIỆT 5</span>
                    </div>
                
                    <div class="flex items-center space-x-2 overflow-hidden">
                        <span class="text-[11px] font-black uppercase tracking-widest text-gray-400 whitespace-nowrap">CHỦ ĐIỂM:</span>
                        <span class="text-sm font-black uppercase tracking-wider text-blue-800 truncate max-w-[180px] md:max-w-none">HƯƠNG SẮC TRĂM MIỀN</span>
                    </div>
                </div>
            </div>
            <ul class="flex space-x-2 md:space-x-6 text-xs font-bold items-center relative">
                <!-- Home -->
                <li>
                    <a href="index.html" class="flex items-center text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Trang chủ
                    </a>
                </li>
                
                <!-- Lessons Dropdown -->
                <li class="relative group">
                    <button id="top-menu-lesson-btn" class="flex items-center text-gray-500 hover:text-blue-600 transition-colors focus:outline-none py-2">
                        Bài học
                        <svg class="w-4 h-4 ml-1 transition-transform duration-200" id="top-menu-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <!-- Dropdown Content (Hidden by default) -->
                     <div id="top-menu-lessons-dropdown" class="absolute top-full right-[-100px] md:right-auto md:left-1/2 md:-translate-x-1/2 mt-4 w-[320px] bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 hidden max-h-[70vh] overflow-y-auto z-[60] p-2">
                        <!-- Content rendered by floating-menu.js -->
                    </div>
                </li>

                <!-- Teacher -->
                <li>
                    <button onclick="openTeacherStats()" class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Giáo viên
                    </button>
                </li>
                
                <!-- Contact -->
                <li>
                    <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Liên hệ
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-2">

        <!-- Tab & Audio Header -->
        <div class="glass-card mb-4 rounded-2xl overflow-hidden flex flex-col md:flex-row items-stretch shadow-lg">
            <div class="flex-1 flex bg-white/40">
                <button onclick="switchTab('lesson')" id="btn-lesson"
                    class="tab-btn active flex-1 py-4 text-center font-black text-base text-gray-400 transition-all border-r border-gray-100/50 uppercase tracking-wider">
                    1. Bài học
                </button>
                <button onclick="switchTab('quiz')" id="btn-quiz"
                    class="tab-btn flex-1 py-4 text-center font-black text-base text-gray-400 transition-all uppercase tracking-wider">
                    2. Luyện tập
                </button>
            </div>

            <div id="audio-container"
                class="p-2 md:px-4 flex items-center bg-blue-50/20 border-t md:border-t-0 md:border-l border-gray-100/50">
                <div
                    class="flex items-center space-x-3 bg-white/60 backdrop-blur-md rounded-xl p-1.5 pr-4 border border-white shadow-inner">
                    <button id="audioControl" onclick="toggleAudio()"
                        class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center text-white hover:scale-105 active:scale-95 transition-all shadow-md shadow-blue-200">
                        <svg id="playIcon" class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col">
                        <span
                            class="text-[9px] font-black text-blue-600 uppercase tracking-widest leading-none mb-0.5 whitespace-nowrap">ĐỌC
                            MẪU</span>
                        <span id="audioStatus"
                            class="text-[10px] text-gray-400 font-bold italic leading-none whitespace-nowrap">Đang
                            dừng...</span>
                    </div>
                </div>
                <audio id="lessonAudio">
                    <source src="am_thanh/huongcommuathu.mp3" type="audio/mpeg">
                </audio>
            </div>
        </div>

        <!-- TAB 1: BÀI HỌC -->
        <div id="tab-lesson" class="tab-content active">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Cột trái (70%) - Bài đọc -->
                <section class="w-full lg:w-[70%]">
                    <div class="glass-card rounded-[40px] p-6 md:p-10 shadow-2xl">
                        <div
                            class="bg-paper rounded-[32px] p-8 md:p-12 shadow-inner border border-white/50 relative overflow-hidden">
                            <!-- Trang trí góc -->
                            <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-100/30 rounded-full blur-3xl"></div>
                            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-amber-100/30 rounded-full blur-3xl">
                            </div>

                            <h1
                                class="text-4xl font-black mb-12 text-blue-950 text-center uppercase tracking-tighter leading-tight relative">
                                <span
                                    class="bg-blue-600 w-12 h-1.5 absolute -bottom-4 left-1/2 -translate-x-1/2 rounded-full"></span>
                                HƯƠNG CỐM MÙA THU
                            </h1>

                            <div class="serif-font text-gray-800 text-lg leading-relaxed relative reading-content">
                                <div>
                                    <p class="mb-8 italic text-center">
                                        Tháng Chín heo may về phố<br>
                                        Dắt theo hương cốm vào thu<br>
                                        Sớm nay xôn xao ô cửa<br>
                                        Gió thơm vừa ghé – ô kìa!
                                    </p>
                                    <p class="mb-8 italic text-center">
                                        Gió kể: Ngày xưa hạt thóc<br>
                                        Trời đem gieo tặng nhà nông<br>
                                        Sớm khuya mồ hôi đổ xuống<br>
                                        Đợi mùa cây lúa trĩu bông!
                                    </p>
                                    <p class="mb-8 italic text-center">
                                        Hạt lúa tròn căng hơi sữa<br>
                                        Thảo thơm dâng tặng cho đời<br>
                                        Tay me, tay ba sàng sẩy<br>
                                        Cốm mang hồn đất, hồn người.
                                    </p>
                                    <p class="mb-8 italic text-center">
                                        Em thấy màu vàng của nắng<br>
                                        Em thấy màu xanh của trời<br>
                                        Em thấy màu nâu của đất<br>
                                        Ủ trong hạt cốm xanh ngời!
                                    </p>
                                    <p class="mb-8 italic text-center">
                                        Tháng Chín bước chân ra phố<br>
                                        Tay lùa từng ngón gió thơm<br>
                                        Hồ Gươm chớp đôi mắt biếc<br>
                                        Nhắc mùa hương cốm vừa lên!
                                    </p>
                                    <p class="text-right italic font-bold text-gray-600 mt-6 break-inside-avoid">(Bảo
                                        Ngọc)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Nội dung chính -->
                        <div
                            class="mt-8 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[32px] p-8 text-white relative overflow-hidden shadow-xl transform hover:scale-[1.01] transition-transform">
                            <div
                                class="absolute right-0 top-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl">
                            </div>
                            <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                                <div
                                    class="bg-white/20 backdrop-blur-md p-6 rounded-2xl border border-white/30 shadow-lg shrink-0 text-center min-w-[160px]">
                                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-100 mb-1">
                                        Thông điệp</p>
                                    <h3 class="text-2xl font-black uppercase tracking-tight">Ý NGHĨA</h3>
                                </div>
                                <div class="flex-grow">
                                    <p class="text-lg font-bold leading-relaxed text-blue-50">
                                        Cốm là một đặc sản tiêu biểu của Hà Nội, là một thức quà ngon. Cốm được làm từ
                                        những tinh túy của đất trời và bàn tay khéo léo, cần cù của người làm cốm, nhắc
                                        nhở chúng ta biết trân trọng công sức lao động của người nông dân.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Cột phải (30%) - Tìm hiểu bài -->
                <aside class="w-full lg:w-[30%]">
                    <div class="glass-card rounded-[40px] p-6 sticky top-28 shadow-xl border-amber-100/50">
                        <!-- Ảnh minh họa -->
                        <div class="mb-6 -mt-2 text-center">
                            <img src="hinh_anh/huong-com-mua-thu.png" alt="Hương cốm mùa thu"
                                class="w-full h-auto rounded-3xl object-contain drop-shadow-xl transform hover:scale-105 transition-transform duration-500 max-w-[240px] mx-auto">
                        </div>

                        <div class="flex items-center space-x-4 mb-8">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg shadow-amber-200">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-black text-gray-800 tracking-tight text-center lg:text-left">Tìm
                                hiểu bài</h2>
                        </div>

                        <div class="space-y-4">
                            <!-- Câu 1 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        1. Tìm trong khổ thơ thứ nhất những chi tiết nói về khung cảnh thiên nhiên và
                                        cảm xúc của con người khi mùa cốm đến.
                                    </span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium"><strong>Thiên nhiên:</strong> Tháng Chín, mùa
                                            thu, gió heo may thổi về phố. <br><strong>Cảm xúc:</strong> Xôn xao, ngỡ
                                            ngàng, vui mừng (Sớm nay xôn xao ô cửa, ô kìa!).</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 2 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        2. Dựa vào lời của gió, hãy kể lại hành trình làm ra hạt cốm.
                                    </span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Trời gieo hạt thóc -> Người nông dân vất vả chăm
                                            sóc -> Lúa trĩu bông -> Thu hoạch khi hạt tròn căng hơi sữa -> Qua bàn tay
                                            mẹ, ba sàng sẩy mới thành cốm.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 3 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        3. Cách tả màu sắc cho thấy bạn nhỏ cảm nhận thế nào về món quà kì diệu của mùa
                                        thu?
                                    </span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Bạn nhỏ nhận thấy cốm là sự góp sức của thiên
                                            nhiên (nắng vàng, trời xanh, đất nâu). Tất cả ủ trong hạt cốm xanh ngời kì
                                            diệu.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 4 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        4. Chi tiết nào cho thấy cốm là thức quà đặc trưng của Hà Nội?
                                    </span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Chi tiết nhắc đến "Hồ Gươm" - địa danh nổi tiếng
                                            của Thủ đô Hà Nội.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 5 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">
                                        5. Em cảm nhận được điều gì về tình cảm của tác giả đối với hương cốm?
                                    </span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Tác giả yêu tha thiết hương cốm và mùa thu Hà
                                            Nội; trân trọng, biết ơn thiên nhiên và người lao động; tự hào về thức quà
                                            quê hương.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- TAB 2: LUYỆN TẬP -->
        <div id="tab-quiz" class="tab-content">
            <div
                class="max-w-4xl mx-auto glass-card rounded-[40px] shadow-2xl overflow-hidden flex flex-col min-h-[500px]">
                <!-- Registration -->
                <div id="quiz-registration" class="p-4 md:p-8 flex-grow flex flex-col justify-center overflow-auto">
                    <div class="text-center mb-6">
                        <div
                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl shadow-blue-200 mx-auto transform -rotate-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-black text-gray-800 mb-1 tracking-tight">Đăng ký luyện tập</h2>
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">HƯƠNG CỐM MÙA THU</p>
                    </div>

                    <form onsubmit="startQuiz(event)" class="w-full max-w-sm mx-auto space-y-4">
                        <div class="relative group">
                            <input type="text" id="studentName" required placeholder="Họ và tên của em"
                                class="w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold placeholder:text-gray-300 shadow-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <select id="studentClass" required
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="">Chọn Lớp</option>
                                <option value="5/1">5/1</option>
                                <option value="5/2">5/2</option>
                                <option value="5/3">5/3</option>
                                <option value="5/4">5/4</option>
                                <option value="5/5">5/5</option>
                            </select>

                            <select id="schoolSelect" required onchange="checkSchool()"
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="Tiểu học Đỗ Văn Nại">TH Đỗ Văn Nại</option>
                                <option value="Khác">Trường khác...</option>
                            </select>
                        </div>

                        <input type="text" id="otherSchool" placeholder="Tên trường của em"
                            class="hidden w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all font-bold shadow-sm">

                        <button type="submit"
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-base uppercase tracking-wider">
                            Bắt đầu luyện tập
                        </button>
                    </form>
                </div>

                <!-- Quiz Body -->
                <div id="quiz-container" class="hidden flex flex-col h-full overflow-hidden">
                    <div
                        class="px-6 py-4 bg-white/20 border-b border-white/30 flex justify-between items-center shrink-0">
                        <div class="flex items-center space-x-4">
                            <span id="question-number"
                                class="text-xs font-black bg-blue-600 text-white px-3 py-1 rounded-full uppercase tracking-tighter shadow-lg shadow-blue-200">Câu
                                1/5</span>
                            <div class="h-2 w-32 md:w-64 bg-gray-100 rounded-full overflow-hidden shadow-inner flex">
                                <div id="progress-bar"
                                    class="h-full bg-gradient-to-r from-blue-500 to-indigo-600 transition-all duration-500 rounded-full"
                                    style="width: 20%"></div>
                            </div>
                        </div>
                        <div id="quiz-timer" class="text-sm font-black text-blue-600 font-mono flex items-center">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            00:00
                        </div>
                    </div>

                    <div class="p-6 md:p-10 flex-grow overflow-y-auto">
                        <h3 id="question-text" class="text-xl md:text-2xl font-black text-gray-800 mb-8 leading-tight">
                        </h3>
                        <div id="options-container" class="grid gap-4">
                            <!-- Options will be injected -->
                        </div>
                    </div>

                    <div class="p-6 bg-white/40 border-t border-white/50 flex justify-between items-center shrink-0">
                        <button id="prev-btn" onclick="prevQuestion()"
                            class="px-6 py-3 font-black text-gray-400 hover:text-blue-600 transition-colors uppercase tracking-widest text-xs flex items-center disabled:opacity-30 disabled:pointer-events-none">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                            Câu trước
                        </button>
                        <button id="next-btn" onclick="nextQuestion()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-2xl font-black transition-all active:scale-95 shadow-xl shadow-blue-200 flex items-center uppercase tracking-widest text-xs">
                            Câu sau
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="quiz-results" class="hidden p-6 md:p-12 flex-grow overflow-auto text-center">
                    <div id="result-animation" class="mb-8">
                        <!-- Result icon/animation -->
                    </div>
                    <h2 class="text-4xl font-black text-gray-800 mb-2">Kết quả của em</h2>
                    <p id="result-message"
                        class="text-gray-500 font-bold mb-8 italic uppercase tracking-widest text-xs">
                    </p>

                    <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto mb-10">
                        <div class="bg-blue-50 rounded-[32px] p-6 border border-blue-100 shadow-inner">
                            <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Điểm số</p>
                            <div id="result-score" class="text-5xl font-black text-blue-600 tracking-tighter">0</div>
                        </div>
                        <div class="bg-amber-50 rounded-[32px] p-6 border border-amber-100 shadow-inner">
                            <p class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-1">Thời gian
                            </p>
                            <div id="result-duration"
                                class="text-2xl font-black text-amber-600 h-full flex items-center justify-center">0s
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="restartQuiz()"
                            class="px-8 py-4 bg-gray-100 hover:bg-gray-200 text-gray-600 font-black rounded-2xl transition-all uppercase tracking-widest text-xs shadow-lg">Làm
                            lại</button>
                        <button id="submitResultsBtn" onclick="submitResults(event)"
                            class="px-10 py-4 bg-gradient-to-r from-blue-600 to-indigo-700 hover:scale-105 text-white font-black rounded-2xl transition-all shadow-xl shadow-blue-200 uppercase tracking-widest text-xs">Nộp
                            kết quả</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: LUYỆN TẬP -->
        <div id="tab-quiz" class="tab-content">
            <div
                class="max-w-4xl mx-auto glass-card rounded-[40px] shadow-2xl overflow-hidden flex flex-col min-h-[500px]">
                <!-- Registration -->
                <div id="quiz-registration" class="p-4 md:p-8 flex-grow flex flex-col justify-center overflow-auto">
                    <div class="text-center mb-6">
                        <div
                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl shadow-blue-200 mx-auto transform -rotate-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-black text-gray-800 mb-1 tracking-tight">Đăng ký luyện tập</h2>
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">HƯƠNG CỐM MÙA THU</p>
                    </div>

                    <form onsubmit="startQuiz(event)" class="w-full max-w-sm mx-auto space-y-4">
                        <div class="relative group">
                            <input type="text" id="studentName" required placeholder="Họ và tên của em"
                                class="w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold placeholder:text-gray-300 shadow-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <select id="studentClass" required
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="">Chọn Lớp</option>
                                <option value="5/1">5/1</option>
                                <option value="5/2">5/2</option>
                                <option value="5/3">5/3</option>
                                <option value="5/4">5/4</option>
                                <option value="5/5">5/5</option>
                            </select>

                            <select id="schoolSelect" required onchange="checkSchool()"
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="Tiểu học Đỗ Văn Nại">TH Đỗ Văn Nại</option>
                                <option value="Khác">Trường khác...</option>
                            </select>
                        </div>

                        <input type="text" id="otherSchool" placeholder="Tên trường của em"
                            class="hidden w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all font-bold shadow-sm">

                        <button type="submit"
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-base uppercase tracking-wider">
                            Bắt đầu luyện tập
                        </button>
                    </form>
                </div>

                <!-- Quiz Body -->
                <div id="quiz-container" class="hidden flex flex-col h-full overflow-hidden">
                    <div
                        class="px-6 py-4 bg-white/20 border-b border-white/30 flex justify-between items-center shrink-0">
                        <div class="flex items-center space-x-4">
                            <span id="question-number"
                                class="text-xs font-black bg-blue-600 text-white px-3 py-1 rounded-full uppercase tracking-tighter shadow-lg shadow-blue-200">Câu
                                1/5</span>
                            <div class="h-2 w-32 md:w-64 bg-gray-100 rounded-full overflow-hidden shadow-inner flex">
                                <div id="progress-bar"
                                    class="h-full bg-gradient-to-r from-blue-500 to-indigo-600 transition-all duration-500 rounded-full"
                                    style="width: 20%"></div>
                            </div>
                        </div>
                        <div id="quiz-timer" class="text-sm font-black text-blue-600 font-mono flex items-center">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            00:00
                        </div>
                    </div>

                    <div class="p-6 md:p-10 flex-grow overflow-y-auto">
                        <h3 id="question-text" class="text-xl md:text-2xl font-black text-gray-800 mb-8 leading-tight">
                        </h3>
                        <div id="options-container" class="grid gap-4">
                            <!-- Options will be injected -->
                        </div>
                    </div>

                    <div class="p-6 bg-white/40 border-t border-white/50 flex justify-between items-center shrink-0">
                        <button id="prev-btn" onclick="prevQuestion()"
                            class="px-6 py-3 font-black text-gray-400 hover:text-blue-600 transition-colors uppercase tracking-widest text-xs flex items-center disabled:opacity-30 disabled:pointer-events-none">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                            Câu trước
                        </button>
                        <button id="next-btn" onclick="nextQuestion()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-2xl font-black transition-all active:scale-95 shadow-xl shadow-blue-200 flex items-center uppercase tracking-widest text-xs">
                            Câu sau
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="quiz-results" class="hidden p-6 md:p-12 flex-grow overflow-auto text-center">
                    <div id="result-animation" class="mb-8">
                        <!-- Result icon/animation -->
                    </div>
                    <h2 class="text-4xl font-black text-gray-800 mb-2">Kết quả của em</h2>
                    <p id="result-message"
                        class="text-gray-500 font-bold mb-8 italic uppercase tracking-widest text-xs">
                    </p>

                    <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto mb-10">
                        <div class="bg-blue-50 rounded-[32px] p-6 border border-blue-100 shadow-inner">
                            <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Điểm số</p>
                            <div id="result-score" class="text-5xl font-black text-blue-600 tracking-tighter">0</div>
                        </div>
                        <div class="bg-amber-50 rounded-[32px] p-6 border border-amber-100 shadow-inner">
                            <p class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-1">Thời gian
                            </p>
                            <div id="result-duration"
                                class="text-2xl font-black text-amber-600 h-full flex items-center justify-center">0s
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="restartQuiz()"
                            class="px-8 py-4 bg-gray-100 hover:bg-gray-200 text-gray-600 font-black rounded-2xl transition-all uppercase tracking-widest text-xs shadow-lg">Làm
                            lại</button>
                        <button id="submitResultsBtn" onclick="submitResults(event)"
                            class="px-10 py-4 bg-gradient-to-r from-blue-600 to-indigo-700 hover:scale-105 text-white font-black rounded-2xl transition-all shadow-xl shadow-blue-200 uppercase tracking-widest text-xs">Nộp
                            kết quả</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal">
        <div class="success-card glass-card w-full max-w-sm rounded-[48px] p-8 text-center relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-green-100/50 rounded-full blur-2xl"></div>
            <div
                class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-600 rounded-[32px] flex items-center justify-center text-white mx-auto mb-8 shadow-2xl shadow-green-200 rotate-6 transform transition-transform hover:rotate-12">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-3xl font-black text-gray-800 mb-3 tracking-tighter">TUYỆT VỜI!</h3>
            <p class="text-gray-500 font-bold mb-8 leading-relaxed">
                Kết quả của em đã được gửi thành công. Cảm ơn em đã nỗ lực hoàn thành bài tập nhé!
            </p>
            <button onclick="closeSuccessModal()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-3xl shadow-xl shadow-blue-200 transition-all uppercase tracking-widest text-sm">
                ĐÓNG
            </button>
        </div>
    </div>

    <!-- Modal Teacher Stats -->
    <div id="statsModal" class="modal">
        <div class="bg-white w-full max-w-6xl rounded-[40px] shadow-2xl overflow-hidden flex flex-col h-[85vh]">
            <div class="bg-blue-600 p-8 text-white flex justify-between items-center shrink-0">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-md">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black tracking-tight">Thống kê kết quả học sinh</h2>
                        <p class="text-blue-200 text-xs font-bold uppercase tracking-widest">Hương Cốm Mùa Thu</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-white/60 hover:text-white transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="flex-grow overflow-auto p-8 pt-6">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex space-x-2">
                        <span
                            class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black uppercase tracking-wider border border-blue-100 italic">Dữ
                            liệu thời gian thực</span>
                    </div>
                    <button onclick="exportToExcel()"
                        class="bg-emerald-50 text-emerald-600 px-6 py-3 rounded-2xl hover:bg-emerald-600 hover:text-white transition-all font-black text-sm uppercase tracking-wider border border-emerald-100 flex items-center shadow-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Xuất Excel (XLSX)
                    </button>
                </div>

                <div class="bg-gray-50/50 rounded-3xl border border-gray-100 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-100/50">
                                <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">STT
                                </th>
                                <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">Họ
                                    và tên</th>
                                <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">Lớp
                                </th>
                                <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                    Trường</th>
                                <th
                                    class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">
                                    Điểm Cao Nhất</th>
                                <th
                                    class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">
                                    Số lần làm</th>
                                <th
                                    class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">
                                    Thời gian</th>
                                <th
                                    class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest text-right">
                                    Nộp gần nhất</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody" class="divide-y divide-gray-100 text-sm">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

        <footer class="py-5 px-4 mt-12 bg-white/30 backdrop-blur-md border-t border-white/50">
        <div class="container mx-auto text-center">
            <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em]">@ 2026 EduRobot - Hệ thống học
                tập thông minh</p>
            <p class="text-xs font-bold text-blue-600 mt-2">Phát triển bởi Lê Thành Long</p>
        </div>
    </footer>

            <script>
        function celebrate() { 
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#2563eb', '#f59e0b', '#10b981', '#ef4444'] }); 
            const audio = document.getElementById('clapSound');
            if (audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
        }
                // Tab switching
                function switchTab(tab) {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.getElementById('tab-' + tab).classList.add('active');
                    document.getElementById('btn-' + tab).classList.add('active');
                }

                // Accordion
                function toggleAccordion(btn) {
                    const item = btn.parentElement;
                    const isOpen = item.classList.contains('accordion-open');
                    document.querySelectorAll('.accordion-item').forEach(i => i.classList.remove('accordion-open'));
                    if (!isOpen) item.classList.add('accordion-open');
                }

                // Audio Player
                const audio = document.getElementById('lessonAudio');
                const playIcon = document.getElementById('playIcon');
                const pauseIcon = document.getElementById('pauseIcon');
                const audioStatus = document.getElementById('audioStatus');

                function toggleAudio() {
                    if (audio.paused) {
                        audio.play();
                        playIcon.classList.add('hidden');
                        pauseIcon.classList.remove('hidden');
                        audioStatus.innerText = "Đang phát...";
                        audioStatus.classList.add('text-blue-600');
                    } else {
                        audio.pause();
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                        audioStatus.innerText = "Đang dừng...";
                        audioStatus.classList.remove('text-blue-600');
                    }
                }

                audio.onended = () => {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    audioStatus.innerText = "Đã xong!";
                    audioStatus.classList.remove('text-blue-600');
                };

                /* QUIZ ENGINE */
                let questions = [];
                let currentQuestionIndex = 0;
                let score = 0;
                let userAnswers = [];
                let startTime, timerInterval;
                let studentData = {};

                const allQuestions = [
                    {
                        q: "Bài thơ 'Hương cốm mùa thu' của tác giả nào?",
                        o: ["Trần Đăng Khoa", "Bảo Ngọc", "Huy Cận", "Xuân Quỳnh"],
                        a: 1
                    },
                    {
                        q: "Mùa cốm bắt đầu vào tháng mấy?",
                        o: ["Tháng Tám", "Tháng Chín", "Tháng Mười", "Tháng Mười Một"],
                        a: 1
                    },
                    {
                        q: "Gió gì thổi về phố mang theo hương cốm?",
                        o: ["Gió mùa đông bắc", "Gió Lào", "Gió heo may", "Gió nam"],
                        a: 2
                    },
                    {
                        q: "Trong bài thơ, hạt lúa lúc còn non được ví với điều gì?",
                        o: ["Hạt ngọc", "Tròn căng hơi sữa", "Màu vàng nắng", "Màu xanh trời"],
                        a: 1
                    },
                    {
                        q: "Để có hạt cốm, ba và mẹ đã phải làm gì?",
                        o: ["Gieo hạt", "Cày cấy", "Sàng sẩy", "Tưới nước"],
                        a: 2
                    },
                    {
                        q: "Hạt cốm được ví mang 'hồn' của những gì?",
                        o: ["Của nắng và gió", "Của đất và người", "Của trời và mây", "Của hoa và lá"],
                        a: 1
                    },
                    {
                        q: "Bạn nhỏ thấy màu sắc nào 'ủ trong hạt cốm'?",
                        o: ["Vàng của nắng, xanh của trời, nâu của đất", "Đỏ của hoa, vàng của lá", "Tím của mây, hồng của nắng", "Trắng của mây, đen của đất"],
                        a: 0
                    },
                    {
                        q: "Địa danh nào ở Hà Nội được nhắc tới trong bài?",
                        o: ["Chùa Một Cột", "Hồ Gươm", "Lăng Bác", "Văn Miếu"],
                        a: 1
                    },
                    {
                        q: "Hình ảnh nào sau đây nói về vẻ đẹp của Hồ Gươm?",
                        o: ["Mặt nước phẳng lặng", "Chớp đôi mắt biếc", "Lá vàng rơi", "Tháp Rùa rêu phong"],
                        a: 1
                    },
                    {
                        q: "Hạt cốm là sản phẩm của sự kết hợp giữa điều gì?",
                        o: ["Chỉ do thiên nhiên ban tặng", "Chỉ do bàn tay con người làm ra", "Tinh túy đất trời và bàn tay lao động cần cù", "Sự may mắn của nhà nông"],
                        a: 2
                    },
                    {
                        q: "Từ nào mô tả âm thanh xôn xao bên ô cửa?",
                        o: ["Lặng lẽ", "Xôn xao", "Ồn ào", "Im lìm"],
                        a: 1
                    },
                    {
                        q: "Câu 'Hạt lúa tròn căng hơi sữa' sử dụng biện pháp nghệ thuật gì?",
                        o: ["So sánh", "Nhân hóa", "Ẩn dụ", "Điệp từ"],
                        a: 2
                    },
                    {
                        q: "Khổ thơ cuối bài nhắc nhở chúng ta điều gì về mùa hương cốm?",
                        o: ["Sắp hết mùa thu", "Mùa hương cốm vừa lên", "Nên đi mua cốm", "Hồ Gươm rất đẹp"],
                        a: 1
                    },
                    {
                        q: "Cảm xúc chủ đạo của bạn nhỏ trong bài thơ là gì?",
                        o: ["Buồn bã", "Sợ hãi", "Vui tươi, trân trọng", "Lo lắng"],
                        a: 2
                    },
                    {
                        q: "Bài thơ nhắc nhở chúng ta cần có thái độ gì với công sức lao động?",
                        o: ["Quên đi", "Bình thường", "Biết ơn và trân trọng", "Chê bai"],
                        a: 2
                    }
                ];

                function checkSchool() {
                    const select = document.getElementById('schoolSelect');
                    const otherInput = document.getElementById('otherSchool');
                    otherInput.classList.toggle('hidden', select.value !== 'Khác');
                    if (select.value === 'Khác') otherInput.focus();
                }

                function startQuiz(e) {
                    e.preventDefault();
                    studentData = {
                        studentName: document.getElementById('studentName').value,
                        studentClass: document.getElementById('studentClass').value,
                        school: document.getElementById('schoolSelect').value === 'Khác' ?
                            document.getElementById('otherSchool').value : document.getElementById('schoolSelect').value
                    };

                    // Shuffle and pick 5
                    questions = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, 5);
                    currentQuestionIndex = 0;
                    score = 0;
                    userAnswers = new Array(5).fill(null);

                    document.getElementById('quiz-registration').classList.add('hidden');
                    document.getElementById('quiz-container').classList.remove('hidden');

                    startTime = new Date();
                    startTimer();
                    showQuestion();
                }

                function startTimer() {
                    clearInterval(timerInterval);
                    timerInterval = setInterval(() => {
                        const duration = Math.floor((new Date() - startTime) / 1000);
                        const mins = Math.floor(duration / 60).toString().padStart(2, '0');
                        const secs = (duration % 60).toString().padStart(2, '0');
                        document.getElementById('quiz-timer').innerText = `${mins}:${secs}`;
                    }, 1000);
                }

                function showQuestion() {
            if(document.getElementById('quiz-feedback')) document.getElementById('quiz-feedback').style.opacity = '0';
                    const q = questions[currentQuestionIndex];
                    document.getElementById('question-number').innerText = `Câu ${currentQuestionIndex + 1}/5`;
                    document.getElementById('progress-bar').style.width = `${(currentQuestionIndex + 1) * 20}%`;
                    document.getElementById('question-text').innerText = q.q;

                    const container = document.getElementById('options-container');
                    container.innerHTML = '';

                    q.o.forEach((opt, idx) => {
                        const btn = document.createElement('button');
                        btn.className = `option-btn p-5 rounded-2xl text-left font-bold transition-all flex items-center group ${userAnswers[currentQuestionIndex] === idx ? 'selected' : 'bg-white'}`;
                        btn.innerHTML = `
                    <span class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-4 text-xs font-black group-hover:bg-blue-600 group-hover:text-white transition-colors">
                        ${String.fromCharCode(65 + idx)}
                    </span>
                    <span class="text-gray-700">${opt}</span>
                `;
                        btn.onclick = () => selectOption(idx);
                        container.appendChild(btn);
                    });

                    document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
                    document.getElementById('next-btn').innerText = currentQuestionIndex === 4 ? "Hoàn thành" : "Câu sau";
                }

                function selectOption(i, btn) {
            const currentQ = selectedQuestions[currentIdx];
            const isCorrect = i === currentQ.c;
            const feedback = document.getElementById('quiz-feedback');
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            if (isCorrect) {
                btn.classList.add('bg-green-50', 'border-green-500');
                btn.querySelector('div').classList.add('bg-green-600', 'text-white');
                if (feedback) { feedback.innerText = "CHÍNH XÁC! 🎉"; feedback.classList.add('text-green-600'); }
                score += 20;
            } else {
                btn.classList.add('bg-red-50', 'border-red-500');
                btn.querySelector('div').classList.add('bg-red-600', 'text-white');
                if (feedback) { feedback.innerText = "SAI RỒI! ❌"; feedback.classList.add('text-red-600'); }
                const correctBtn = document.querySelectorAll('.option-btn')[currentQ.c];
                if (correctBtn) correctBtn.classList.add('bg-green-50', 'border-green-500');
            }
            if (feedback) feedback.style.opacity = '1';
            setTimeout(() => {
                currentIdx++;
                (currentIdx < 5) ? showQuestion() : showResults();
            }, 1000);
        }

                function prevQuestion() {
                    if (currentQuestionIndex > 0) {
                        currentQuestionIndex--;
                        showQuestion();
                    }
                }

                function nextQuestion() {
                    if (userAnswers[currentQuestionIndex] === null) {
                        alert("Em vui lòng chọn một đáp án nhé!");
                        return;
                    }

                    if (currentQuestionIndex < 4) {
                        currentQuestionIndex++;
                        showQuestion();
                    } else {
                        finishQuiz();
                    }
                }

                function finishQuiz() {
                    clearInterval(timerInterval);
                    score = userAnswers.reduce((acc, ans, idx) => {
                        return acc + (ans === questions[idx].a ? 20 : 0);
                    }, 0);

                    const duration = Math.floor((new Date() - startTime) / 1000);
                    document.getElementById('result-score').innerText = score;
                    document.getElementById('result-duration').innerText = `${duration}s`;

                    let msg = "";
                    let anim = "";
                    if (score >= 80) {
                        msg = "Xuất sắc! Em rất am hiểu về bài thơ này!";
                        anim = "🎉";
                    } else if (score >= 60) {
                        msg = "Làm tốt lắm! Em đã hiểu bài khá chắc rồi đấy.";
                        anim = "👏";
                    } else {
                        msg = "Cố gắng lên em nhé! Hãy đọc lại bài thơ một lần nữa.";
                        anim = "💪";
                    }
                    document.getElementById('result-message').innerText = msg;
                    document.getElementById('result-animation').innerHTML = `<div class="text-7xl mb-4 animate-bounce">${anim}</div>`;

                    document.getElementById('quiz-container').classList.add('hidden');
                    document.getElementById('quiz-results').classList.remove('hidden');
                }

                function restartQuiz() {
                    document.getElementById('quiz-results').classList.add('hidden');
                    document.getElementById('quiz-registration').classList.remove('hidden');
                }

                // FIREBASE CONFIG
                const firebaseConfig = {
                    apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
                    authDomain: "gamhoctap.firebaseapp.com",
                    databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app",
                    projectId: "gamhoctap",
                    storageBucket: "gamhoctap.firebasestorage.app",
                    messagingSenderId: "833329613932",
                    appId: "1:833329613932:web:0d8574827bcfe50b535c49",
                    measurementId: "G-YT1PKCYS67"
                };
                firebase.initializeApp(firebaseConfig);
                const db = firebase.firestore();

                function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            document.getElementById('successModal').classList.add('hidden');
            restartQuiz();
            if (typeof switchTab === 'function') switchTab('lesson');
        }

                function submitResults(e) {
            if (e) e.preventDefault();
            const btn = document.querySelector('#quiz-results button:last-child');
            if (btn) { btn.innerHTML = "Đang nộp..."; btn.disabled = true; }
            const data = {
                studentName: document.getElementById('studentName').value,
                studentClass: document.getElementById('studentClass').value,
                school: document.getElementById('schoolSelect').value === 'Khác' ? document.getElementById('otherSchool').value : document.getElementById('schoolSelect').value,
                lessonTitle: document.title.replace(' - EduRobot', ''),
                score: score,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            let successShown = false;
            const showSuccess = () => {
                if (successShown) return;
                successShown = true;
                document.getElementById('successModal').classList.add('active');
                document.getElementById('successModal').classList.remove('hidden');
                celebrate();
                if (btn) { btn.innerHTML = "NỘP KẾT QUẢ"; btn.disabled = false; }
                let timeLeft = 5;
                const countdownEl = document.getElementById('countdown');
                const timer = setInterval(() => {
                    timeLeft--;
                    if (countdownEl) countdownEl.innerText = timeLeft;
                    if (timeLeft <= 0) { clearInterval(timer); closeSuccessModal(); }
                }, 1000);
            };
            const dbTimeout = setTimeout(() => { if (!successShown) showSuccess(); }, 3000);
            if (window.db || firebase.apps.length) {
                const database = window.db || firebase.firestore();
                database.collection("quiz_results").add(data).then(() => { clearTimeout(dbTimeout); showSuccess(); }).catch((err) => { console.error(err); clearTimeout(dbTimeout); showSuccess(); });
            } else { clearTimeout(dbTimeout); showSuccess(); }
        }

                /* TEACHER STATS */
                function openTeacherStats() {
                    const pin = prompt("Vui lòng nhập mã PIN bảo mật:");
                    if (pin === "dvn") {
                        document.getElementById('statsModal').classList.add('active');
                        loadStats();
                    } else if (pin !== null) {
                        alert("Mã PIN không chính xác!");
                    }
                }

                function closeModal() {
                    document.getElementById('statsModal').classList.remove('active');
                }

                let currentStatsData = [];
                async function loadStats() {
                    const tbody = document.getElementById('statsTableBody');
                    tbody.innerHTML = '<tr><td colspan="8" class="p-20 text-center"><div class="flex flex-col items-center"><div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div><p class="text-gray-400 font-black uppercase tracking-widest text-xs">Đang xử lý dữ liệu...</p></div></td></tr>';

                    try {
                        const snapshot = await db.collection("diem_tieng_viet_lop5")
                            .where("lessonTitle", "==", "Hương Cốm Mùa Thu")
                            .get();

                        if (snapshot.empty) {
                            tbody.innerHTML = '<tr><td colspan="8" class="p-20 text-center text-gray-400 font-bold italic">Chưa có dữ liệu học sinh nộp bài.</td></tr>';
                            return;
                        }

                        const studentGroups = {};
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const key = `${data.studentName}_${data.studentClass}_${data.school}`.toLowerCase().trim();

                            if (!studentGroups[key]) {
                                studentGroups[key] = {
                                    ...data,
                                    attempts: 1,
                                    bestScore: data.score,
                                    latestSubmitted: data.submittedAt ? data.submittedAt.toDate() : new Date(0)
                                };
                            } else {
                                studentGroups[key].attempts++;
                                if (data.score > studentGroups[key].bestScore) {
                                    studentGroups[key].bestScore = data.score;
                                    studentGroups[key].timeDisplay = data.timeDisplay;
                                }
                                const currentSubmitted = data.submittedAt ? data.submittedAt.toDate() : new Date(0);
                                if (currentSubmitted > studentGroups[key].latestSubmitted) {
                                    studentGroups[key].latestSubmitted = currentSubmitted;
                                }
                            }
                        });

                        currentStatsData = Object.values(studentGroups).sort((a, b) => b.bestScore - a.bestScore);

                        tbody.innerHTML = '';
                        currentStatsData.forEach((data, index) => {
                            const row = document.createElement('tr');
                            row.className = "hover:bg-blue-50/30 transition-colors group";
                            row.innerHTML = `
                        <td class="px-6 py-5 font-black text-gray-300 group-hover:text-blue-600 transition-colors">${index + 1}</td>
                        <td class="px-6 py-5">
                            <div class="font-black text-gray-800">${data.studentName}</div>
                        </td>
                        <td class="px-6 py-5">
                            <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider group-hover:bg-blue-100 group-hover:text-blue-700 transition-colors">${data.studentClass}</span>
                        </td>
                        <td class="px-6 py-5 text-gray-500 font-bold text-sm">${data.school}</td>
                        <td class="px-6 py-5 text-center">
                            <span class="text-xl font-black ${data.bestScore >= 80 ? 'text-green-600' : 'text-blue-600'}">${data.bestScore}</span>
                        </td>
                        <td class="px-6 py-5 text-center">
                            <span class="w-8 h-8 rounded-full bg-amber-50 text-amber-600 flex items-center justify-center mx-auto text-xs font-black border border-amber-100">${data.attempts}</span>
                        </td>
                        <td class="px-6 py-5 text-center font-bold text-gray-500 text-sm italic">${data.timeDisplay || 'N/A'}</td>
                        <td class="px-6 py-5 text-right">
                            <div class="text-[10px] font-black text-gray-400 uppercase tracking-tighter">${data.latestSubmitted.toLocaleDateString('vi-VN')}</div>
                            <div class="text-xs font-bold text-gray-800">${data.latestSubmitted.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
                        </td>
                    `;
                            tbody.appendChild(row);
                        });
                    } catch (err) {
                        console.error(err);
                        tbody.innerHTML = '<tr><td colspan="8" class="p-20 text-center text-red-500 font-bold">Lỗi khi tải dữ liệu. Hãy thử lại!</td></tr>';
                    }
                }

                function exportToExcel() {
                    if (currentStatsData.length === 0) {
                        alert("Không có dữ liệu để xuất!");
                        return;
                    }

                    const dataToExport = currentStatsData.map((item, index) => ({
                        'STT': index + 1,
                        'Họ và Tên': item.studentName,
                        'Lớp': item.studentClass,
                        'Trường': item.school,
                        'Điểm cao nhất': item.bestScore,
                        'Số lần làm': item.attempts,
                        'Thời gian làm bài (Lần tốt nhất)': item.timeDisplay || 'N/A',
                        'Lần nộp cuối': item.latestSubmitted.toLocaleString('vi-VN')
                    }));

                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    ws['!cols'] = [{}, {}, { t: 's' }, {}, {}, {}, {}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "KetQua");
                    XLSX.writeFile(wb, "KetQua_HuongComMuaThu.xlsx");
                }
            </script>
            

    <!-- Audio Celebration -->
    <audio id="clapSound" src="https://www.soundjay.com/human/applause-01.mp3" preload="auto"></audio>
<script src="js/floating-menu.js"></script>
</body>

</html>
