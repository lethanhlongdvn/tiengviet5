<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đường quê Đồng Tháp Mười - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- SheetJS for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        .hidden {
            display: none !important;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
        }

        .bg-paper {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .tab-btn.active {
            color: var(--primary);
            background: white;
            box-shadow: inset 0 -3px 0 var(--primary);
        }

        .tab-content {
            display: none !important;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block !important;
        }

        #tab-quiz.active {
            display: flex !important;
        }

        /* Compact Quiz styles */
        #quiz-container {
            height: calc(100vh - 180px);
            max-height: 600px;
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid #e2e8f0;
        }

        .option-btn:hover:not(:disabled) {
            transform: translateX(4px);
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option-btn.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Accordion Custom */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-open {
            background: white !important;
            border-color: var(--primary) !important;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1) !important;
        }

        .accordion-open .accordion-content {
            max-height: 500px;
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* Success Modal Styles */
        .success-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1200;
            padding: 1rem;
        }

        .success-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reading-content p {
            margin-bottom: 1.5rem;
            text-align: justify;
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="sticky top-0 z-50 px-4 py-2">
                                <nav class="container mx-auto glass-card rounded-xl px-5 py-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 shrink-0">
                    <span class="text-xl font-black">E</span>
                </div>
                <div class="flex flex-col md:flex-row md:items-center md:space-x-6">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl font-black text-blue-700">EduRobot</span>
                        <span class="text-[11px] font-bold px-3 py-1 rounded-full bg-orange-500 text-white shadow-sm shadow-orange-200 tracking-wide whitespace-nowrap">TIẾNG VIỆT 5</span>
                    </div>
                
                    <div class="flex items-center space-x-2 overflow-hidden">
                        <span class="text-[11px] font-black uppercase tracking-widest text-gray-400 whitespace-nowrap">CHỦ ĐIỂM:</span>
                        <span class="text-sm font-black uppercase tracking-wider text-blue-800 truncate max-w-[180px] md:max-w-none">HƯƠNG SẮC TRĂM MIỀN</span>
                    </div>
                </div>
            </div>
            <ul class="flex space-x-2 md:space-x-6 text-xs font-bold items-center relative">
                <!-- Home -->
                <li>
                    <a href="index.html" class="flex items-center text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Trang chủ
                    </a>
                </li>
                
                <!-- Lessons Dropdown -->
                <li class="relative group">
                    <button id="top-menu-lesson-btn" class="flex items-center text-gray-500 hover:text-blue-600 transition-colors focus:outline-none py-2">
                        Bài học
                        <svg class="w-4 h-4 ml-1 transition-transform duration-200" id="top-menu-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <!-- Dropdown Content (Hidden by default) -->
                     <div id="top-menu-lessons-dropdown" class="absolute top-full right-[-100px] md:right-auto md:left-1/2 md:-translate-x-1/2 mt-4 w-[320px] bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 hidden max-h-[70vh] overflow-y-auto z-[60] p-2">
                        <!-- Content rendered by floating-menu.js -->
                    </div>
                </li>

                <!-- Teacher -->
                <li>
                    <button onclick="openTeacherStats()" class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Giáo viên
                    </button>
                </li>
                
                <!-- Contact -->
                <li>
                    <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Liên hệ
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-2">

        <!-- Tab & Audio Header -->
        <div class="glass-card mb-4 rounded-2xl overflow-hidden flex flex-col md:flex-row items-stretch shadow-lg">
            <div class="flex-1 flex bg-white/40">
                <button onclick="switchTab('lesson')" id="btn-lesson"
                    class="tab-btn active flex-1 py-4 text-center font-black text-base text-gray-400 transition-all border-r border-gray-100/50 uppercase tracking-wider">
                    1. Bài học
                </button>
                <button onclick="switchTab('quiz')" id="btn-quiz"
                    class="tab-btn flex-1 py-4 text-center font-black text-base text-gray-400 transition-all uppercase tracking-wider">
                    2. Luyện tập
                </button>
            </div>

            <div id="audio-container"
                class="p-2 md:px-4 flex items-center bg-blue-50/20 border-t md:border-t-0 md:border-l border-gray-100/50">
                <div
                    class="flex items-center space-x-3 bg-white/60 backdrop-blur-md rounded-xl p-1.5 pr-4 border border-white shadow-inner">
                    <button id="audioControl" onclick="toggleAudio()"
                        class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center text-white hover:scale-105 active:scale-95 transition-all shadow-md shadow-blue-200">
                        <svg id="playIcon" class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col">
                        <span
                            class="text-[9px] font-black text-blue-600 uppercase tracking-widest leading-none mb-0.5 whitespace-nowrap">ĐỌC
                            MẪU</span>
                        <span id="audioStatus"
                            class="text-[10px] text-gray-400 font-bold italic leading-none whitespace-nowrap">Đang
                            dừng...</span>
                    </div>
                </div>
                <audio id="lessonAudio">
                    <source src="am_thanh/duongquedongthapmuoi.mp3" type="audio/mpeg">
                </audio>
            </div>
        </div>

        <!-- TAB 1: BÀI HỌC -->
        <div id="tab-lesson" class="tab-content active">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Cột trái (70%) - Bài đọc -->
                <section class="w-full lg:w-[70%]">
                    <div class="glass-card rounded-[40px] p-6 md:p-10 shadow-2xl">
                        <div
                            class="bg-paper rounded-[32px] p-8 md:p-12 shadow-inner border border-white/50 relative overflow-hidden">
                            <!-- Trang trí góc -->
                            <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-100/30 rounded-full blur-3xl"></div>
                            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-amber-100/30 rounded-full blur-3xl">
                            </div>

                            <h1
                                class="text-4xl font-black mb-12 text-blue-950 text-center uppercase tracking-tighter leading-tight relative">
                                <span
                                    class="bg-blue-600 w-12 h-1.5 absolute -bottom-4 left-1/2 -translate-x-1/2 rounded-full"></span>
                                ĐƯỜNG QUÊ ĐỒNG THÁP MƯỜI
                            </h1>
                            <p class="text-center font-black text-gray-500 mb-8 -mt-8">Trần Quốc Toàn</p>

                            <div class="serif-font text-gray-800 text-lg leading-relaxed relative reading-content">
                                <div class="text-center italic">
                                    <p class="mb-6">
                                        Bông súng thả lồng đèn<br>
                                        Sáng bồng bềnh mặt nước<br>
                                        Cá lòng tong chạy trước<br>
                                        Dẫn đường về thăm ông.
                                    </p>
                                    <p class="mb-6">
                                        Đường quê, sào vít cong<br>
                                        Xuồng lướt như tên bắn<br>
                                        Cò ở đâu giật mình<br>
                                        Bay lẫn vào mây trắng.
                                    </p>
                                    <p class="mb-6">
                                        Lấm lem con trâu đầm<br>
                                        Chém cặp sừng loé nắng<br>
                                        Xình xịch thuyền đuôi tôm<br>
                                        Chở lúa vàng, rẽ sóng.
                                    </p>
                                    <p class="mb-6">
                                        Kìa mấy búp sen hồng<br>
                                        Nối đầu thu, cuối hạ<br>
                                        Nước lớn sông Cửu Long<br>
                                        Chơi với sen nghiêng ngả.
                                    </p>
                                    <p class="mb-6">
                                        Về xứ mười tầng tháp<br>
                                        Leo cầu trăm đốt tre<br>
                                        Ông đứng như bụt hiện<br>
                                        Chờ cháu cuối đường quê.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Nội dung chính -->
                        <div
                            class="mt-8 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[32px] p-8 text-white relative overflow-hidden shadow-xl transform hover:scale-[1.01] transition-transform">
                            <div
                                class="absolute right-0 top-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl">
                            </div>
                            <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                                <div
                                    class="bg-white/20 backdrop-blur-md p-6 rounded-2xl border border-white/30 shadow-lg shrink-0 text-center min-w-[160px]">
                                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-100 mb-1">
                                        Thông điệp</p>
                                    <h3 class="text-2xl font-black uppercase tracking-tight">Ý NGHĨA</h3>
                                </div>
                                <div class="flex-grow">
                                    <p class="text-lg font-bold leading-relaxed text-blue-50">
                                        Bài thơ ca ngợi vẻ đẹp riêng biệt của cảnh vật thiên nhiên, cuộc sống sinh hoạt
                                        sôi động và tâm hồn đôn hậu, chất phác của con người vùng Đồng Tháp Mười - nơi
                                        có hệ thống sông ngòi, kênh rạch chằng chịt.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Cột phải (30%) - Tìm hiểu bài -->
                <aside class="w-full lg:w-[30%]">
                    <div class="glass-card rounded-[40px] p-6 sticky top-28 shadow-xl border-amber-100/50">
                        <!-- Ảnh minh họa -->
                        <div class="mb-6 -mt-2 text-center">
                            <img src="hinh_anh/dong-thap-muoi.png" alt="Đồng Tháp Mười"
                                class="w-full h-auto rounded-3xl object-contain drop-shadow-xl transform hover:scale-105 transition-transform duration-500 max-w-[240px] mx-auto">
                        </div>

                        <div class="flex items-center space-x-4 mb-8">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg shadow-amber-200">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-black text-gray-800 tracking-tight">Tìm hiểu bài</h2>
                        </div>

                        <div class="space-y-4">
                            <!-- Câu 1 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">1.
                                        Ở khổ thơ đầu, đường về quê thú vị như thế nào?</span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Đường về quê rất thú vị với các hình ảnh: bông
                                            súng nở đẹp như đang "thả lồng đèn", sáng bồng bềnh; những chú cá lòng tong
                                            bơi lội tung tăng như đang dẫn đường về thăm ông.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 2 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">2.
                                        Tìm những nét đẹp riêng của vùng Đồng Tháp Mười?</span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Về thiên nhiên: sông nước với sào vít cong, xuồng
                                            lướt nhanh, thuyền đuôi tôm, búp sen hồng, cầu trăm đốt tre. Về con người:
                                            người ông hiền hậu, đứng chờ cháu như "bụt hiện".</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 3 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">3.
                                        Những từ ngữ nào gợi tả nhịp sống sôi động, náo nức?</span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Những từ ngữ: lướt như tên bắn, giật mình, chém
                                            (cặp sừng), xình xịch, rẽ sóng, nước lớn, nghiêng ngả.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 4 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">4.
                                        Bạn nhỏ muốn nói điều gì về quê hương mình?</span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Bạn nhỏ ca ngợi quê hương Đồng Tháp Mười đẹp đẽ,
                                            mộc mạc và chất phác. Thể hiện tình yêu quê hương, con người qua những hình
                                            ảnh hiền lành và tốt đẹp nhất.</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Câu 5 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span
                                        class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors text-sm">5.
                                        Những chi tiết nào gợi nhớ truyện cổ tích?</span>
                                    <div
                                        class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0 ml-2">
                                        <svg class="w-3 h-3 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-green-600">Gợi
                                                ý trả lời</span>
                                        </div>
                                        <p class="text-sm font-medium">Chi tiết: "Cầu trăm đốt tre" (gợi nhớ truyện Cây
                                            tre trăm đốt) và "Ông đứng như bụt hiện" (gợi nhớ hình ảnh ông Bụt trong cổ
                                            tích).</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- TAB 2: LUYỆN TẬP -->
        <div id="tab-quiz" class="tab-content">
            <div
                class="max-w-4xl mx-auto glass-card rounded-[40px] shadow-2xl overflow-hidden flex flex-col min-h-[500px]">
                <!-- Registration -->
                <div id="quiz-registration" class="p-8 flex-grow flex flex-col justify-center text-center">
                    <div class="mb-6">
                        <div
                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl shadow-blue-200 mx-auto transform -rotate-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-black text-gray-800 mb-1 tracking-tight">Đăng ký luyện tập</h2>
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Đường quê Đồng Tháp Mười
                        </p>
                    </div>

                    <form id="regForm" class="w-full max-w-sm mx-auto space-y-4">
                        <input type="text" id="studentName" required placeholder="Họ và tên của em"
                            class="w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold placeholder:text-gray-300 shadow-sm">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="studentClass" required
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="">Chọn Lớp</option>
                                <option value="5/1">5/1</option>
                                <option value="5/2">5/2</option>
                                <option value="5/3">5/3</option>
                                <option value="5/4">5/4</option>
                                <option value="5/5">5/5</option>
                            </select>
                            <select id="schoolSelect" required onchange="checkSchool()"
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="Tiểu học Đỗ Văn Nại">TH Đỗ Văn Nại</option>
                                <option value="Khác">Khác...</option>
                            </select>
                        </div>
                        <input type="text" id="otherSchool" placeholder="Tên trường của em"
                            class="hidden w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all font-bold shadow-sm">
                        <button type="submit"
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-base uppercase tracking-wider">Bắt
                            đầu luyện tập</button>
                    </form>
                </div>

                <!-- Quiz Engine -->
                <div id="quiz-container" class="hidden flex-grow flex flex-col">
                    <div class="bg-blue-600/5 px-6 py-4 flex justify-between items-center border-b border-blue-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center font-black mr-4 shadow-lg shadow-blue-200"
                                id="questionNum">1</div>
                            <div class="flex flex-col">
                                <span
                                    class="text-[10px] font-black text-blue-600 uppercase tracking-widest leading-none mb-1"
                                    id="progressText">CÂU TRẮC NGHIỆM: 1/5</span>
                                <span class="text-xs text-gray-400 font-bold leading-none">Đường quê Đồng Tháp
                                    Mười</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 flex-grow flex flex-col justify-center overflow-auto">
                        <h3 class="text-xl md:text-2xl font-black text-gray-800 mb-6 leading-tight transition-all"
                            id="questionText"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="optionsArea"></div>
                    </div>
                    <div class="px-6 py-4 border-t border-gray-50 flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold text-gray-400 italic">* Chọn đáp án đúng nhất</span>
                        <button id="nextBtn" disabled
                            class="bg-blue-600 disabled:opacity-30 hover:bg-blue-700 text-white font-black py-3 px-10 rounded-2xl shadow-lg shadow-blue-100 transition-all active:scale-95 uppercase text-sm tracking-widest">Câu
                            tiếp theo</button>
                    </div>
                </div>

                <!-- Results -->
                <div id="quiz-results"
                    class="hidden p-8 flex-grow flex flex-col items-center justify-center text-center">
                    <div class="relative w-40 h-40 mb-8">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="80" cy="80" r="74" stroke="currentColor" stroke-width="12" fill="transparent"
                                class="text-gray-100" />
                            <circle id="scoreCircle" cx="80" cy="80" r="74" stroke="url(#scoreGrad)" stroke-width="12"
                                fill="transparent" class="transition-all duration-1000 ease-out"
                                stroke-dasharray="0, 465" stroke-linecap="round" />
                            <defs>
                                <linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#3b82f6" />
                                    <stop offset="100%" stop-color="#818cf8" />
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-800">
                            <span class="text-5xl font-black" id="scoreText">0</span>
                            <span class="text-[10px] text-gray-400 font-black uppercase tracking-[0.2em] mt-1">Điểm
                                số</span>
                        </div>
                    </div>
                    <h2 class="text-3xl font-black text-gray-800 mb-2" id="resultTitle">Hoàn thành!</h2>
                    <p class="text-gray-500 mb-10 max-w-sm font-bold" id="resultMsg">
<div class="mb-8 text-blue-600 font-black text-sm uppercase tracking-widest mt-4">Tự động quay lại sau <span id="countdown">5</span> giây</div></p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-md">
                        <button onclick="restartQuiz()"
                            class="bg-white hover:bg-gray-50 text-gray-700 font-black py-4 rounded-2xl border-2 border-gray-100 transition-all shadow-sm">LÀM
                            LẠI</button>
                        <button onclick="submitResults(event)"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-100 transition-all">NỘP
                            KẾT QUẢ</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal">
        <div class="glass-card rounded-[40px] p-10 max-w-sm w-full text-center shadow-3xl border-white/50">
            <div
                class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-xl shadow-green-100 transform rotate-6 scale-110">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-3xl font-black text-gray-800 mb-2 tracking-tight">Thành công!</h2>
            <p class="text-gray-500 mb-10 font-bold leading-relaxed">Kết quả của em đã được lưu thành công!</p>
            <button onclick="closeSuccessModal()"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 uppercase tracking-widest text-sm">Trở
                về bài học</button>
        </div>
    </div>

    <!-- Modal Stats -->
    <div id="statsModal" class="modal">
        <div
            class="bg-white rounded-[40px] w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl m-4 transform transition-all">
            <div class="p-8 border-b flex justify-between items-center bg-gray-50/50 backdrop-blur-xl">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-gray-800">Kết quả học tập</h2>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Học sinh lớp 5</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="exportToExcel()"
                        class="bg-green-600 hover:bg-green-700 text-white font-black py-3 px-6 rounded-2xl text-sm flex items-center shadow-lg transition-all active:scale-95">XUẤT
                        EXCEL</button>
                    <button onclick="closeModal()"
                        class="w-12 h-12 flex items-center justify-center text-gray-400 hover:text-gray-800"><svg
                            class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg></button>
                </div>
            </div>
            <div class="flex-grow overflow-auto p-8 pt-6">
                <div class="bg-gray-50/50 rounded-3xl border border-gray-100 overflow-hidden shadow-sm">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-gray-100/50">
                                <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">STT
                                </th>
                                <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">Học
                                    sinh</th>
                                <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">Lớp
                                </th>
                                <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                    Trường</th>
                                <th
                                    class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">
                                    Điểm số</th>
                                <th
                                    class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">
                                    Thời gian</th>
                                <th
                                    class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase tracking-widest text-right">
                                    Ngày nộp</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody" class="divide-y divide-gray-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

        <footer class="py-5 px-4 mt-12 bg-white/30 backdrop-blur-md border-t border-white/50">
        <div class="container mx-auto text-center">
            <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em]">@ 2026 EduRobot - Hệ thống học
                tập thông minh</p>
            <p class="text-xs font-bold text-blue-600 mt-2">Phát triển bởi Lê Thành Long</p>
        </div>
    </footer>

    <script>

        function celebrate() { 
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#2563eb', '#f59e0b', '#10b981', '#ef4444'] }); 
            const audio = document.getElementById('clapSound');
            if (audio) { audio.currentTime = 0; audio.play().catch(e => {}); }
        }
        
        const allQuestions = [
            { q: "Loài hoa nào được ví như những chiếc 'lồng đèn' thả trên mặt nước trong khổ thơ đầu?", a: ["Hoa sen", "Hoa phượng", "Bông súng", "Hoa mai"], c: 2 },
            { q: "Con vật nào được nhân hóa với hành động 'chạy trước dẫn đường' về thăm ông?", a: ["Con chó mực", "Con trâu", "Cá lòng tong", "Con cò trắng"], c: 2 },
            { q: "Hình ảnh 'Xuồng lướt như tên bắn' sử dụng biện pháp nghệ thuật gì?", a: ["Nhân hóa", "So sánh", "Điệp ngữ", "Ẩn dụ"], c: 1 },
            { q: "Khi chiếc xuồng lướt nhanh, con vật nào đã 'giật mình' bay lẫn vào mây trắng?", a: ["Con chim sẻ", "Con bướm", "Con cò", "Con chuồn chuồn"], c: 2 },
            { q: "Trong khổ 3, hình ảnh con trâu đầm được miêu tả với hành động mạnh mẽ nào?", a: ["Gõ cặp sừng", "Chém cặp sừng loé nắng", "Húc cặp sừng", "Lắc cặp sừng"], c: 1 },
            { q: "Phương tiện nào phát ra tiếng kêu 'xình xịch' và chở lúa vàng rẽ sóng?", a: ["Xuồng ba lá", "Ghe bầu", "Thuyền đuôi tôm", "Phà máy"], c: 2 },
            { q: "Búp sen hồng ở Đồng Tháp Mười nở vào khoảng thời gian nào?", a: ["Mùa xuân", "Mùa đông", "Nối đầu thu, cuối hạ", "Quanh năm"], c: 2 },
            { q: "Dòng sông nào được nhắc đến trong câu 'Chơi với sen nghiêng ngả'?", a: ["Sông Hồng", "Sông Hương", "Sông Cửu Long", "Sông Đồng Nai"], c: 2 },
            { q: "Cụm từ 'Xứ mười tầng tháp' dùng để chỉ vùng đất nào?", a: ["Mũi Cà Mau", "Tây Nguyên", "Đồng Tháp Mười", "Thành phố Hồ Chí Minh"], c: 2 },
            { q: "Chi tiết 'Leo cầu trăm đốt tre' gợi nhớ đến câu chuyện cổ tích nào?", a: ["Thánh Gióng", "Thạch Sanh", "Cây tre trăm đốt", "Tấm Cám"], c: 2 },
            { q: "Hình ảnh người ông đứng chờ cháu được so sánh với nhân vật nào?", a: ["Ông Tiên", "Ông Bụt", "Ông đồ", "Ông lão đánh cá"], c: 1 },
            { q: "Các từ ngữ: 'lướt như tên bắn', 'xình xịch', 'rẽ sóng' gợi tả điều gì về nhịp sống nơi đây?", a: ["Nhịp sống chậm rãi, buồn tẻ", "Nhịp sống sôi động, náo nức và khẩn trương", "Nhịp sống yên tĩnh, vắng vẻ", "Nhịp sống lo âu, vất vả"], c: 1 },
            { q: "Biện pháp nhân hóa được sử dụng trong câu thơ nào dưới đây?", a: ["Xuồng lướt như tên bắn", "Ông đứng như bụt hiện", "Nước lớn sông Cửu Long / Chơi với sen nghiêng ngả", "Lấm lem con trâu đầm"], c: 2 },
            { q: "Qua bài thơ, em thấy con người Đồng Tháp Mười hiện lên như thế nào?", a: ["Giàu sang và xa cách", "Hiền lành, chất phác và đôn hậu (như Bụt)", "Khó tính và nghiêm khắc", "Thích phiêu lưu mạo hiểm"], c: 1 },
            { q: "Nội dung chính của bài thơ là gì?", a: ["Miêu tả quy trình thu hoạch lúa", "Kể về chuyến đi thăm ông của bạn nhỏ", "Ca ngợi vẻ đẹp thiên nhiên độc đáo, cuộc sống sôi động và con người đôn hậu của Đồng Tháp Mười", "Giới thiệu các loại phương tiện giao thông đường thủy"], c: 2 }
        ];

        let selectedQuestions = [], currentIdx = 0, score = 0, studentData = {}, startTime = null;

        const firebaseConfig = { apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc", authDomain: "gamhoctap.firebaseapp.com", databaseURL: "https://gamhoctap-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "gamhoctap", storageBucket: "gamhoctap.firebasestorage.app", messagingSenderId: "833329613932", appId: "1:833329613932:web:0d8574827bcfe50b535c49", measurementId: "G-YT1PKCYS67" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function toggleAccordion(btn) { const itm = btn.parentElement; const opn = itm.classList.contains('accordion-open'); document.querySelectorAll('.accordion-item').forEach(el => el.classList.remove('accordion-open')); if (!opn) itm.classList.add('accordion-open'); }
        const audio = document.getElementById('lessonAudio'), playIcon = document.getElementById('playIcon'), pauseIcon = document.getElementById('pauseIcon'), audioStatus = document.getElementById('audioStatus');
        function toggleAudio() { if (audio.paused) { audio.play(); playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); audioStatus.innerText = "Đang phát..."; } else { audio.pause(); playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); audioStatus.innerText = "Đang dừng..."; } }
        audio.onended = () => { playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); audioStatus.innerText = "Đang dừng..."; };
        function switchTab(t) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById('btn-' + t).classList.add('active'); document.getElementById('tab-' + t).classList.add('active'); }
        function checkSchool() { const s = document.getElementById('schoolSelect'), o = document.getElementById('otherSchool'); if (s.value === 'Khác') { o.classList.remove('hidden'); o.required = true; } else { o.classList.add('hidden'); o.required = false; } }

        document.getElementById('regForm').onsubmit = (e) => {
            e.preventDefault();
            studentData = { studentName: document.getElementById('studentName').value, studentClass: document.getElementById('studentClass').value, school: document.getElementById('schoolSelect').value === 'Khác' ? document.getElementById('otherSchool').value : document.getElementById('schoolSelect').value };
            selectedQuestions = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, 5); currentIdx = 0; score = 0; startTime = new Date();
            document.getElementById('quiz-registration').classList.add('hidden'); document.getElementById('quiz-container').classList.remove('hidden'); showQuestion();
        };

        function showQuestion() {
            const q = selectedQuestions[currentIdx];
            document.getElementById('questionNum').innerText = currentIdx + 1;
            document.getElementById('progressText').innerText = `CÂU TRẮC NGHIỆM: ${currentIdx + 1}/5`;
            document.getElementById('questionText').innerText = q.q;
            const area = document.getElementById('optionsArea'); area.innerHTML = '';
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button'); btn.className = "option-btn w-full p-4 text-left bg-white rounded-2xl font-bold flex items-center group shadow-sm";
                btn.innerHTML = `<div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-4 group-hover:bg-blue-600 group-hover:text-white transition-all text-xs font-black shadow-inner">${String.fromCharCode(65 + i)}</div><span class="flex-1 text-sm md:text-base text-gray-700">${opt}</span>`;
                btn.onclick = () => {
                    const currentQ = selectedQuestions[currentIdx];
                    const isCorrect = i === currentQ.c;
                    const feedback = document.getElementById('quiz-feedback');
                    document.querySelectorAll('#optionsArea button').forEach(b => b.disabled = true);
                    if (isCorrect) {
                        btn.classList.add('bg-green-50', 'border-green-500');
                        btn.querySelector('div, span').classList.add('bg-green-600', 'text-white');
                        if (feedback) { feedback.innerText = "CHÍNH XÁC! 🎉"; feedback.classList.add('text-green-600'); }
                        score += 20;
                    } else {
                        btn.classList.add('bg-red-50', 'border-red-500');
                        btn.querySelector('div, span').classList.add('bg-red-600', 'text-white');
                        if (feedback) { feedback.innerText = "SAI RỒI! ❌"; feedback.classList.add('text-red-600'); }
                        const correctBtn = document.querySelectorAll('#optionsArea button')[currentQ.c];
                        if (correctBtn) correctBtn.classList.add('bg-green-50', 'border-green-500');
                    }
                    if (feedback) feedback.style.opacity = '1';
                    setTimeout(() => {
                        currentIdx++;
                        (currentIdx < 5) ? showQuestion() : showResults();
                    }, 1000);
                };;;
                area.appendChild(btn);
            });
            document.getElementById('nextBtn').disabled = true;
        }

        document.getElementById('nextBtn').onclick = () => {
            if (parseInt(document.getElementById('nextBtn').dataset.selected) === selectedQuestions[currentIdx].c) score += 20;
            currentIdx++; if (currentIdx < 5) showQuestion(); else showResults();
        };

        function showResults() {
            document.getElementById('quiz-container').classList.add('hidden'); document.getElementById('quiz-results').classList.remove('hidden');
            document.getElementById('scoreText').innerText = score; document.getElementById('scoreCircle').style.strokeDasharray = `${(score / 100) * 465}, 465`;
            const msg = score >= 80 ? "Xuất sắc! Em hiểu bài rất tốt." : score >= 60 ? "Làm tốt lắm! Em đã nắm vững kiến thức." : "Cố gắng lên! Hãy xem lại bài nhé.";
            document.getElementById('resultMsg').innerText = msg;
        }

        function restartQuiz() { document.getElementById('quiz-results').classList.add('hidden'); document.getElementById('quiz-registration').classList.remove('hidden'); }

        
            function closeSuccessModal() {
                document.getElementById('successModal').classList.remove('active');
                document.getElementById('successModal').classList.add('hidden');
                restartQuiz();
                switchTab('lesson');
            }

            
            function closeSuccessModal() {
                document.getElementById('successModal').classList.remove('active');
                document.getElementById('successModal').classList.add('hidden');
                restartQuiz();
                switchTab('lesson');
            }

            function submitResults(e) {
                if (e) e.preventDefault();
                const btn = e.target || document.querySelector('#quiz-results button:last-child');
                if (btn) { btn.innerHTML = "Đang nộp..."; btn.disabled = true; }
                const data = {
                    studentName: document.getElementById('studentName').value,
                    studentClass: document.getElementById('studentClass').value || studentData.studentClass || studentData.className,
                    school: document.getElementById('schoolSelect').value === 'Khác' || document.getElementById('schoolSelect').value === 'other' ? document.getElementById('otherSchool').value : document.getElementById('schoolSelect').value,
                    lessonTitle: "Đường quê Đồng Tháp Mười",
                    score: score,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                let successShown = false;
                const showSuccess = () => {
                    if (successShown) return;
                    successShown = true;
                    const modal = document.getElementById('successModal');
                    if(modal) {
                        modal.classList.add('active');
                        modal.classList.remove('hidden');
                    }
                    celebrate();
                    let timeLeft = 5;
                    const countdownEl = document.getElementById('countdown');
                    const timer = setInterval(() => {
                        timeLeft--;
                        if (countdownEl) countdownEl.innerText = timeLeft;
                        if (timeLeft <= 0) { clearInterval(timer); closeSuccessModal(); }
                    }, 1000);
                };
                const dbTimeout = setTimeout(() => { if (!successShown) showSuccess(); }, 3000);
                db.collection("diem_tieng_viet_lop5").add(data).then(() => { clearTimeout(dbTimeout); showSuccess(); }).catch(e => { console.error(e); clearTimeout(dbTimeout); showSuccess(); });
            }
            
                const data = {
                    studentName: document.getElementById('studentName').value,
                    studentClass: document.getElementById('studentClass').value || studentData.studentClass || studentData.className,
                    school: document.getElementById('schoolSelect').value === 'Khác' || document.getElementById('schoolSelect').value === 'other' ? document.getElementById('otherSchool').value : document.getElementById('schoolSelect').value,
                    lessonTitle: "Đường quê Đồng Tháp Mười",
                    score: score,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                let successShown = false;
                const showSuccess = () => {
                    if (successShown) return;
                    successShown = true;
                    const modal = document.getElementById('successModal');
                    if(modal) {
                        modal.classList.add('active');
                        modal.classList.remove('hidden');
                    }
                    celebrate();
                    let timeLeft = 5;
                    const countdownEl = document.getElementById('countdown');
                    const timer = setInterval(() => {
                        timeLeft--;
                        if (countdownEl) countdownEl.innerText = timeLeft;
                        if (timeLeft <= 0) { clearInterval(timer); closeSuccessModal(); }
                    }, 1000);
                };
                const dbTimeout = setTimeout(() => { if (!successShown) showSuccess(); }, 3000);
                db.collection("diem_tieng_viet_lop5").add(data).then(() => { clearTimeout(dbTimeout); showSuccess(); }).catch(e => { console.error(e); clearTimeout(dbTimeout); showSuccess(); });
            }
            p ${dur % 60}s`, submittedAt: firebase.firestore.FieldValue.serverTimestamp() });
                document.getElementById('successModal').classList.add('active');
            } catch (err) { alert("Lỗi khi gửi kết quả."); } finally { btn.disabled = false; btn.innerText = "NỘP KẾT QUẢ"; }
        }

        function closeSuccessModal() { document.getElementById('successModal').classList.remove('active'); restartQuiz(); switchTab('lesson'); }

        function openTeacherStats() { const p = prompt("PIN:"); if (p === 'dvn') { document.getElementById('statsModal').classList.add('active'); loadStats(); } else if (p) alert("Sai PIN"); }
        function closeModal() { document.getElementById('statsModal').classList.remove('active'); }

        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">Đang tải dữ liệu...</td></tr>';
            try {
                const snapshot = await db.collection("diem_tieng_viet_lop5").where("lessonTitle", "==", "Đường quê Đồng Tháp Mười").get();
                tbody.innerHTML = '';
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400">Chưa có dữ liệu học tập.</td></tr>';
                    return;
                }
                const results = [];
                snapshot.forEach(doc => results.push(doc.data()));
                results.sort((a, b) => (b.submittedAt?.seconds || 0) - (a.submittedAt?.seconds || 0));

                results.forEach((data, index) => {
                    const date = data.submittedAt ? data.submittedAt.toDate().toLocaleString('vi-VN') : '---';
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 transition-colors border-b border-gray-50 text-sm bg-white";
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-bold text-gray-400">${index + 1}</td>
                        <td class="px-6 py-4 font-bold text-gray-800">${data.studentName}</td>
                        <td class="px-6 py-4 text-gray-600">${data.studentClass || data.className}</td>
                        <td class="px-6 py-4 text-gray-600">${data.school}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full font-black ${data.score >= 80 ? 'bg-green-100 text-green-700' : data.score >= 50 ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}">${data.score}/100</span>
                        </td>
                        <td class="px-6 py-4 text-center text-gray-600 font-bold">${data.timeDisplay || '---'}</td>
                        <td class="px-6 py-4 text-right text-xs text-gray-400 font-bold">${date}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) { tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-red-500">Lỗi khi tải dữ liệu.</td></tr>'; }
        }

        function exportToExcel() {
            const table = document.querySelector("#statsModal table");
            const wb = XLSX.utils.table_to_book(table, { sheet: "Kết quả", raw: true, cellStyles: true });
            const ws = wb.Sheets["Kết quả"];
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                const cellRef = XLSX.utils.encode_cell({ r: R, c: 2 });
                if (ws[cellRef]) ws[cellRef].t = 's';
            }
            XLSX.writeFile(wb, "KetQua_DuongQueDongThapMuoi.xlsx");
        }
    </script>
    
<audio id="clapSound" src="https://www.soundjay.com/human/applause-01.mp3" preload="auto"></audio>
<script src="js/floating-menu.js"></script>
</body>

</html>
