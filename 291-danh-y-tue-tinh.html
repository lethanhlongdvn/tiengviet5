<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>291. Danh y Tu? Tinh - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- SheetJS for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --accent: #f59e0b;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        .hidden {
            display: none !important;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .serif-font {
            font-family: 'Merriweather', serif;
        }

        .bg-paper {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .tab-btn.active {
            color: var(--primary);
            background: white;
            box-shadow: inset 0 -3px 0 var(--primary);
        }

        .tab-content {
            display: none !important;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block !important;
        }

        #tab-quiz.active {
            display: flex !important;
        }

        /* Compact Quiz styles */
        #quiz-container {
            height: calc(100vh - 180px);
            /* Adjust based on header/footer */
            max-height: 600px;
        }

        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid #e2e8f0;
        }

        .option-btn:hover:not(:disabled) {
            transform: translateX(4px);
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .option-btn.selected {
            border-color: var(--primary);
            background: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Accordion Custom */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .accordion-open .accordion-content {
            max-height: 500px;
        }

        .accordion-open svg {
            transform: rotate(180deg);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .reading-content p {
            text-indent: 2rem;
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        /* Success Modal Styles */
        .success-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 200;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        .success-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .success-card {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .success-modal.active .success-card {
            transform: scale(1);
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <!-- Header -->
    <header class="sticky top-0 z-50 px-4 py-2">
        <nav class="container mx-auto glass-card rounded-xl px-5 py-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-4">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 shrink-0">
                    <span class="text-xl font-black">E</span>
                </div>
                <div class="flex flex-col md:flex-row md:items-center md:space-x-6">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl font-black text-blue-700">EduRobot</span>
                        <span
                            class="text-[11px] font-bold px-3 py-1 rounded-full bg-orange-500 text-white shadow-sm shadow-orange-200 tracking-wide whitespace-nowrap">TI?NG
                            VI?T 5</span>
                    </div>

                    <div class="flex items-center space-x-2 overflow-hidden">
                        <span
                            class="text-[11px] font-black uppercase tracking-widest text-gray-400 whitespace-nowrap">CH?
                            ÐI?M:</span>
                        <span
                            class="text-sm font-black uppercase tracking-wider text-blue-800 truncate max-w-[180px] md:max-w-none">TI?P
                            BU?C CHA ÔNG</span>
                    </div>
                </div>
            </div>
            <ul class="flex space-x-2 md:space-x-6 text-xs font-bold items-center relative">
                <!-- Home -->
                <li>
                    <a href="index.html"
                        class="flex items-center text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Trang ch?
                    </a>
                </li>

                <!-- Lessons Dropdown -->
                <li class="relative group">
                    <button id="top-menu-lesson-btn"
                        class="flex items-center text-gray-500 hover:text-blue-600 transition-colors focus:outline-none py-2">
                        Bài h?c
                        <svg class="w-4 h-4 ml-1 transition-transform duration-200" id="top-menu-chevron" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <!-- Dropdown Content (Hidden by default) -->
                    <div id="top-menu-lessons-dropdown"
                        class="absolute top-full right-[-100px] md:right-auto md:left-1/2 md:-translate-x-1/2 mt-4 w-[320px] bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 hidden max-h-[70vh] overflow-y-auto z-[60] p-2">
                        <!-- Content rendered by floating-menu.js -->
                    </div>
                </li>

                <!-- Teacher -->
                <li>
                    <button onclick="openTeacherStats()"
                        class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Giáo viên
                    </button>
                </li>

                <!-- Contact -->
                <li>
                    <a href="#" class="text-gray-500 hover:text-blue-600 transition-colors py-2">
                        Liên h?
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-2">

        <!-- Tab & Audio Header -->
        <div class="glass-card mb-4 rounded-2xl overflow-hidden flex flex-col md:flex-row items-stretch shadow-lg">
            <div class="flex-1 flex bg-white/40">
                <button onclick="switchTab('lesson')" id="btn-lesson"
                    class="tab-btn active flex-1 py-4 text-center font-black text-base text-gray-400 transition-all border-r border-gray-100/50 uppercase tracking-wider">
                    1. Bài h?c
                </button>
                <button onclick="switchTab('quiz')" id="btn-quiz"
                    class="tab-btn flex-1 py-4 text-center font-black text-base text-gray-400 transition-all uppercase tracking-wider">
                    2. Luy?n t?p
                </button>
            </div>

            <div id="audio-container"
                class="p-2 md:px-4 flex items-center bg-blue-50/20 border-t md:border-t-0 md:border-l border-gray-100/50">
                <div
                    class="flex items-center space-x-3 bg-white/60 backdrop-blur-md rounded-xl p-1.5 pr-4 border border-white shadow-inner">
                    <button id="audioControl" onclick="toggleAudio()"
                        class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center text-white hover:scale-105 active:scale-95 transition-all shadow-md shadow-blue-200">
                        <svg id="playIcon" class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col">
                        <span
                            class="text-[9px] font-black text-blue-600 uppercase tracking-widest leading-none mb-0.5 whitespace-nowrap">Ð?C
                            M?U</span>
                        <span id="audioStatus"
                            class="text-[10px] text-gray-400 font-bold italic leading-none whitespace-nowrap">Ðang
                            d?ng...</span>
                    </div>
                </div>
                <audio id="lessonAudio">
                    <source src="am_thanh/danhytuetinh.mp3" type="audio/mpeg">
                </audio>
            </div>
        </div>

        <!-- TAB 1: BÀI H?C -->
        <div id="tab-lesson" class="tab-content active">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- C?t trái (70%) - Bài d?c -->
                <section class="w-full lg:w-[70%]">
                    <div class="glass-card rounded-[40px] p-6 md:p-10 shadow-2xl">
                        <div
                            class="bg-paper rounded-[32px] p-8 md:p-12 shadow-inner border border-white/50 relative overflow-hidden">
                            <!-- Trang trí góc -->
                            <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-100/30 rounded-full blur-3xl"></div>
                            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-amber-100/30 rounded-full blur-3xl">
                            </div>

                            <h1
                                class="text-4xl font-black mb-12 text-blue-950 text-center uppercase tracking-tighter leading-tight relative">
                                <span
                                    class="bg-blue-600 w-12 h-1.5 absolute -bottom-4 left-1/2 -translate-x-1/2 rounded-full"></span>
                                Danh y Tu? Tinh
                            </h1>

                            <div class="serif-font text-gray-800 text-lg leading-relaxed relative reading-content">
                                <div class="space-y-6">
                                    <img src="hinh_anh/2911-danhytuetinh.jpg" alt="Danh y Tu? Tinh 1"
                                        class="w-full h-auto rounded-3xl shadow-lg border border-white/50">
                                    <img src="hinh_anh/2912-danhytuetinh.jpg" alt="Danh y Tu? Tinh 2"
                                        class="w-full h-auto rounded-3xl shadow-lg border border-white/50">
                                </div>
                            </div>
                        </div>

                        <!-- N?i dung chính -->
                        <div
                            class="mt-8 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-[32px] p-8 text-white relative overflow-hidden shadow-xl transform hover:scale-[1.01] transition-transform">
                            <div
                                class="absolute right-0 top-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2 blur-2xl">
                            </div>
                            <div class="flex flex-col md:flex-row items-center gap-8 relative z-10">
                                <div
                                    class="bg-white/20 backdrop-blur-md p-6 rounded-2xl border border-white/30 shadow-lg shrink-0 text-center min-w-[160px]">
                                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-blue-100 mb-1">
                                        Thông di?p</p>
                                    <h3 class="text-2xl font-black uppercase tracking-tight">Ý NGHIA</h3>
                                </div>
                                <div class="flex-grow">
                                    <p class="text-lg font-bold leading-relaxed text-blue-50">
                                        Ca ng?i danh y Tu? Tinh – ngu?i dã nêu cao tinh th?n yêu nu?c, lòng t? hào dân
                                        t?c và có công l?n trong vi?c xây d?ng n?n y h?c c? truy?n Vi?t Nam v?i phuong
                                        châm "Nam du?c tr? Nam nhân" (Thu?c Nam ch?a b?nh cho ngu?i Nam).
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- C?t ph?i (30%) - Tìm hi?u bài -->
                <aside class="w-full lg:w-[30%]">
                    <div class="glass-card rounded-[40px] p-6 sticky top-28 shadow-xl border-amber-100/50">
                        <!-- ?nh minh h?a -->
                        <div class="mb-6 -mt-2">
                            <img src="hinh_anh/291-tue-tinh-digital.png" alt="Minh h?a"
                                class="w-full h-auto rounded-3xl object-contain drop-shadow-xl transform hover:scale-105 transition-transform duration-500">
                        </div>

                        <div class="flex items-center space-x-4 mb-8">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg shadow-amber-200">
                                <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                                    </path>
                                </svg>
                            </div>
                            <h2 class="text-2xl font-black text-gray-800 tracking-tight">Tìm hi?u bài</h2>
                        </div>

                        <div class="space-y-4">
                            <!-- Câu 1 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        1. Danh y Tu? Tinh d?n h?c trò lên núi d? làm gì?
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">G?i
                                                ý tr? l?i</span>
                                        </div>
                                        <p class="font-medium">Ông d?n h?c trò lên núi d? nói v? di?u mình ?p ? t? lâu:
                                            ý nguy?n dùng thu?c Nam ch?a b?nh cho ngu?i Nam.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 2 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        2. Tình hình d?t nu?c trong câu chuy?n ông k? nhu th? nào?
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">G?i
                                                ý tr? l?i</span>
                                        </div>
                                        <p class="font-medium">Ð?t nu?c dang b? gi?c ngo?i xâm nhòm ngó. Vua quan nhà
                                            Tr?n tích c?c chu?n b? vu khí, luong th?c và thu?c men d? gi? nu?c.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 3 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        3. Vì sao vua quan nhà Tr?n lo l?ng v? v?n d? thu?c men?
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">G?i
                                                ý tr? l?i</span>
                                        </div>
                                        <p class="font-medium">Vì vi?c v?n chuy?n thu?c t? Trung Qu?c sang dã b? c?m,
                                            n?u có chi?n tranh, binh si b? thuong s? không có thu?c ch?a.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Câu 4 -->
                            <div
                                class="accordion-item bg-white/50 rounded-[24px] border border-white shadow-sm transition-all hover:shadow-md overflow-hidden">
                                <button onclick="toggleAccordion(this)"
                                    class="w-full p-5 text-left flex justify-between items-center group">
                                    <span class="font-bold text-gray-700 group-hover:text-blue-600 transition-colors">
                                        4. Ði?u gì dã giúp quân dân nhà Tr?n chi?n th?ng k? thù?
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center group-hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transition-transform"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </button>
                                <div class="accordion-content">
                                    <div
                                        class="px-6 pb-6 text-gray-600 leading-relaxed border-t border-white/50 pt-4 bg-blue-50/30">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                                            <span
                                                class="text-[11px] font-black uppercase tracking-widest text-green-600">G?i
                                                ý tr? l?i</span>
                                        </div>
                                        <p class="font-medium">Ngoài tinh th?n chi?n d?u, cây c? nu?c Nam (thu?c Nam) dã
                                            góp ph?n làm cho quân d?i hùng m?nh, s?c kh?e d?o dai.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- TAB 2: LUY?N T?P -->
        <div id="tab-quiz" class="tab-content">
            <div
                class="max-w-4xl mx-auto glass-card rounded-[40px] shadow-2xl overflow-hidden flex flex-col min-h-[500px]">
                <!-- Registration -->
                <div id="quiz-registration" class="p-4 md:p-8 flex-grow flex flex-col justify-center overflow-auto">
                    <div class="text-center mb-6">
                        <div
                            class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white mb-4 shadow-xl shadow-blue-200 mx-auto transform -rotate-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-black text-gray-800 mb-1 tracking-tight">Ðang ký luy?n t?p</h2>
                        <p class="text-xs text-gray-400 font-bold uppercase tracking-widest">Danh y Tu? Tinh</p>
                    </div>

                    <form onsubmit="startQuiz(event)" class="w-full max-w-sm mx-auto space-y-4">
                        <div class="relative group">
                            <input type="text" id="studentName" required placeholder="H? và tên c?a em"
                                class="w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold placeholder:text-gray-300 shadow-sm">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <select id="studentClass" required
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="">Ch?n L?p</option>
                                <option value="5/1">5/1</option>
                                <option value="5/2">5/2</option>
                                <option value="5/3">5/3</option>
                                <option value="5/4">5/4</option>
                                <option value="5/5">5/5</option>
                            </select>

                            <select id="schoolSelect" required onchange="checkSchool()"
                                class="px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white focus:outline-none transition-all font-bold text-gray-700 shadow-sm appearance-none cursor-pointer">
                                <option value="Ti?u h?c Ð? Van N?i">TH Ð? Van N?i</option>
                                <option value="Khác">Tru?ng khác...</option>
                            </select>
                        </div>

                        <input type="text" id="otherSchool" placeholder="Tên tru?ng c?a em"
                            class="hidden w-full px-6 py-4 rounded-2xl bg-gray-50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all font-bold shadow-sm">

                        <button type="submit"
                            class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 text-base uppercase tracking-wider">
                            B?t d?u luy?n t?p
                        </button>
                    </form>
                </div>

                <!-- Quiz Engine - COMPACT VERSION -->
                <div id="quiz-container" class="hidden flex-grow flex flex-col">
                    <div class="bg-blue-600/5 px-6 py-4 flex justify-between items-center border-b border-blue-100">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center font-black mr-4 shadow-lg shadow-blue-200"
                                id="questionNum">1</div>
                            <div class="flex flex-col">
                                <span
                                    class="text-[10px] font-black text-blue-600 uppercase tracking-widest leading-none mb-1"
                                    id="progressText">CÂU TR?C NGHI?M: 1/5</span>
                                <span class="text-xs text-gray-400 font-bold leading-none">Danh y Tu? Tinh</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 flex-grow flex flex-col justify-center overflow-auto">
                        <h3 class="text-xl md:text-2xl font-black text-gray-800 mb-6 leading-tight transition-all"
                            id="questionText">N?i dung câu h?i?</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="optionsArea">
                            <!-- Options rendered by JS -->
                        </div>
                    </div>

                    <div class="px-6 py-4 border-t border-gray-50 flex justify-between items-center bg-gray-50/50">
                        <span class="text-xs font-bold text-gray-400 italic">* Ch?n dáp án dúng nh?t</span>
                        <button id="nextBtn" disabled
                            class="bg-blue-600 disabled:opacity-30 hover:bg-blue-700 text-white font-black py-3 px-10 rounded-2xl shadow-lg shadow-blue-100 transition-all active:scale-95 uppercase text-sm tracking-widest">
                            Câu ti?p theo
                        </button>
                    </div>
                </div>

                <!-- Results -->
                <div id="quiz-results"
                    class="hidden p-8 flex-grow flex flex-col items-center justify-center text-center">
                    <div class="relative w-40 h-40 mb-8">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="80" cy="80" r="74" stroke="currentColor" stroke-width="12" fill="transparent"
                                class="text-gray-100" />
                            <circle id="scoreCircle" cx="80" cy="80" r="74" stroke="url(#scoreGrad)" stroke-width="12"
                                fill="transparent" class="transition-all duration-1000 ease-out"
                                stroke-dasharray="0, 465" stroke-linecap="round" />
                            <defs>
                                <linearGradient id="scoreGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#3b82f6" />
                                    <stop offset="100%" stop-color="#818cf8" />
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-5xl font-black text-gray-800" id="scoreText">0</span>
                            <span class="text-[10px] text-gray-400 font-black uppercase tracking-[0.2em] mt-1">Ði?m
                                s?</span>
                        </div>
                    </div>

                    <h2 class="text-3xl font-black text-gray-800 mb-2" id="resultTitle">Hoàn thành bài t?p!</h2>
                    <p class="text-gray-500 mb-10 max-w-sm font-bold" id="resultMsg">Em dã n? l?c h?t mình r?i d?y!</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full max-w-md">
                        <button onclick="restartQuiz()"
                            class="bg-white hover:bg-gray-50 text-gray-700 font-black py-4 rounded-2xl border-2 border-gray-100 transition-all shadow-sm">LÀM
                            L?I</button>
                        <button onclick="submitResults(event)"
                            class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all">N?P
                            K?T QU?</button>
                    </div>
                </div>
            </div>
        </div>


    </main>

    <!-- Modal Teacher Stats -->
    <div id="statsModal" class="modal">
        <div
            class="bg-white rounded-[40px] w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl m-4 transform transition-all">
            <div class="p-8 border-b flex justify-between items-center bg-gray-50/50 backdrop-blur-xl">
                <div class="flex items-center space-x-4">
                    <div
                        class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-gray-800 tracking-tight">B?ng k?t qu? h?c t?p</h2>
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">Dành riêng cho giáo
                            viên</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="exportToExcel()"
                        class="bg-green-600 hover:bg-green-700 text-white font-black py-3 px-6 rounded-2xl text-sm flex items-center shadow-lg shadow-green-100 transition-all active:scale-95">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg> XU?T EXCEL
                    </button>
                    <button onclick="closeModal()"
                        class="w-12 h-12 flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-2xl transition-all">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow overflow-auto p-8 bg-gray-50/30">
                <table class="w-full">
                    <thead>
                        <tr
                            class="text-left text-gray-400 uppercase text-[10px] font-black tracking-[0.2em] border-b-2 border-gray-100 pb-4">
                            <th class="px-6 py-4">STT</th>
                            <th class="px-6 py-4">H? và Tên</th>
                            <th class="px-6 py-4">L?p</th>
                            <th class="px-6 py-4">Tru?ng</th>
                            <th class="px-6 py-4 text-center">Ði?m</th>
                            <th class="px-6 py-4 text-center">L?n</th>
                            <th class="px-6 py-4 text-center">Th?i gian</th>
                            <th class="px-6 py-4 text-right">Hoàn thành</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="divide-y divide-gray-100">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal">
        <div class="glass-card success-card rounded-[40px] p-10 max-w-sm w-full text-center shadow-3xl border-white/50">
            <div
                class="w-24 h-24 bg-gradient-to-br from-green-400 to-emerald-600 rounded-3xl flex items-center justify-center text-white mx-auto mb-8 shadow-xl shadow-green-100 transform rotate-6 scale-110">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h2 class="text-3xl font-black text-gray-800 mb-2 tracking-tight">N?p bài thành công!</h2>
            <p class="text-gray-500 mb-10 font-bold leading-relaxed">Chúc m?ng em dã hoàn thành th? thách ki?n th?c!</p>
            <button onclick="closeSuccessModal()"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all active:scale-95 uppercase tracking-widest text-sm">
                Tr? v? bài h?c
            </button>
        </div>
    </div>

        <footer class="py-5 px-4 mt-12 bg-white/30 backdrop-blur-md border-t border-white/50">
        <div class="container mx-auto text-center">
            <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em]">@ 2026 EduRobot - H? th?ng h?c
                t?p thông minh</p>
            <p class="text-xs font-bold text-blue-600 mt-2">Phát tri?n b?i Lê Thành Long</p>
        </div>
    </footer>

    <!-- Scripts organized for clarity -->
    <script src="js/floating-menu.js"></script>
    <script>
        /* UI LOGIC */
        function toggleAccordion(button) {
            const item = button.parentElement;
            const isOpen = item.classList.contains('accordion-open');
            document.querySelectorAll('.accordion-item').forEach(el => el.classList.remove('accordion-open'));
            if (!isOpen) item.classList.add('accordion-open');
        }

        const audioCode = 'danhytuetinh'; // Unique code for Firebase/Audio
        const audio = document.getElementById('lessonAudio');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const audioStatus = document.getElementById('audioStatus');

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                audioStatus.innerText = "Ðang phát...";
                audioStatus.classList.replace('text-gray-400', 'text-green-500');
            } else {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.innerText = "Ðang d?ng...";
                audioStatus.classList.replace('text-green-500', 'text-gray-400');
            }
        }

        audio.onended = () => {
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.innerText = "Ðang d?ng...";
            audioStatus.classList.replace('text-green-500', 'text-gray-400');
        };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('btn-' + tabId).classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        }

        /* QUIZ ENGINE */
        const allQuestions = [
            { q: "Danh y Tu? Tinh s?ng du?i tri?u d?i nào?", a: ["Nhà Lý", "Nhà Tr?n", "Nhà Lê", "Nhà Nguy?n"], c: 1 },
            { q: "Tu? Tinh dã d?n các h?c trò di dâu?", a: ["Lên núi Ba Vì", "Ra bi?n Ðông", "Lên núi Nam Tào, B?c Ð?u", "Vào r?ng Cúc Phuong"], c: 2 },
            { q: "Ði?u ông Tu? Tinh ?p ? b?y lâu nay là gì?", a: ["Tìm du?c kho báu trên núi", "Tr? thành m?t v? tu?ng quân", "Dùng thu?c Nam d? ch?a b?nh cho ngu?i Nam", "Vi?t m?t cu?n sách l?ch s?"], c: 2 },
            { q: "Khi gi?c ngo?i xâm de d?a, khó khan l?n nh?t v? y t? lúc b?y gi? là gì?", a: ["Thi?u bác si gi?i", "Vi?c v?n chuy?n thu?c men t? Trung Qu?c sang b? ngan c?m", "Không có noi khám ch?a b?nh", "Dân chúng không tin vào thu?c"], c: 1 },
            { q: "Ð? gi?i quy?t khó khan v? thu?c, các thái y d?i Tr?n dã làm gì?", a: ["Nh?p l?u thu?c t? nu?c ngoài", "To? di kh?p noi h?c cách ch?a b?nh b?ng cây c? dân gian", "C?u xin th?n linh ban thu?c", "Dùng bùa chú d? ch?a b?nh"], c: 1 },
            { q: "Núi Nam Tào, B?c Ð?u th?i b?y gi? du?c ví là gì?", a: ["Hai ng?n pháo dài", "Hai kho luong th?c", "Hai ng?n du?c son (núi thu?c)", "Hai ng?n dèn bi?n"], c: 2 },
            { q: "Theo l?i Tu? Tinh, cây c? nu?c Nam có vai trò gì trong cu?c kháng chi?n?", a: ["Làm th?c an cho ng?a chi?n", "Góp ph?n làm cho quân ta thêm hùng m?nh, can tru?ng", "Dùng d? ng?y trang", "Dùng làm vu khí d?c"], c: 1 },
            { q: "C?m t? \"Thu?c Nam\" trong bài du?c hi?u là gì?", a: ["Thu?c mua t? phuong Nam", "Thu?c du?c ch? bi?n t? cây c? có s?n ? nu?c Nam", "Thu?c do ngu?i tên Nam ch? t?o", "Thu?c ch? dành cho nam gi?i"], c: 1 },
            { q: "Thái d? c?a Tu? Tinh khi nói v? ng?n cây, s?i c? c?a d?t nu?c nhu th? nào?", a: ["Coi thu?ng", "Trân tr?ng và t? hào", "Th? o", "Lo l?ng"], c: 1 },
            { q: "Ý nguy?n c?a danh y Tu? Tinh là n?i gót ai?", a: ["Nh?ng ngu?i di tru?c trong vi?c tìm tòi cây thu?c Nam", "Các v? vua Trung Qu?c", "Nh?ng thuong nhân giàu có", "Nh?ng nhà thám hi?m"], c: 0 },
            { q: "Câu nói n?i ti?ng g?n li?n v?i tu tu?ng c?a Tu? Tinh là gì?", a: ["Luong y nhu t? m?u", "Nam du?c tr? Nam nhân", "Tiên h?c l?, h?u h?c van", "U?ng nu?c nh? ngu?n"], c: 1 },
            { q: "Vi?c dùng thu?c Nam ch?a b?nh th? hi?n tinh th?n gì?", a: ["Tinh th?n ti?t ki?m", "Tinh th?n bài ngo?i", "Tinh th?n t? l?c, t? cu?ng và lòng t? hào dân t?c", "Tinh th?n hi?u chi?n"], c: 2 },
            { q: "Các phuong thu?c Nam ch? y?u b?t ngu?n t? dâu?", a: ["T? sách v? nu?c ngoài", "T? kinh nghi?m trong dân gian", "T? trong cung dình", "T? các nu?c phuong Tây"], c: 1 },
            { q: "Ð?n nay, con du?ng c?a Tu? Tinh dã d?t du?c k?t qu? gì?", a: ["Không còn ai dùng thu?c Nam", "Ch? dùng d? xu?t kh?u", "Hàng nghìn phuong thu?c dân gian du?c t?ng h?p d? tr? b?nh c?u ngu?i", "Cây thu?c dã b? tuy?t ch?ng"], c: 2 },
            { q: "Bài d?c mu?n ca ng?i di?u gì ? danh y Tu? Tinh?", a: ["Tài nang võ thu?t", "T?m lòng yêu nu?c, thuong dân và t?m nhìn chi?n lu?c v? y h?c dân t?c", "S? giàu có và quy?n l?c", "Kh? nang leo núi gi?i"], c: 1 }
        ];

        let selectedQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let studentData = {};
        let startTime = null;

        function checkSchool() {
            const select = document.getElementById('schoolSelect');
            const other = document.getElementById('otherSchool');
            if (select.value === 'Khác') {
                other.classList.remove('hidden');
                other.required = true;
            } else {
                other.classList.add('hidden');
                other.required = false;
            }
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function startQuiz(e) {
            e.preventDefault();
            const schoolVal = document.getElementById('schoolSelect').value;
            studentData = {
                studentName: document.getElementById('studentName').value,
                studentClass: document.getElementById('studentClass').value,
                school: schoolVal === 'Khác' ? document.getElementById('otherSchool').value : schoolVal
            };
            // Pick 5 random questions
            const shuffled = shuffle([...allQuestions]);
            selectedQuestions = shuffled.slice(0, 5);
            currentIdx = 0;
            score = 0;
            startTime = new Date();
            document.getElementById('quiz-registration').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            const q = selectedQuestions[currentIdx];
            document.getElementById('questionNum').innerText = currentIdx + 1;
            document.getElementById('progressText').innerText = `CÂU TR?C NGHI?M: ${currentIdx + 1}/5`;
            document.getElementById('questionText').innerText = q.q;

            const area = document.getElementById('optionsArea');
            area.innerHTML = '';
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full p-4 text-left bg-white rounded-2xl font-bold flex items-center group shadow-sm";
                btn.innerHTML = `
                    <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center mr-4 group-hover:bg-blue-600 group-hover:text-white transition-all text-xs font-black shadow-inner">${String.fromCharCode(65 + i)}</div>
                    <span class="flex-1 text-sm md:text-base text-gray-700">${opt}</span>
                `;
                btn.onclick = () => selectOption(i, btn);
                area.appendChild(btn);
            });
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('nextBtn').innerText = currentIdx === 4 ? "Xem k?t qu?" : "Câu ti?p theo";
            document.getElementById('nextBtn').onclick = nextQuestion;
        }

        function selectOption(idx, btn) {
            document.querySelectorAll('#optionsArea button').forEach(b => {
                b.classList.remove('selected', 'border-blue-600', 'bg-blue-50/50');
                b.querySelector('div').classList.remove('bg-blue-600', 'text-white');
            });
            btn.classList.add('selected');
            btn.querySelector('div').classList.add('bg-blue-600', 'text-white');
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('nextBtn').dataset.selected = idx;
        }

        function nextQuestion() {
            const selected = parseInt(document.getElementById('nextBtn').dataset.selected);
            if (selected === selectedQuestions[currentIdx].c) score += 20;

            currentIdx++;
            if (currentIdx < 5) showQuestion();
            else showResults();
        }

        function showResults() {
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('quiz-results').classList.remove('hidden');

            document.getElementById('scoreText').innerText = score;
            const circle = document.getElementById('scoreCircle');
            const pct = (score / 100) * 465;
            circle.style.strokeDasharray = `${pct}, 465`;

            if (score >= 80) {
                document.getElementById('resultTitle').innerText = "Xu?t s?c quá!";
                document.getElementById('resultMsg').innerText = "Em dã hi?u r?t k? v? danh y Tu? Tinh d?y!";
            } else if (score >= 60) {
                document.getElementById('resultTitle').innerText = "R?t t?t!";
                document.getElementById('resultMsg').innerText = "Em làm bài khá t?t, c? g?ng phát huy nhé!";
            } else {
                document.getElementById('resultTitle').innerText = "C? g?ng lên!";
                document.getElementById('resultMsg').innerText = "Hãy d?c k? l?i bài và th? l?i l?n n?a nhé!";
            }
        }

        function restartQuiz() {
            document.getElementById('quiz-results').classList.add('hidden');
            document.getElementById('quiz-registration').classList.remove('hidden');
            document.getElementById('studentName').value = '';
            document.getElementById('otherSchool').classList.add('hidden');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            switchTab('lesson');
            restartQuiz();
        }

        /* FIREBASE & EXPORT LOGIC (PLACEHOLDER FOR STANDARD IMPLEMENTATION) */
        const lessonTitle = "Danh y Tu? Tinh";
        const firebaseConfig = {
            apiKey: "AIzaSyAs-...", // In production, these should be securely managed
            authDomain: "tri-thuc-viet-2a818.firebaseapp.com",
            projectId: "tri-thuc-viet-2a818",
            storageBucket: "tri-thuc-viet-2a818.appspot.com",
            messagingSenderId: "594411139403",
            appId: "1:594411139403:web:71e23730048e7eeb0c0576"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function submitResults(e) {
            e.preventDefault();
            const btn = e.target;
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg> ÐANG N?P...
            `;

            const endTime = new Date();
            const timeTaken = Math.floor((endTime - startTime) / 1000);
            const minutesTaken = Math.floor(timeTaken / 60);
            const secondsTaken = timeTaken % 60;
            const timeString = `${minutesTaken}ph ${secondsTaken}s`;

            try {
                await db.collection("quizResults").add({
                    ...studentData,
                    score,
                    lessonTitle,
                    timeString,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('successModal').classList.add('active');
            } catch (error) {
                console.error("L?i khi n?p bài:", error);
                alert("Có l?i x?y ra khi n?p bài. Em hãy th? l?i nhé!");
            } finally {
                btn.disabled = false;
                btn.innerText = "N?P K?T QU?";
            }
        }

        function openTeacherStats() {
            const password = prompt("Nh?p m?t kh?u giáo viên:");
            if (password === "123") {
                document.getElementById('statsModal').classList.add('active');
                loadStats();
            } else if (password !== null) {
                alert("M?t kh?u không dúng!");
            }
        }

        function closeModal() {
            document.getElementById('statsModal').classList.remove('active');
        }

        async function loadStats() {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10">Ðang t?i d? li?u...</td></tr>';
            try {
                const snapshot = await db.collection("quizResults")
                    .where("lessonTitle", "==", lessonTitle)
                    .orderBy("timestamp", "desc")
                    .get();

                tbody.innerHTML = '';
                let index = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString('vi-VN') : 'N/A';
                    const row = `
                        <tr class="hover:bg-gray-50/50 transition-colors">
                            <td class="px-6 py-4 text-xs font-bold text-gray-400">${index++}</td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-gray-800">${data.studentName}</div>
                            </td>
                            <td class="px-6 py-4 text-sm font-bold text-gray-600">${data.studentClass}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${data.school}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="px-3 py-1 rounded-full ${data.score >= 80 ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'} text-xs font-black">${data.score}</span>
                            </td>
                            <td class="px-6 py-4 text-center text-xs font-bold text-gray-400">1</td>
                            <td class="px-6 py-4 text-center text-xs font-bold text-gray-500">${data.timeString || 'N/A'}</td>
                            <td class="px-6 py-4 text-right text-xs font-bold text-gray-400">${date}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error("L?i t?i b?ng di?m:", error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-red-500">L?i khi t?i d? li?u.</td></tr>';
            }
        }

        function exportToExcel() {
            const table = document.querySelector("#statsModal table");
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "K?t qu?");
            XLSX.writeFile(wb, `KetQua_${lessonTitle.replace(/\s+/g, '_')}.xlsx`);
        }
    </script>
</body>

</html>