<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêang t·∫£i... - EduRobot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- SheetJS for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --primary-dark: #1e40af;
            --secondary: #7c3aed;
            --accent: #f59e0b;
            --success: #10b981;
            --error: #ef4444;
            --glass: rgba(255, 255, 255, 0.9);
            /* More opaque for better contrast */
            --glass-border: rgba(255, 255, 255, 0.6);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            /* Typography Variables */
            --font-size-base: 1.1rem;
            /* Default larger */
            --font-size-reading: 1.5rem;
            /* ~24px for TV */
            --font-size-ui: 1.1rem;
            --line-height-reading: 1.8;
        }

        /* Mobile Overrides */
        @media (max-width: 768px) {
            :root {
                --font-size-base: 1rem;
                --font-size-reading: 1.25rem;
                /* ~20px for Mobile */
                --font-size-ui: 1rem;
            }
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 25%, #fef3c7 75%, #fff7ed 100%);
            min-height: 100vh;
            color: #1f2937;
            font-size: var(--font-size-base);
            /* Applied globally */
        }

        .serif-font {
            font-family: 'Merriweather', serif;
            line-height: var(--line-height-reading);
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            line-height: 1.3;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
            border-radius: 24px;
            transition: var(--transition);
        }

        /* Tabs */
        .tab-btn {
            font-size: 1.1rem;
            /* Larger tabs */
        }

        .tab-btn.active {
            color: var(--primary);
            background: white;
            box-shadow: inset 0 -4px 0 var(--primary);
            /* Thicker indicator */
            position: relative;
        }

        .tab-content {
            display: none !important;
            animation: slideUp 0.5s ease-out;
        }

        .tab-content.active {
            display: block !important;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Exercise Styles - High Contrast & Large Touch Targets */
        .word {
            display: inline-block;
            padding: 8px 16px;
            /* Larger targets */
            margin: 4px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: var(--transition);
            font-weight: 700;
            font-size: var(--font-size-reading);
            /* Match reading size */
            position: relative;
            background-color: white;
            /* Card-like for words */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .word:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .word.selected {
            background-color: #fff7ed;
            border-color: var(--accent);
            color: #d97706;
            /* Darker orange for contrast */
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .word.is-correct {
            background: #dcfce7 !important;
            /* Light green bg */
            border-color: #22c55e !important;
            color: #15803d !important;
            /* Dark green text */
            box-shadow: none;
        }

        .word.is-correct::after {
            content: '‚úì';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #22c55e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .word.is-wrong {
            background: #fee2e2 !important;
            /* Light red bg */
            border-color: #ef4444 !important;
            color: #b91c1c !important;
            /* Dark red text */
        }

        .word.is-wrong::after {
            content: '‚úï';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slot {
            border-bottom: 3px dashed var(--accent);
            color: var(--accent);
            font-weight: 700;
            padding: 4px 12px;
            min-width: 80px;
            display: inline-block;
            font-size: var(--font-size-reading);
        }

        .slot.filled {
            border-bottom-style: solid;
            color: var(--success);
        }

        /* Buttons - Larger for touch */
        .btn {
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 800;
            transition: var(--transition);
            font-size: 1.1rem;
            min-height: 48px;
            /* Touch target size */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-outline {
            border: 3px solid var(--primary);
            color: var(--primary);
        }

        /* Thicker border */
        .btn-warning {
            background: var(--accent);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        /* Accordion Styles - High visibility */
        .accordion-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
        }

        .accordion-content>div {
            overflow: hidden;
            min-height: 0;
            font-size: var(--font-size-ui);
            /* Larger UI text */
        }

        .accordion-item.active .accordion-content {
            grid-template-rows: 1fr;
            opacity: 1;
            visibility: visible;
        }

        .accordion-item.active button svg {
            transform: rotate(180deg);
        }

        /* Reading Content Specifics */
        .reading-content p {
            text-indent: 3rem;
            margin-bottom: 1.5rem;
            text-align: justify;
            font-size: var(--font-size-reading);
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">
    <!-- Header -->
    <header class="sticky top-0 z-50 px-4 py-2">
        <nav class="container mx-auto glass-card rounded-xl px-5 py-2 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-4">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200 shrink-0">
                    <span class="text-xl font-black">E</span>
                </div>
                <div class="flex flex-col md:flex-row md:items-center md:space-x-6">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl font-black text-blue-700">EduRobot</span>
                        <span
                            class="text-[11px] font-bold px-3 py-1 rounded-full bg-orange-500 text-white shadow-sm shadow-orange-200 tracking-wide">TV5</span>
                    </div>
                    <div class="hidden md:flex items-center space-x-3 border-l-2 border-gray-100 pl-6">
                        <div class="flex items-center space-x-2">
                            <span class="text-[10px] font-black uppercase text-gray-400">CH·ª¶ ƒêI·ªÇM:</span>
                            <span class="text-[11px] font-black uppercase text-blue-800 lesson-theme">...</span>
                        </div>
                        <div class="h-4 w-px bg-gray-200"></div>
                        <div class="flex items-center space-x-2">
                            <span class="text-[10px] font-black uppercase text-gray-400 lesson-week">TU·∫¶N ...</span>
                            <span class="text-[11px] font-black uppercase text-blue-800 lesson-subject">B√ÄI: ...</span>
                        </div>
                    </div>
                </div>
            </div>
            <ul class="flex space-x-4 text-xs font-bold items-center">
                <li class="relative group">
                    <button id="top-menu-lesson-btn"
                        class="flex items-center space-x-1 text-gray-500 hover:text-blue-600 py-2 transition-colors">
                        <span>B√†i h·ªçc</span>
                        <svg id="top-menu-chevron" class="w-4 h-4 transition-transform duration-200" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="top-menu-lessons-dropdown"
                        class="absolute top-full right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-blue-100 hidden overflow-hidden max-h-[80vh] overflow-y-auto z-[60]">
                        <!-- JS renders content here -->
                    </div>
                </li>
                <li><a href="index.html" class="text-gray-500 hover:text-blue-600 py-2">Trang ch·ªß</a></li>
                <li><a href="teacher.html"
                        class="px-3 py-1.5 rounded-lg text-blue-600 bg-blue-50 hover:bg-blue-100 transition-colors">Gi√°o
                        vi√™n</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-2">
        <!-- Tab Navigation -->
        <div class="glass-card mb-4 rounded-2xl overflow-hidden flex flex-col md:flex-row items-stretch shadow-lg">
            <div class="flex-1 flex bg-white/40">
                <button onclick="switchTab('lesson')" id="btn-lesson"
                    class="tab-btn active flex-1 py-4 text-center font-black text-gray-400 uppercase tracking-wider">1.
                    B√†i h·ªçc & Luy·ªán t·∫≠p</button>
                <button onclick="switchTab('quiz')" id="btn-quiz"
                    class="tab-btn flex-1 py-4 text-center font-black text-gray-400 uppercase tracking-wider">2. Tr·∫Øc
                    nghi·ªám</button>
            </div>
            <!-- Audio Player -->
            <div id="audio-container" class="p-2 md:px-4 flex items-center bg-blue-50/20 border-l border-gray-100/50">
                <div
                    class="flex items-center space-x-3 bg-white/60 rounded-xl p-1.5 pr-4 border border-white shadow-inner">
                    <button onclick="toggleAudio()"
                        class="w-9 h-9 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center text-white shadow-md">
                        <svg id="playIcon" class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6 4l10 6-10 6V4z"></path>
                        </svg>
                        <svg id="pauseIcon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"></path>
                        </svg>
                    </button>
                    <div class="flex flex-col">
                        <span class="text-[9px] font-black text-blue-600 uppercase">ƒê·ªåC M·∫™U</span>
                        <span id="audioStatus" class="text-[10px] text-gray-400 font-bold italic">ƒêang d·ª´ng...</span>
                    </div>
                </div>
                <audio id="lessonAudio"></audio>
            </div>
        </div>

        <!-- TAB 1: DYNAMIC CONTENT -->
        <div id="tab-lesson" class="tab-content active">
            <div class="max-w-5xl mx-auto space-y-4" id="dynamic-content">
                <!-- Content will be loaded here via JS -->
                <div class="text-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-4 text-gray-500 font-bold">ƒêang t·∫£i b√†i h·ªçc...</p>
                </div>
            </div>
        </div>

        <!-- TAB 2: QUIZ PLACEHOLDER -->
        <div id="tab-quiz" class="tab-content">
            <div class="glass-card p-10 text-center">
                <h2 class="text-2xl font-black text-gray-400">Ch·ª©c nƒÉng Tr·∫Øc nghi·ªám ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</h2>
            </div>
        </div>
    </main>

    <!-- Student Info Modal for Quiz Submission -->
    <div id="studentInfoModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] hidden items-center justify-center p-4 transition-all duration-500 opacity-0 pointer-events-none">
        <div class="bg-white rounded-[24px] p-5 max-w-md w-full shadow-2xl relative border-4 border-blue-500 transform scale-95 transition-all duration-300"
            id="studentInfoContent">
            <div class="text-center mb-4">
                <div
                    class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl mx-auto mb-2 shadow-inner">
                    ‚úçÔ∏è</div>
                <h3 class="text-xl font-black text-gray-800 tracking-tight">Th√¥ng tin h·ªçc sinh</h3>
                <p class="text-gray-500 font-bold text-xs mt-1">Ch√∫c m·ª´ng em ho√†n th√†nh b√†i t·∫≠p!</p>
            </div>

            <div class="space-y-3">
                <!-- Name -->
                <div class="space-y-1">
                    <label class="block text-[10px] font-black text-blue-600 uppercase tracking-widest ml-1">H·ªç v√†
                        t√™n</label>
                    <input type="text" id="studentName" placeholder="Nh·∫≠p h·ªç t√™n..."
                        class="w-full px-4 py-2 rounded-xl border-2 border-blue-50 bg-blue-50/30 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all outline-none text-sm font-bold text-gray-800">
                </div>

                <!-- Class & School Row -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label
                            class="block text-[10px] font-black text-blue-600 uppercase tracking-widest ml-1">L·ªõp</label>
                        <select id="studentClass"
                            class="w-full px-4 py-2 rounded-xl border-2 border-blue-50 bg-blue-50/30 focus:border-blue-500 focus:bg-white transition-all outline-none font-bold text-sm text-gray-700 appearance-none cursor-pointer">
                            <option value="5/1">5/1</option>
                            <option value="5/2">5/2</option>
                            <option value="5/3">5/3</option>
                            <option value="5/4">5/4</option>
                            <option value="5/5">5/5</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label
                            class="block text-[10px] font-black text-blue-600 uppercase tracking-widest ml-1">Tr∆∞·ªùng</label>
                        <select id="schoolSelect" onchange="checkSchool()"
                            class="w-full px-4 py-2 rounded-xl border-2 border-blue-50 bg-blue-50/30 focus:border-blue-500 focus:bg-white transition-all outline-none font-bold text-sm text-gray-700 appearance-none cursor-pointer">
                            <option value="Ti·ªÉu h·ªçc ƒê·ªó VƒÉn N·∫°i">TH ƒê·ªó VƒÉn N·∫°i</option>
                            <option value="Kh√°c">Kh√°c...</option>
                        </select>
                    </div>
                </div>

                <!-- Other School Input -->
                <input type="text" id="otherSchool" placeholder="Nh·∫≠p t√™n tr∆∞·ªùng..."
                    class="hidden w-full px-4 py-2 rounded-xl border-2 border-orange-100 bg-orange-50/30 focus:border-orange-500 focus:bg-white focus:ring-2 focus:ring-orange-100 transition-all outline-none font-bold text-sm text-gray-700 animate-in slide-in-from-top-1 duration-300">
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="closeStudentModal()"
                    class="w-1/3 bg-gray-100 hover:bg-gray-200 text-gray-500 font-bold py-3 rounded-xl transition-all uppercase tracking-wider text-xs">
                    Quay l·∫°i
                </button>
                <button onclick="confirmSubmitQuiz()"
                    class="w-2/3 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black py-3 rounded-xl shadow-lg shadow-blue-200 transform hover:-translate-y-0.5 active:scale-95 transition-all uppercase tracking-widest text-xs">
                    üöÄ N·ªòP B√ÄI
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-6 px-4 mt-8 bg-white/40 backdrop-blur-md border-t border-white/50">
        <div class="container mx-auto text-center">
            <p class="text-xs font-black text-gray-400 uppercase tracking-[0.3em] mb-2">¬© 2026 EduRobot - H·ªá th·ªëng h·ªçc
                t·∫≠p th√¥ng minh</p>
            <p class="text-sm font-bold text-blue-600">Ph√°t tri·ªÉn b·ªüi L√™ Th√†nh Long</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="data/lessons.js?v=week29-fix-ids-2"></script> <!-- Load Data First -->
    <audio id="clapSound" src="https://www.soundjay.com/human/applause-01.mp3" preload="auto"></audio>

    <!-- Core Logic Scripts -->
    <script src="js/floating-menu.js?v=4"></script> <!-- UI Menu - Load early to ensure visibility -->
    <script src="js/firebase-logic.js"></script> <!-- Init Firebase First -->
    <script src="js/ai-grader.js?v=3"></script>
    <script src="js/interactive-exercises.js?v=12"></script> <!-- Custom Logic for LTVC -->
    <script src="js/lesson-loader.js"></script> <!-- Main logic depends on above -->

    <style>
        .bg-paper {
            background-color: #fdfbf7;
            background-image: radial-gradient(#e5e7eb 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        .reading-content p {
            text-indent: 2rem;
            margin-bottom: 1.5rem;
            text-align: left;
        }

        /* Checkbox/Accordion Logic */
        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }
    </style>
    <script>
        // UI Helpers
        function switchTab(id) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const btn = document.getElementById('btn-' + id);
            const tab = document.getElementById('tab-' + id);
            if (btn) btn.classList.add('active');
            if (tab) tab.classList.add('active');
        }

        // Accordion Helpers (Compatible with standard details/summary but supports custom too if needed)
        // Original file used custom divs. The new data uses <details> which is native.
        // But if we want the exact animation we might need specific styles or stick to native.
        // The migrated data in lessons.js uses <details>, so native behavior works. 
        // We just need to ensure the arrow rotates.

        const audio = document.getElementById('lessonAudio');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const audioStatus = document.getElementById('audioStatus');

        function toggleAudio() {
            if (!audio) return;
            if (audio.paused) {
                audio.play();
                if (playIcon) playIcon.classList.add('hidden');
                if (pauseIcon) pauseIcon.classList.remove('hidden');
                if (audioStatus) {
                    audioStatus.innerText = "ƒêang ph√°t...";
                    audioStatus.className = "text-[10px] text-green-500 font-bold italic";
                }
            } else {
                audio.pause();
                if (playIcon) playIcon.classList.remove('hidden');
                if (pauseIcon) pauseIcon.classList.add('hidden');
                if (audioStatus) {
                    audioStatus.innerText = "ƒêang d·ª´ng...";
                    audioStatus.className = "text-[10px] text-gray-400 font-bold italic";
                }
            }
        }

        // Helper to get Feedback Element safely
        function getFeedbackEl(id) {
            let el = document.getElementById('fb-' + id);
            if (!el) {
                // If missing, create it dynamically after the button's container
                const inputBtnRow = document.getElementById('ai-' + id)?.parentNode;
                if (inputBtnRow) {
                    el = document.createElement('div');
                    el.id = 'fb-' + id;
                    el.className = 'mt-3 hidden';
                    inputBtnRow.parentNode.appendChild(el);
                }
            }
            return el;
        }

        // Direct Fix for LTVC 222 AI Button
        window.checkLTVC222_Q2 = async function () {
            const inputId = '222-q2';
            const inputEl = document.getElementById('ai-' + inputId);
            const feedbackEl = getFeedbackEl(inputId);

            if (!inputEl) {
                console.error("L·ªói: Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu!");
                return;
            }

            const value = inputEl.value.trim();
            if (!value) {
                inputEl.classList.add('ring-4', 'ring-red-300');
                setTimeout(() => inputEl.classList.remove('ring-4', 'ring-red-300'), 500);
                inputEl.focus();
                return;
            }

            // Show Feedback immediately
            if (feedbackEl) {
                feedbackEl.classList.remove('hidden');
                feedbackEl.innerHTML = '<div class="flex items-center space-x-2 p-3 bg-blue-50 text-blue-800 rounded-xl animate-pulse"><span class="text-xl">ü§ñ</span> <b>Th·∫ßy ƒëang ƒë·ªçc b√†i c·ªßa em...</b></div>';
            }

            // Fallback AI implementation
            const doAskAI = window.askAI ? window.askAI : async (id, prefix, mode, persona, week) => {
                try {
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sentence: prefix + " " + value,
                            weekNumber: week,
                            persona: persona
                        })
                    });

                    if (!response.ok) throw new Error("Server Error: " + response.status);

                    const data = await response.json();

                    // Simple render for fallback
                    const grade = data.diem || data.grade || "?/10";
                    const nice = data.uu_diem || "B√†i l√†m t·ªët";
                    const improve = data.loi_sai || "C·∫ßn c·ªë g·∫Øng h∆°n";
                    const guide = data.huong_dan || "Ti·∫øp t·ª•c ph√°t huy nh√©!";

                    const html = `
                        <div class="mt-4 p-5 bg-white border border-green-200 rounded-2xl shadow-sm animate-in fade-in slide-in-from-bottom-2">
                             <div class="flex justify-between items-center mb-3">
                                <span class="text-xs font-black text-green-600 uppercase tracking-widest bg-green-50 px-2 py-1 rounded-lg">K·∫øt qu·∫£</span>
                                <span class="text-2xl font-black text-green-600">${grade}</span>
                            </div>
                            <div class="space-y-2 text-sm text-gray-700">
                                <p><strong>‚ú® ƒêi·ªÉm s√°ng:</strong> ${nice}</p>
                                <p><strong>üîß G√≥p √Ω:</strong> ${improve}</p>
                                <div class="mt-3 p-3 bg-blue-50 text-blue-800 rounded-xl font-bold italic">
                                    " ${guide} "
                                </div>
                            </div>
                        </div>
                    `;

                    if (feedbackEl) feedbackEl.innerHTML = html;

                } catch (e) {
                    console.error("Fallback AI Error", e);
                    throw e;
                }
            };

            try {
                // Modified prompt to enforce Grammar Teacher persona
                const prompt = "H√£y ƒë√≥ng vai Th·∫ßy Gi√°o Ng·ªØ Ph√°p. Ch·∫•m ƒëi·ªÉm c√¢u gh√©p sau c·ªßa h·ªçc sinh l·ªõp 5: '" + value + "'. Y√™u c·∫ßu: 1. C√¢u ph·∫£i c√≥ 2 v·∫ø c√¢u (M√°t... v√†... ho·∫∑c V√¨ M√°t... n√™n...). 2. D√πng t·ª´ n·ªëi (v√†, nh∆∞ng, th√¨, m√†, v√¨, n√™n...). KH√îNG y√™u c·∫ßu m·ªü b√†i/th√¢n b√†i. Ch·ªâ nh·∫≠n x√©t v·ªÅ ng·ªØ ph√°p v√† n·ªôi dung c√¢u.";
                await doAskAI(inputId, prompt, "single", "ltvc", 22);
            } catch (e) {
                console.error("Exec Error:", e);
                if (feedbackEl) feedbackEl.innerHTML = `<div class="p-3 bg-red-50 text-red-600 rounded-xl font-bold border border-red-100">‚ö†Ô∏è C√≥ l·ªói k·∫øt n·ªëi: ${e.message}. Em th·ª≠ l·∫°i sau gi√¢y l√°t nh√©!</div>`;
            }
        };
    </script>
</body>

</html>