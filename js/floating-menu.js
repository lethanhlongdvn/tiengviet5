// Curriculum Data - Reset
const curriculumData = {
    "H·ªçc k·ª≥ 1": [],
    "H·ªçc k·ª≥ 2": [
        {
            "theme": "Ch·ªß ƒëi·ªÉm 5: V·∫ª ƒë·∫πp cu·ªôc s·ªëng",
            "weeks": [
                {
                    "id": 19, "name": "Tu·∫ßn 19",
                    "lessons": [
                        {
                            "title": "B√†i 1: Ti·∫øng h√°t c·ªßa ng∆∞·ªùi ƒë√°",
                            "sections": [
                                { "title": "ƒê·ªçc: Ti·∫øng h√°t c·ªßa ng∆∞·ªùi ƒë√°", "url": "lesson_viewer.html?id=191-tieng-hat-nguoi-da" }
                            ]
                        },
                        {
                            "title": "B√†i 2: Kh√∫c h√°t ru nh·ªØng em b√© l·ªõn tr√™n l∆∞ng m·∫π",
                            "sections": [
                                { "title": "ƒê·ªçc: Kh√∫c h√°t ru...", "url": "lesson_viewer.html?id=192-khuc-hat-ru" }
                            ]
                        }
                    ]
                },
                {
                    "id": 20, "name": "Tu·∫ßn 20",
                    "lessons": [
                        {
                            "title": "B√†i 1: H·∫°t g·∫°o l√†ng ta",
                            "sections": [
                                { "title": "ƒê·ªçc: H·∫°t g·∫°o l√†ng ta", "url": "lesson_viewer.html?id=201-hat-gao-lang-ta" }
                            ]
                        },
                        {
                            "title": "B√†i 2: H·ªôp qu√† m√†u thi√™n thanh",
                            "sections": [
                                { "title": "ƒê·ªçc: H·ªôp qu√† m√†u thi√™n thanh", "url": "lesson_viewer.html?id=202-hop-qua-mau-thien-thanh" }
                            ]
                        }
                    ]
                },
                {
                    "id": 21, "name": "Tu·∫ßn 21",
                    "lessons": [
                        {
                            "title": "B√†i 1: Gi·ªè hoa th√°ng NƒÉm",
                            "sections": [
                                { "title": "ƒê·ªçc: Gi·ªè hoa th√°ng NƒÉm", "url": "lesson_viewer.html?id=211-gio-hoa-thang-nam" }
                            ]
                        },
                        {
                            "title": "B√†i 2: Th∆∞ c·ªßa b·ªë",
                            "sections": [
                                { "title": "ƒê·ªçc: Th∆∞ c·ªßa b·ªë", "url": "lesson_viewer.html?id=212-thu-cua-bo" }
                            ]
                        }
                    ]
                },
                {
                    "id": 22, "name": "Tu·∫ßn 22",
                    "lessons": [
                        {
                            "title": "B√†i 7: ƒêo√†n thuy·ªÅn ƒë√°nh c√°",
                            "sections": [
                                { "title": "ƒê·ªçc: ƒêo√†n thuy·ªÅn ƒë√°nh c√°", "url": "lesson_viewer.html?id=221-doan-thuyen-danh-ca" }
                            ]
                        },
                        {
                            "title": "B√†i 8: Khu r·ª´ng c·ªßa M√°t",
                            "sections": [
                                { "title": "ƒê·ªçc: Khu r·ª´ng c·ªßa M√°t", "url": "lesson_viewer.html?id=222-khu-rung-cua-mat" }
                            ]
                        }
                    ]
                },
                {
                    "id": 23, "name": "Tu·∫ßn 23",
                    "lessons": [
                        {
                            "title": "B√†i 9: H·ªôi th·ªïi c∆°m thi ·ªü ƒê·ªìng V√¢n",
                            "sections": [
                                { "title": "ƒê·ªçc: H·ªôi th·ªïi c∆°m thi ·ªü ƒê·ªìng V√¢n", "url": "lesson_viewer.html?id=231-hoi-thoi-com-thi-o-dong-van" }
                            ]
                        },
                        {
                            "title": "B√†i 10: Nh·ªØng b√∫p ch√® tr√™n c√¢y c·ªï th·ª•",
                            "sections": [
                                { "title": "ƒê·ªçc: Nh·ªØng b√∫p ch√® tr√™n c√¢y c·ªï th·ª•", "url": "lesson_viewer.html?id=232-nhung-bup-che-tren-cay-co-thu" }
                            ]
                        }
                    ]
                },
                {
                    "id": 24, "name": "Tu·∫ßn 24",
                    "lessons": [
                        {
                            "title": "B√†i 11: H∆∞∆°ng c·ªëm m√πa thu",
                            "sections": [
                                { "title": "ƒê·ªçc: H∆∞∆°ng c·ªëm m√πa thu", "url": "lesson_viewer.html?id=241-huong-com-mua-thu" }
                            ]
                        },
                        {
                            "title": "B√†i 12: V≈© ƒëi·ªáu tr√™n n·ªÅn th·ªï c·∫©m",
                            "sections": [
                                { "title": "ƒê·ªçc: V≈© ƒëi·ªáu tr√™n n·ªÅn th·ªï c·∫©m", "url": "lesson_viewer.html?id=242-vu-dieu-tren-nen-tho-cam" }
                            ]
                        }
                    ]
                },
                {
                    "id": 25, "name": "Tu·∫ßn 25",
                    "lessons": [
                        {
                            "title": "B√†i 13: ƒê√†n t'r∆∞ng, ti·∫øng ca ƒë·∫°i ng√†n",
                            "sections": [
                                { "title": "ƒê·ªçc: ƒê√†n t'r∆∞ng, ti·∫øng ca ƒë·∫°i ng√†n", "url": "lesson_viewer.html?id=251-dan-t'rung-tieng-ca-dai-ngan" }
                            ]
                        },
                        {
                            "title": "B√†i 14: ƒê∆∞·ªùng qu√™ ƒê·ªìng Th√°p M∆∞·ªùi",
                            "sections": [
                                { "title": "ƒê·ªçc: ƒê∆∞·ªùng qu√™ ƒê·ªìng Th√°p M∆∞·ªùi", "url": "lesson_viewer.html?id=252-duong-que-dong-thap-muoi" }
                            ]
                        }
                    ]
                },
                {
                    "id": 26, "name": "Tu·∫ßn 26",
                    "lessons": [
                        {
                            "title": "B√†i 1: Xu·ªìng ba l√° qu√™ t√¥i",
                            "sections": [
                                { "title": "ƒê·ªçc: Xu·ªìng ba l√° qu√™ t√¥i", "url": "lesson_viewer.html?id=261-xuong-ba-la-que-toi" }
                            ]
                        },
                        {
                            "title": "B√†i 2: V·ªÅ thƒÉm ƒê·∫•t M≈©i",
                            "sections": [
                                { "title": "ƒê·ªçc: V·ªÅ thƒÉm ƒê·∫•t M≈©i", "url": "lesson_viewer.html?id=262-ve-tham-dat-mui" }
                            ]
                        }
                    ]
                },
                {
                    "id": 27, "name": "Tu·∫ßn 27",
                    "lessons": [
                        {
                            "title": "√în t·∫≠p Gi·ªØa HK2",
                            "sections": [
                                { "title": "√în t·∫≠p Gi·ªØa HK2", "url": "on-tap-hk2-giua.html" }
                            ]
                        }
                    ]
                },
                {
                    "id": 28, "name": "Tu·∫ßn 28",
                    "lessons": [
                        {
                            "title": "B√†i 1: Ngh√¨n nƒÉm vƒÉn hi·∫øn",
                            "sections": [
                                { "title": "ƒê·ªçc: Ngh√¨n nƒÉm vƒÉn hi·∫øn", "url": "lesson_viewer.html?id=281-nghin-nam-van-hien" }
                            ]
                        },
                        {
                            "title": "B√†i 2: Ng∆∞·ªùi th·∫ßy c·ªßa mu√¥n ƒë·ªùi",
                            "sections": [
                                { "title": "ƒê·ªçc: Ng∆∞·ªùi th·∫ßy c·ªßa mu√¥n ƒë·ªùi", "url": "lesson_viewer.html?id=282-nguoi-thay-cua-muon-doi" }
                            ]
                        }
                    ]
                },
                {
                    "id": 29, "name": "Tu·∫ßn 29",
                    "lessons": [
                        {
                            "title": "B√†i 1: Danh y Tu·ªá Tƒ©nh",
                            "sections": [
                                { "title": "ƒê·ªçc: Danh y Tu·ªá Tƒ©nh", "url": "lesson_viewer.html?id=291-danh-y-tue-tinh" }
                            ]
                        },
                        {
                            "title": "B√†i 2: C·ª• ƒê·ªì Chi·ªÉu",
                            "sections": [
                                { "title": "ƒê·ªçc: C·ª• ƒê·ªì Chi·ªÉu", "url": "lesson_viewer.html?id=292-cu-do-chieu" }
                            ]
                        }
                    ]
                },
                {
                    "id": 30, "name": "Tu·∫ßn 30",
                    "lessons": [
                        {
                            "title": "B√†i 1: Tr·∫ßn ƒê·∫°i Nghƒ©a",
                            "sections": [
                                { "title": "ƒê·ªçc: Tr·∫ßn ƒê·∫°i Nghƒ©a", "url": "lesson_viewer.html?id=301-tran-dai-nghia" }
                            ]
                        },
                        {
                            "title": "B√†i 2: B·ªô ƒë·ªôi v·ªÅ l√†ng",
                            "sections": [
                                { "title": "ƒê·ªçc: B·ªô ƒë·ªôi v·ªÅ l√†ng", "url": "lesson_viewer.html?id=302-bo-doi-ve-lang" }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
};

// Inject CSS
const style = document.createElement('style');
style.textContent = `
    :root { --sidebar-width: 320px; }
    #floating-menu-btn {
        position: fixed; left: 0; top: 50%;
        transform: translateY(-50%) translateX(0);
        z-index: 10002; width: 45px; height: 90px;
        background: white; border-radius: 0 45px 45px 0;
        box-shadow: 4px 0 20px rgba(37, 99, 235, 0.15);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid #e5e7eb; border-left: none; user-select: none;
    }
    #floating-menu-btn:hover { background: #eff6ff; box-shadow: 4px 0 25px rgba(37, 99, 235, 0.25); }
    #floating-menu-btn.active { transform: translateY(-50%) translateX(var(--sidebar-width)); }
    #floating-menu-btn svg { color: #2563eb; stroke-width: 3; width: 24px; height: 24px; }
    #floating-sidebar {
        position: fixed; left: 0; top: 0;
        width: var(--sidebar-width); height: 100vh;
        background: rgba(255, 255, 255, 0.98);
        box-shadow: 4px 0 20px rgba(0,0,0,0.1);
        z-index: 10001; transform: translateX(-100%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column;
        border-right: 1px solid rgba(0,0,0,0.05);
        font-family: 'Nunito', sans-serif;
    }
    #floating-sidebar.active { transform: translateX(0); }
    .menu-header {
        padding: 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white; display: flex; align-items: center; justify-content: space-between;
        box-shadow: 0 2px 10px rgba(37, 99, 235, 0.2);
    }
    .close-btn {
        background: rgba(255,255,255,0.2); border: none; color: white;
        width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
        display: flex; align-items: center; justify-content: center; transition: background 0.2s;
    }
    .close-btn:hover { background: rgba(255,255,255,0.4); }
    .menu-content { flex: 1; overflow-y: auto; padding: 10px; }
    .menu-section-title { font-size: 11px; font-weight: 800; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.1em; padding: 15px 10px 5px; }
    .theme-item { margin-bottom: 5px; }
    .theme-btn { width: 100%; text-align: left; padding: 12px 15px; background: transparent; border: none; font-weight: 700; color: #1e293b; cursor: pointer; border-radius: 10px; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .theme-btn:hover { background: #f1f5f9; color: #2563eb; }
    .theme-btn.active { background: #eff6ff; color: #2563eb; }
    .theme-content { display: none; padding-left: 10px; animation: slideDown 0.3s ease-out; border-left: 1px solid #e2e8f0; margin-left: 15px; }
    .theme-content.open { display: block; }
    .week-item { margin: 2px 0; }
    .week-btn { width: 100%; text-align: left; padding: 8px 10px; font-size: 14px; font-weight: 600; color: #475569; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .week-btn:hover { background: #f8fafc; color: #0f172a; }
    .week-btn.active { color: #2563eb; background: #eff6ff; }
    .week-content { display: none; padding-left: 10px; margin-left: 5px; border-left: 1px solid #e2e8f0; }
    .week-content.open { display: block; }
    .lesson-item { margin: 2px 0; }
    .lesson-btn { width: 100%; text-align: left; padding: 6px 10px; font-size: 13px; font-weight: 500; color: #64748b; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .lesson-btn:hover { color: #2563eb; background: #f1f5f9; }
    .lesson-btn.active { color: #2563eb; font-weight: 600; }
    .lesson-content { display: none; padding-left: 10px; margin-left: 5px; border-left: 1px solid #e2e8f0; }
    .lesson-content.open { display: block; }
    .section-link { display: block; padding: 5px 10px; font-size: 12px; color: #64748b; text-decoration: none; transition: color 0.2s; border-radius: 4px; position: relative; }
    .section-link:hover { color: #2563eb; background: #f8fafc; }
    .section-link.current { color: #2563eb; font-weight: 700; background: #eff6ff; }
    .section-link.current::before { content: ''; position: absolute; left: -16px; top: 50%; transform: translateY(-50%); width: 6px; height: 6px; border-radius: 50%; background: #2563eb; }
    .menu-content::-webkit-scrollbar { width: 4px; }
    .menu-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .icon-chevron { transition: transform 0.2s; width: 14px; height: 14px; }
`;
document.head.appendChild(style);

// Inject HTML
const floatingBtn = document.createElement('button');
floatingBtn.id = 'floating-menu-btn';
floatingBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

const sidebar = document.createElement('div');
sidebar.id = 'floating-sidebar';
sidebar.innerHTML = `
    <div class="menu-header">
        <span class="font-bold text-lg">M·ª•c l·ª•c</span>
        <button class="close-btn" onclick="toggleMenu()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <div class="menu-content" id="menu-content"></div>
    <div class="p-4 border-t border-gray-100 bg-gray-50/50">
        <a href="teacher.html" class="flex items-center justify-center gap-2 w-full p-3 bg-white border-2 border-blue-100 rounded-xl text-blue-600 font-black text-xs uppercase tracking-widest hover:bg-blue-50 transition-all shadow-sm">
            <span>üë©‚Äçüè´</span> Trang Gi√°o vi√™n
        </a>
    </div>
`;

document.body.appendChild(floatingBtn);
document.body.appendChild(sidebar);

// Toggle Logic
function toggleMenu(forceState) {
    const sidebar = document.getElementById('floating-sidebar');
    const floatingBtn = document.getElementById('floating-menu-btn');
    if (!sidebar || !floatingBtn) return;
    const isActive = forceState !== undefined ? forceState : !sidebar.classList.contains('active');
    if (isActive) {
        sidebar.classList.add('active');
        floatingBtn.classList.add('active');
        floatingBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`;
    } else {
        sidebar.classList.remove('active');
        floatingBtn.classList.remove('active');
        floatingBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
    }
}
window.toggleMenu = toggleMenu;
floatingBtn.addEventListener('click', toggleMenu);

// Render Menu
const menuContent = document.getElementById('menu-content');
const createChevron = () => `<svg class="icon-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;

function renderCurriculumTo(container, autoExpand = false) {
    if (!container) return;
    container.innerHTML = '';
    Object.entries(curriculumData).forEach(([semesterName, themes]) => {
        const semTitle = document.createElement('div');
        semTitle.className = 'menu-section-title';
        semTitle.innerText = semesterName;
        container.appendChild(semTitle);

        themes.forEach((theme) => {
            const themeItem = document.createElement('div');
            themeItem.className = 'theme-item';
            const themeBtn = document.createElement('button');
            themeBtn.className = 'theme-btn';
            themeBtn.innerHTML = `<span>${theme.theme}</span>${createChevron()}`;
            const themeContent = document.createElement('div');
            themeContent.className = 'theme-content';

            theme.weeks.forEach(week => {
                const weekItem = document.createElement('div');
                weekItem.className = 'week-item';
                const weekBtn = document.createElement('button');
                weekBtn.className = 'week-btn';
                weekBtn.innerHTML = `<span>${week.name}</span>${createChevron()}`;
                const weekContent = document.createElement('div');
                weekContent.className = 'week-content';
                let isCurrentInWeek = false;

                if (week.lessons && week.lessons.length > 0) {
                    week.lessons.forEach(lesson => {
                        const lessonItem = document.createElement('div');
                        lessonItem.className = 'lesson-item';
                        const lessonBtn = document.createElement('button');
                        lessonBtn.className = 'lesson-btn';
                        lessonBtn.innerHTML = `<span>${lesson.title}</span>${createChevron()}`;
                        const lessonContentDiv = document.createElement('div');
                        lessonContentDiv.className = 'lesson-content';
                        let isCurrentInLesson = false;
                        const sections = lesson.sections || [{ title: "V√†o b√†i h·ªçc", url: lesson.url }];

                        sections.forEach(section => {
                            const sectionLink = document.createElement('a');
                            sectionLink.className = 'section-link';
                            sectionLink.href = section.url;
                            const titleParts = section.title.split(':');
                            if (titleParts.length > 1) {
                                sectionLink.innerHTML = `<strong>${titleParts[0]}:</strong> ${titleParts.slice(1).join(':')}`;
                            } else {
                                sectionLink.innerText = section.title;
                            }
                            const isCurrent = window.location.pathname.endsWith(section.url) || (section.url !== '#' && window.location.href.includes(section.url));
                            if (isCurrent) {
                                sectionLink.classList.add('current');
                                isCurrentInLesson = true;
                                isCurrentInWeek = true;
                            }
                            lessonContentDiv.appendChild(sectionLink);
                        });

                        lessonItem.appendChild(lessonBtn);
                        lessonItem.appendChild(lessonContentDiv);
                        weekContent.appendChild(lessonItem);

                        if (isCurrentInLesson) {
                            lessonContentDiv.classList.add('open');
                            lessonBtn.classList.add('active');
                            lessonBtn.querySelector('svg').style.transform = 'rotate(180deg)';
                        }
                        lessonBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const isOpen = lessonContentDiv.classList.contains('open');
                            lessonContentDiv.classList.toggle('open');
                            lessonBtn.classList.toggle('active');
                            lessonBtn.querySelector('svg').style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
                        });
                    });
                } else {
                    weekContent.innerHTML = `<div class="lesson-link italic text-xs">ƒêang c·∫≠p nh·∫≠t...</div>`;
                }

                weekItem.appendChild(weekBtn);
                weekItem.appendChild(weekContent);
                themeContent.appendChild(weekItem);

                if (isCurrentInWeek) {
                    weekContent.classList.add('open');
                    weekBtn.classList.add('active');
                    weekBtn.querySelector('svg').style.transform = 'rotate(180deg)';
                }
                weekBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = weekContent.classList.contains('open');
                    weekContent.classList.toggle('open');
                    weekBtn.classList.toggle('active');
                    weekBtn.querySelector('svg').style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
                });
            });

            themeItem.appendChild(themeBtn);
            themeItem.appendChild(themeContent);
            container.appendChild(themeItem);

            if (themeContent.querySelector('.week-content.open')) {
                themeContent.classList.add('open');
                themeBtn.classList.add('active');
                themeBtn.querySelector('svg').style.transform = 'rotate(180deg)';
                if (autoExpand) toggleMenu(true);
            }
            themeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = themeContent.classList.contains('open');
                themeContent.classList.toggle('open');
                themeBtn.classList.toggle('active');
                themeBtn.querySelector('svg').style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
            });
        });
    });
}

renderCurriculumTo(menuContent, false);

const topMenuDropdown = document.getElementById('top-menu-lessons-dropdown');
if (topMenuDropdown) {
    renderCurriculumTo(topMenuDropdown, false);
    const topMenuBtn = document.getElementById('top-menu-lesson-btn');
    const topMenuChevron = document.getElementById('top-menu-chevron');
    if (topMenuBtn) {
        topMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = topMenuDropdown.classList.contains('hidden');
            if (isHidden) {
                topMenuDropdown.classList.remove('hidden');
                if (topMenuChevron) topMenuChevron.style.transform = 'rotate(180deg)';
            } else {
                topMenuDropdown.classList.add('hidden');
                if (topMenuChevron) topMenuChevron.style.transform = 'rotate(0deg)';
            }
        });
    }
}

document.addEventListener('click', (e) => {
    if (sidebar && !sidebar.contains(e.target) && !floatingBtn.contains(e.target) && sidebar.classList.contains('active')) {
        toggleMenu();
    }
    const topMenuDropdown = document.getElementById('top-menu-lessons-dropdown');
    const topMenuBtn = document.getElementById('top-menu-lesson-btn');
    const topMenuChevron = document.getElementById('top-menu-chevron');
    if (topMenuDropdown && topMenuBtn && !topMenuDropdown.contains(e.target) && !topMenuBtn.contains(e.target) && !topMenuDropdown.classList.contains('hidden')) {
        topMenuDropdown.classList.add('hidden');
        if (topMenuChevron) topMenuChevron.style.transform = 'rotate(0deg)';
    }
});
