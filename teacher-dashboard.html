<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng ƒëi·ªÅu khi·ªÉn Gi√°o vi√™n - EduRobot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: #f8fafc;
        }

        .dashboard-card {
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <!-- Login Screen -->
    <div id="login-screen"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-md z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] p-10 max-w-md w-full shadow-2xl text-center">
            <div class="w-20 h-20 bg-blue-100 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-6">üë©‚Äçüè´
            </div>
            <h2 class="text-3xl font-black text-gray-800 mb-2">Gi√°o vi√™n</h2>
            <p class="text-gray-500 mb-8 font-bold text-sm uppercase tracking-widest">ƒêƒÉng nh·∫≠p b√°o c√°o</p>

            <div class="space-y-4">
                <input type="password" id="teacher-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u..."
                    class="w-full px-6 py-4 rounded-2xl border-2 border-gray-100 focus:border-blue-500 transition-all outline-none font-bold text-center text-xl tracking-widest">
                <button onclick="checkLogin()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-2xl shadow-xl shadow-blue-200 transition-all transform active:scale-95 uppercase tracking-widest">
                    V√†o h·ªá th·ªëng
                </button>
            </div>
            <a href="index.html"
                class="inline-block mt-8 text-sm font-bold text-gray-400 hover:text-blue-600 transition-colors uppercase tracking-widest">Quay
                l·∫°i trang ch·ªß</a>
        </div>
    </div>

    <div id="dashboard" class="max-w-6xl mx-auto hidden">
        <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-3xl shadow-sm border border-blue-50">
            <div class="flex items-center space-x-4">
                <div
                    class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white text-2xl font-black shadow-lg">
                    T</div>
                <div>
                    <h1 class="text-2xl font-black text-gray-800">Qu·∫£n l√Ω L·ªõp h·ªçc</h1>
                    <p class="text-gray-400 font-bold text-xs uppercase tracking-widest leading-none mt-1">H·ªá th·ªëng ch·∫•m
                        b√†i EduRobot</p>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="teacher.html"
                    class="bg-indigo-50 text-indigo-600 font-black px-4 py-2 rounded-xl hover:bg-indigo-100 transition-colors flex items-center gap-2">
                    <span>üìù</span> Qu·∫£n L√Ω Tr·∫Øc Nghi·ªám
                </a>
                <button onclick="exportToExcel()"
                    class="bg-green-50 text-green-600 font-black px-4 py-2 rounded-xl hover:bg-green-100 transition-colors flex items-center gap-2">
                    <span>üìä</span> XU·∫§T EXCEL
                </button>
                <button onclick="location.reload()"
                    class="bg-blue-50 text-blue-600 font-bold px-4 py-2 rounded-xl hover:bg-blue-100 transition-colors">L√†m
                    m·ªõi</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Sidebar: Stats -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-6 rounded-[32px] text-white shadow-xl">
                    <h2 class="text-xl font-black mb-4">T·ªïng quan</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center border-b border-white/20 pb-3">
                            <span class="font-bold">B√†i ch∆∞a ch·∫•m:</span>
                            <span id="stat-pending" class="text-2xl font-black text-yellow-300">0</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-white/20 pb-3">
                            <span class="font-bold">D·ª± √°n s√°ng t·∫°o:</span>
                            <span id="stat-projects" class="text-2xl font-black text-green-300">0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-[32px] border border-gray-100 shadow-sm">
                    <h3 class="font-black text-gray-800 mb-4 uppercase text-xs tracking-widest">H∆∞·ªõng d·∫´n nhanh</h3>
                    <ul class="text-sm font-bold text-gray-500 space-y-3">
                        <li class="flex items-start gap-2">
                            <span class="text-blue-500">1.</span> Xem n·ªôi dung b√†i vi·∫øt/d·ª± √°n c·ªßa h·ªçc sinh.
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-blue-500">2.</span> Nh·∫≠p ƒëi·ªÉm (0-10) v√† l·ªùi ph√™ c·ªßa Th·∫ßy/C√¥.
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-blue-500">3.</span> Nh·∫•n "L∆∞u & ƒêƒÉng" ƒë·ªÉ h·ªçc sinh th·∫•y k·∫øt qu·∫£.
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content: List -->
            <div class="lg:col-span-2 space-y-6">
                <div class="flex flex-col sm:flex-row gap-2 mb-4">
                    <div class="flex space-x-2 bg-white p-1 rounded-2xl shadow-sm border border-gray-100 w-fit">
                        <button id="tab-essays" onclick="switchView('essays_v2')"
                            class="px-6 py-2 rounded-xl font-black text-sm transition-all bg-blue-600 text-white">B√†i
                            Vi·∫øt
                            VƒÉn</button>
                        <button id="tab-projects" onclick="switchView('projects')"
                            class="px-6 py-2 rounded-xl font-black text-sm transition-all text-gray-400 hover:bg-gray-50">D·ª±
                            √Ån</button>
                    </div>

                    <div class="relative flex-1 max-w-xs">
                        <select id="lesson-filter" onchange="loadData()"
                            class="w-full pl-4 pr-10 py-2 rounded-xl border-2 border-blue-50 focus:border-blue-500 outline-none font-bold text-gray-600 appearance-none bg-white cursor-pointer transition-all text-sm shadow-sm">
                            <option value="">T·∫•t c·∫£ b√†i h·ªçc</option>
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-blue-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <h3 id="stats-title" class="text-xl font-black text-gray-800 uppercase tracking-tight mb-4 px-1">DANH
                    S√ÅCH B√ÄI L√ÄM</h3>

                <div id="loading" class="text-center py-20">
                    <div
                        class="animate-spin h-10 w-10 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-4">
                    </div>
                    <p class="font-black text-gray-400 uppercase tracking-widest text-xs">ƒêang t·∫£i d·ªØ li·ªáu h·ªçc sinh...
                    </p>
                </div>

                <div id="content-list" class="space-y-6">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Grading -->
    <div id="grade-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[40px] p-8 max-w-lg w-full shadow-2xl animate-in fade-in zoom-in duration-300">
            <h3 class="text-2xl font-black text-gray-800 mb-2">Ch·∫•m ƒëi·ªÉm & L·ªùi ph√™</h3>
            <p id="modal-student-info" class="text-blue-600 font-bold mb-6 italic"></p>

            <div class="space-y-6">
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">L·ªùi ph√™ c·ªßa Th·∫ßy/C√¥</label>
                    <textarea id="teacher-comment"
                        placeholder="V√≠ d·ª•: B√†i vi·∫øt r·∫•t sinh ƒë·ªông, c√≥ nhi·ªÅu h√¨nh ·∫£nh nh√¢n h√≥a..."
                        class="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-200 font-bold min-h-[120px]"></textarea>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">ƒêi·ªÉm s·ªë (0-10)</label>
                    <input type="number" id="teacher-grade" min="0" max="10" step="0.5"
                        class="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-200 font-black text-2xl text-blue-600">
                </div>
                <div class="flex gap-4">
                    <button onclick="closeModal()"
                        class="flex-1 py-4 font-black border-2 border-gray-100 rounded-2xl hover:bg-gray-50 transition-all text-gray-400">ƒê√ìNG</button>
                    <button onclick="saveGrade()"
                        class="flex-2 bg-blue-600 hover:bg-blue-700 text-white font-black py-4 px-8 rounded-2x2 shadow-lg shadow-blue-100 transition-all flex-1">L∆ØU
                        & ƒêƒÇNG</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication Logic
        function checkLogin() {
            const pass = document.getElementById('teacher-password').value;
            if (pass === "123456") {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                // Initial Load
                switchView('essays_v2');
            } else {
                alert("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! Th·∫ßy/C√¥ vui l√≤ng th·ª≠ l·∫°i.");
            }
        }

        function logout() {
            window.location.reload();
        }

        // Placeholder - Update with your credentials
        const firebaseConfig = {
            apiKey: "AIzaSyC6zlWn8BKYU7P6A2-PYq6IIWOzaqJWFhc",
            authDomain: "gamhoctap.firebaseapp.com",
            projectId: "gamhoctap",
            storageBucket: "gamhoctap.firebasestorage.app",
            messagingSenderId: "833329613932",
            appId: "1:833329613932:web:0d8574827bcfe50b535c49"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentMode = 'essays';
        let currentDocId = null;

        function switchView(mode) {
            currentMode = mode;
            document.getElementById('tab-essays').className = mode === 'essays' ? 'px-6 py-2 rounded-xl font-black text-sm transition-all bg-blue-600 text-white' : 'px-6 py-2 rounded-xl font-black text-sm transition-all text-gray-400 hover:bg-gray-50';
            document.getElementById('tab-projects').className = mode === 'projects' ? 'px-6 py-2 rounded-xl font-black text-sm transition-all bg-blue-600 text-white' : 'px-6 py-2 rounded-xl font-black text-sm transition-all text-gray-400 hover:bg-gray-50';
            loadData();
        }

        let allDataSnapshot = [];

        async function loadData() {
            const list = document.getElementById('content-list');
            const loading = document.getElementById('loading');
            const lessonFilter = document.getElementById('lesson-filter').value;
            list.innerHTML = "";
            loading.classList.remove('hidden');

            console.log("Loading data with mode:", currentMode);

            try {
                // SOLUTION: Fetch ALL data first, then Filter/Sort on Client-side.
                // This avoids the "Requires an Index" error from Firestore for complex compound queries.
                let queries = [];
                if (currentMode === 'essays_v2') {
                    // Fetch both new and old collections for backward compatibility
                    queries.push(db.collection('essays_v2').get());
                    queries.push(db.collection('essays').get());
                } else {
                    queries.push(db.collection(currentMode).get());
                }

                const snapshots = await Promise.all(queries);

                loading.classList.add('hidden');
                allDataSnapshot = [];

                let allDocs = [];
                let lessonTitles = new Set(); // Track titles for filter dropdown
                let pendingCount = 0;
                let projectCount = 0;

                snapshots.forEach(snapshot => {
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        d.id = doc.id;

                        // Collect Metadata
                        if (d.lessonTitle) lessonTitles.add(d.lessonTitle);
                        if (d.status === "Ch∆∞a ch·∫•m") pendingCount++;
                        if (currentMode === 'projects') projectCount++;

                        // Client-side Filter
                        if (lessonFilter && d.lessonTitle !== lessonFilter) return;

                        allDocs.push(d);
                    });
                });

                if (allDocs.length === 0) {
                    list.innerHTML = `<div class="text-center text-gray-400 font-bold col-span-2 py-8">Ch∆∞a c√≥ b√†i n√†o. Th·∫ßy/C√¥ h√£y nh·∫Øc nh·ªü h·ªçc sinh n·ªôp nh√©!</div>`;

                    // Still update stats even if empty list (for the counts)
                    document.getElementById('stat-pending').innerText = pendingCount;
                    document.getElementById('stat-projects').innerText = projectCount;
                    updateFilterDropdown(lessonTitles);
                    return;
                }

                document.getElementById('stats-title').innerText = lessonFilter ? `DANH S√ÅCH: ${lessonFilter.toUpperCase()} (${allDocs.length})` : `T·∫§T C·∫¢ B√ÄI H·ªåC (${allDocs.length})`;

                // Manual Client-side Sort (Newest first)
                const getTime = (t) => {
                    if (!t) return 0;
                    if (t.seconds) return t.seconds * 1000;
                    if (t.toDate) return t.toDate().getTime();
                    return new Date(t).getTime();
                };

                allDocs.sort((a, b) => getTime(b.timestamp) - getTime(a.timestamp));

                allDocs.forEach((data, index) => {
                    allDataSnapshot.push(data);

                    const card = document.createElement('div');
                    card.className = "dashboard-card bg-white p-6 rounded-[32px] shadow-sm border border-gray-100 space-y-4";

                    let mediaHtml = data.fileUrl ? `<div class="bg-gray-100 p-2 rounded-2xl"><img src="${data.fileUrl}" class="w-full max-h-[300px] object-contain rounded-xl shadow-sm"></div>` : "";

                    // Handle rawScores from LTVC Full
                    let scoresHtml = "";
                    if (data.rawScores) {
                        const rs = data.rawScores;
                        scoresHtml = `
                         <div class="grid grid-cols-4 gap-2 mt-2 text-[10px] font-bold text-gray-500 bg-blue-50 p-2 rounded-xl text-center">
                            <div>1a: ${rs.ex1a.score}</div>
                            <div>1b: ${rs.ex1b.score}</div>
                            <div>2: ${rs.ex2.score}</div>
                            <div>3: ${rs.ex3.score}</div>
                         </div>
                         `;
                    }

                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                             <div class="flex gap-4 items-center">
                                <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center font-black text-gray-400 text-xs">${index + 1}</div>
                                <div>
                                    <h4 class="text-lg font-black text-gray-800">${data.studentName}</h4>
                                    <span class="text-xs font-bold text-blue-500 uppercase tracking-widest">L·ªõp: ${data.studentClass}</span>
                                    <div class="text-[10px] text-gray-400 font-bold mt-1">${data.lessonTitle || "B√†i t·∫≠p"}</div>
                                </div>
                            </div>
                            <span class="px-3 py-1 rounded-lg text-[10px] font-black uppercase ${data.status === 'Ch∆∞a ch·∫•m' ? 'bg-yellow-100 text-yellow-600' : 'bg-green-100 text-green-600'}">
                                ${data.status}
                            </span>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-2xl text-sm font-medium text-gray-600 leading-relaxed max-h-40 overflow-y-auto italic">
                            "${data.content}"
                        </div>
                        ${mediaHtml}
                        ${scoresHtml}
                        <div class="flex justify-between items-center pt-2">
                             <div class="flex flex-col">
                                <span class="text-[10px] text-gray-400 font-bold">${data.timestamp ? new Date(data.timestamp.toDate ? data.timestamp.toDate() : data.timestamp).toLocaleString('vi-VN') : ''}</span>
                                <span class="text-[10px] text-indigo-500 font-bold">AI Ch·∫•m: ${data.aiGrade || 0}ƒë</span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="aiGradeSubmission('${data.id}', \`${data.content.replace(/`/g, '\\`').replace(/\n/g, ' ')}\`, '${data.lessonTitle || ''}')" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 px-4 py-2 rounded-xl font-bold text-sm transition-all flex items-center gap-2">
                                    <span>ü§ñ</span> AI Ch·∫•m
                                </button>
                                <button onclick="openGrading('${data.id}', '${data.studentName}', '${data.studentClass}')" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl font-bold text-sm transition-all shadow-md shadow-blue-200">
                                    Ch·∫•m b√†i
                                </button>
                            </div>
                        </div>
                        ${data.teacherFeedback ? `
                            <div class="mt-4 p-4 border-t-2 border-dashed border-blue-50 pt-4">
                                <p class="text-[10px] font-black text-blue-400 uppercase mb-1">L·ªùi ph√™ c≈©:</p>
                                <p class="text-xs font-bold text-gray-500 italic">"${data.teacherFeedback}" - <b>ƒêi·ªÉm: ${data.teacherGrade}</b></p>
                            </div>
                        ` : ''}
                    `;
                    list.appendChild(card);
                });

                document.getElementById('stat-pending').innerText = pendingCount;
                document.getElementById('stat-projects').innerText = projectCount;

                updateFilterDropdown(lessonTitles);

            } catch (error) {
                console.error("Error loading data:", error);
                // Show actual error to debug
                loading.innerHTML = `<p class="text-red-500 bg-red-50 p-4 rounded-xl">L·ªói: ${error.message}<br><small>Th·∫ßy/C√¥ vui l√≤ng nh·∫•n Ctrl+F5 ƒë·ªÉ t·∫£i l·∫°i.</small></p>`;
            }
        }

        function updateFilterDropdown(titles) {
            const filter = document.getElementById('lesson-filter');
            const currentVal = filter.value;
            // Only update if needed or empty to preserve selection context if re-run
            // Actually, simplest is to rebuild it preserving selection

            let html = '<option value="">T·∫•t c·∫£ b√†i h·ªçc</option>';
            Array.from(titles).sort().forEach(title => {
                html += `<option value="${title}" ${title === currentVal ? 'selected' : ''}>${title}</option>`;
            });
            filter.innerHTML = html;
        }

        function openGrading(id, name, cls) {
            currentDocId = id;
            document.getElementById('modal-student-info').innerText = `H·ªçc sinh: ${name} - L·ªõp: ${cls}`;
            document.getElementById('grade-modal').classList.remove('hidden');
            document.getElementById('grade-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('grade-modal').classList.add('hidden');
            document.getElementById('grade-modal').classList.remove('flex');
        }

        async function saveGrade() {
            const comment = document.getElementById('teacher-comment').value.trim();
            const grade = document.getElementById('teacher-grade').value.trim();

            if (!comment || !grade) {
                alert("Th·∫ßy/C√¥ h√£y nh·∫≠p ƒë·ªß ƒêi·ªÉm v√† L·ªùi ph√™ nh√©!");
                return;
            }

            try {
                await db.collection(currentMode).doc(currentDocId).update({
                    teacherFeedback: comment,
                    teacherGrade: grade,
                    status: "ƒê√£ ch·∫•m"
                });
                alert("ƒê√£ ƒëƒÉng k·∫øt qu·∫£ th√†nh c√¥ng cho h·ªçc sinh!");
                closeModal();
                loadData();
            } catch (error) {
                console.error("Error updating grade:", error);
                alert("L·ªói khi l∆∞u ƒëi·ªÉm. Th·∫ßy/C√¥ h√£y th·ª≠ l·∫°i nh√©!");
            }
        }

        async function exportToExcel() {
            try {
                const lessonFilter = document.getElementById('lesson-filter').value;
                const data = [];
                let index = 1;

                allDataSnapshot.forEach(row => {
                    // Safety check: ensure row is a data object with properties
                    if (!row || typeof row !== 'object') return;

                    let timeStr = "";
                    if (row.timestamp) {
                        try {
                            if (row.timestamp.toDate) timeStr = row.timestamp.toDate().toLocaleString('vi-VN');
                            else if (row.timestamp.seconds) timeStr = new Date(row.timestamp.seconds * 1000).toLocaleString('vi-VN');
                            else timeStr = new Date(row.timestamp).toLocaleString('vi-VN');
                        } catch (e) {
                            timeStr = "L·ªói th·ªùi gian";
                        }
                    }

                    data.push({
                        "STT": index++,
                        "H·ªç t√™n": row.studentName || "N/A",
                        "L·ªõp": row.studentClass || "N/A",
                        "Tr∆∞·ªùng": row.studentSchool || "",
                        "ƒêi·ªÉm AI": row.aiGrade || 0,
                        "N·ªôi dung b√†i l√†m": row.content || "",
                        "Nh·∫≠n x√©t c·ªßa AI": row.aiFeedback || "",
                        "Ph√¢n lo·∫°i": row.type || "essay",
                        "L·ªùi ph√™ gi√°o vi√™n": row.teacherFeedback || "",
                        "ƒêi·ªÉm gi√°o vi√™n": row.teacherGrade || "",
                        "Link ·∫£nh n·ªôp": row.fileUrl || "",
                        "Th·ªùi gian n·ªôp": timeStr
                    });
                });

                if (data.length === 0) {
                    alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
                    return;
                }

                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();

                // Determine sheet name based on mode
                let sheetName = "D·ªØ li·ªáu";
                if (currentMode.includes('essay')) sheetName = "B√†i L√†m VƒÉn";
                else if (currentMode.includes('project')) sheetName = "D·ª± √Ån S√°ng T·∫°o";

                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);

                // Set column widths
                const wscols = [
                    { wch: 5 }, { wch: 20 }, { wch: 10 }, { wch: 20 }, { wch: 25 }, { wch: 10 }, { wch: 50 }, { wch: 30 }, { wch: 30 }, { wch: 15 }, { wch: 30 }, { wch: 20 }
                ];
                worksheet['!cols'] = wscols;

                const dateStr = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
                const safeFilter = lessonFilter ? lessonFilter.replace(/[^a-zA-Z0-9]/g, '_') : 'Tat_Ca';
                let filePrefix = currentMode.includes('essay') ? "Bai_Van" : "Du_An";
                const fileName = `${filePrefix}_${safeFilter}_${dateStr}.xlsx`;

                XLSX.writeFile(workbook, fileName);
            } catch (error) {
                console.error("Export Error:", error);
                alert("L·ªói khi xu·∫•t file Excel: " + error.message);
            }
        }

        function switchView(mode) {
            currentMode = mode;
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.className = 'px-6 py-2 rounded-xl font-black text-sm transition-all text-gray-400 hover:bg-gray-50';
            });
            // Fix: active class for correct tab
            const tabId = mode === 'essays_v2' ? 'tab-essays' : (mode === 'essays' ? 'tab-old-essays' : 'tab-projects');
            const activeBtn = document.getElementById(tabId);
            if (activeBtn) activeBtn.className = 'px-6 py-2 rounded-xl font-black text-sm transition-all bg-blue-600 text-white';

            loadData();
        }

        async function aiGradeSubmission(docId, content, lessonTitle) {
            if (!confirm("B·∫°n c√≥ mu·ªën y√™u c·∫ßu AI ch·∫•m th·ª≠ b√†i n√†y kh√¥ng? (K·∫øt qu·∫£ s·∫Ω c·∫≠p nh·∫≠t v√†o c·ªôt 'AI Ch·∫•m')")) return;

            // T√¨m n√∫t b·∫•m ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i loading
            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "‚è≥ ƒêang ch·∫•m...";

            try {
                // X√°c ƒë·ªãnh tu·∫ßn h·ªçc t·ª´ t√™n b√†i h·ªçc ƒë·ªÉ l·∫•y ng·ªØ c·∫£nh (n·∫øu c√≥ th·ªÉ)
                let weekMatch = lessonTitle ? lessonTitle.match(/\d+/) : null;
                let weekNumber = weekMatch ? parseInt(weekMatch[0]) : 22;

                const response = await fetch('https://tiengviet5.netlify.app/.netlify/functions/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sentence: content,
                        weekNumber: weekNumber,
                        persona: 'tlv' // Creative Writing Teacher
                    })
                });

                if (!response.ok) throw new Error("L·ªói k·∫øt n·ªëi AI");

                const result = await response.json();
                const score = parseFloat(result.diem) || result.grade || 0;
                const feedback = result.response || result.content || "";

                // C·∫≠p nh·∫≠t Firestore
                await db.collection(currentMode).doc(docId).update({
                    aiGrade: score,
                    aiFeedback: feedback
                });

                alert(`AI ƒë√£ ch·∫•m xong! ƒêi·ªÉm d·ª± ki·∫øn: ${score}ƒë.\nNh·∫≠n x√©t: ${feedback.substring(0, 50)}...`);
                loadData(); // T·∫£i l·∫°i danh s√°ch
            } catch (error) {
                console.error("AI Grading Error:", error);
                alert("L·ªói khi g·ªçi AI ch·∫•m b√†i: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }
    </script>
</body>

</html>